var Z=Object.defineProperty;var J=s=>{throw TypeError(s)};var j=(s,e,t)=>e in s?Z(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var K=(s,e,t)=>j(s,typeof e!="symbol"?e+"":e,t),P=(s,e,t)=>e.has(s)||J("Cannot "+t);var g=(s,e,t)=>(P(s,e,"read from private field"),t?t.call(s):e.get(s)),S=(s,e,t)=>e.has(s)?J("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),h=(s,e,t,a)=>(P(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t);import{b as _,D as T,J as A,e as Q,w as ee,E as V,a7 as D,r as N,a0 as B,C as q,a6 as te,Q as H,s as se,L as ae}from"./index-D8eA2Snd.js";import{E as re}from"./Emitter-B4Dl_G-CoLDBUlE.js";import{T as ne}from"./TextRangeManager-EblcS8-D4YHq293.js";import{T as ie}from"./TextRangeUpdateSemantics-D8MqPO-S_bbHJO0.js";import{D as oe}from"./Delta-Bv7tGR-CQrdco4K.js";import{f as m}from"./NonEmptyArrayFns-oGa02u-CLyX5YlY.js";import{c as le,L as ue}from"./index-BUrsDwB9.js";import{d as ce}from"./defineFactory-En4T0P-BKA6DmWp.js";import"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import"./CircularBuffer-BES1B1-Nicfgaw3.js";var C;class ge{constructor(e){S(this,C);h(this,C,new ne({...e,initialTextRevision:e.textContent.revision,label:"TransformManager/TextRangeManager"})),this.pushTextChange({change:e.textContent.content,revision:e.textContent.revision})}pushTextChange({change:e,revision:t}){const a=g(this,C).pushTextChange({change:e,revision:t}),o=[];for(const r of a.affectedRanges)o.push(r.metadata),r.metadata.onEditComplete(e);return{getChangedTransforms:()=>_(a.getChangedRanges(),T(r=>r.metadata)),affectedTransforms:o}}add({context:e,alternatives:t,metadata:a,revision:o}){const r=g(this,C).add({range:e,revision:o,updateSemantics:ie.Resize,metadata:new fe({getTextRange:()=>r.ok?r.value:e,getRevision:()=>r.ok?r.value.revision:o,onDispose:()=>A(r),alternatives:t,metadata:a}),onBeforeEditOperation:(i,u)=>_(r,Q(c=>c.metadata.onBeforeEditOperation(i,u)))});return _(r,Q(i=>i.metadata))}[Symbol.dispose](){A(g(this,C))}}C=new WeakMap;var E,M,k,v,b;class fe{constructor(e){S(this,E);S(this,M);S(this,k);S(this,v);S(this,b,null);K(this,"metadata");h(this,E,e.onDispose),h(this,M,e.getTextRange),h(this,k,e.getRevision),h(this,v,e.alternatives),this.metadata=e.metadata}onBeforeEditOperation(e,t){g(this,b)!==null&&h(this,b,this.context.start)}onEditComplete(e){const t=g(this,b);t!==null&&(h(this,v,g(this,v).map(a=>a.compose(e.slice(t)))),h(this,b,null))}get context(){const e=g(this,M).call(this);return{start:e.start,end:e.end}}get alternatives(){return g(this,v)}get absoluteAlternatives(){return g(this,v).map(e=>new oe().retain(this.context.start).compose(e))}get revision(){return g(this,k).call(this)}[Symbol.dispose](){g(this,E).call(this)}}E=new WeakMap,M=new WeakMap,k=new WeakMap,v=new WeakMap,b=new WeakMap;var de=(s,e)=>(e=Symbol[s])?e:Symbol.for("Symbol."+s),L=s=>{throw TypeError(s)},I=(s,e,t)=>e.has(s)||L("Cannot "+t),n=(s,e,t)=>(I(s,e,"read from private field"),t?t.call(s):e.get(s)),x=(s,e,t)=>e.has(s)?L("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),$=(s,e,t,a)=>(I(s,e,"write to private field"),e.set(s,t),t),U=(s,e,t)=>(I(s,e,"access private method"),t),he=(s,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&L("Object expected");var a;a===void 0&&(a=e[de("dispose")]),typeof a!="function"&&L("Object not disposable"),s.push([t,a,e])}return e},pe=(s,e,t)=>{var a=typeof SuppressedError=="function"?SuppressedError:function(i,u,c,l){return l=Error(c),l.name="SuppressedError",l.error=i,l.suppressed=u,l},o=i=>e=t?new a(i,e,"An error was suppressed during disposal"):(t=!0,i),r=i=>{for(;i=s.pop();)try{var u=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(u).then(r,c=>(o(c),r()))}catch(c){o(c)}if(t)throw e};return r()},w,O,f,p,d,W,y,X,z;class me{constructor(e){x(this,y),x(this,w),x(this,O),x(this,f,new Map),x(this,p,new DisposableStack),x(this,d,n(this,p).use(new re)),x(this,W,new Map),$(this,w,ee.createLogger("SuggestionManager",e.id)),$(this,O,n(this,p).use(new ge({textContent:e.text.getValue()}))),n(this,p).use(e.onTextDidChange.subscribe(t=>{var a=[];try{const i=he(a,t.take()),{affectedTransforms:u}=n(this,O).pushTextChange(i.value);i.release();const c=_(new Set(u.map(l=>l.metadata)),T(l=>n(this,f).get(l)),V(D),T(l=>l.suggestion),m);c&&n(this,d).emit({affectedByTextChange:c})}catch(i){var o=i,r=!0}finally{pe(a,o,r)}})),n(this,p).defer(()=>{const t=m(_(n(this,f).values(),T(a=>a.suggestion)));t&&n(this,d).emit({removed:t})})}register(e){const t=n(this,W).get(e);if(t)return t;const a=new DisposableStack;return a.use(e.onSuggestionUpserted.subscribe(o=>{o.forEach(i=>U(this,y,X).call(this,i));const r=m(o);r&&n(this,d).emit({upserted:r})})),a.use(e.onSuggestionRemoved.subscribe(o=>{const r=m(o.map(i=>{var u;return(u=n(this,f).get(i))==null?void 0:u.suggestion}).filter(D));o.forEach(i=>U(this,y,z).call(this,i)),r&&n(this,d).emit({removed:r})})),n(this,W).set(e,a),n(this,p).use(a),a}apply(e,t){const a=n(this,f).get(e);return a?a.transforms.map(r=>r.absoluteAlternatives[t]).filter(D).length===0?N(new Se(e,t)):(n(this,d).emit({removed:[a.suggestion]}),N(new Error("Not implemented"))):N(new _e(e))}getCollection(e){const t=()=>_(n(this,f).values(),T(a=>a.suggestion),e===void 0?te:V(a=>a.kind===e));return{onChange:e===void 0?n(this,d):_(B.fromSubscribable(n(this,d)),B.map(ve(e)),B.filter(D),B.toSubscribable),getAll:t,getById:a=>{var o,r;return(r=(o=n(this,f).get(a))==null?void 0:o.suggestion)!=null?r:null},clear:()=>{const a=m(t());a&&(a.forEach(A),n(this,d).emit({removed:a}))}}}[Symbol.dispose](){n(this,p).dispose()}}w=new WeakMap;O=new WeakMap;f=new WeakMap;p=new WeakMap;d=new WeakMap;W=new WeakMap;y=new WeakSet;X=function(s){const e=s;U(this,y,z).call(this,e.id);const t=H([]);return t.ok?(n(this,f).set(e.id,{suggestion:s,transforms:t.value}),n(this,w).verbose("Upserted suggestion ".concat(e.id),e),se()):(n(this,w).error("Error upserting suggestion",t.error),n(this,w).verbose("Error upserting suggestion ".concat(e.id),t.error),t)};z=function(s){var e;const t=(e=n(this,f).get(s))==null?void 0:e.transforms;A(t!=null?t:[]),n(this,f).delete(s)};function ve(s){return e=>{var t,a,o,r,i,u,c,l,G;const F=Y=>Y.kind===s,R={upserted:(o=m((a=(t=e.upserted)==null?void 0:t.filter(F))!=null?a:[]))!=null?o:void 0,removed:(u=m((i=(r=e.removed)==null?void 0:r.filter(F))!=null?i:[]))!=null?u:void 0,affectedByTextChange:(G=m((l=(c=e.affectedByTextChange)==null?void 0:c.filter(F))!=null?l:[]))!=null?G:void 0};return R.upserted||R.removed||R.affectedByTextChange?R:null}}class _e extends q{constructor(e){super("Suggestion ".concat(e," was not found."))}}class Se extends q{constructor(e,t){super("Alternative index ".concat(t," for Suggestion ").concat(e," is out of bounds."))}}const xe=le(Symbol("SuggestionManager")),Oe=s=>_(H([s.getExecutionScope("document-session"),s.getFeature("document-session")]),ae(([e,t])=>e.register({token:xe,useFactory:ce(me,[t.provides.TextDocument])},{lifetime:ue.ContainerScoped})));export{xe as SuggestionManagerToken,Oe as activate};
//# sourceMappingURL=index-Qgq58gDv.js.map
