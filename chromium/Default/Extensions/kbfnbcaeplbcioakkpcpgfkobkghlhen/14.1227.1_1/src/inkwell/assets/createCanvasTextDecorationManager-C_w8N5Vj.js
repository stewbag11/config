var Qn=Object.defineProperty;var ji=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),Ut=i=>{throw TypeError(i)};var Kn=(i,e,t)=>e in i?Qn(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Lt=(i,e,t)=>Kn(i,typeof e!="symbol"?e+"":e,t),Mi=(i,e,t)=>e.has(i)||Ut("Cannot "+t);var o=(i,e,t)=>(Mi(i,e,"read from private field"),t?t.call(i):e.get(i)),_=(i,e,t)=>e.has(i)?Ut("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),R=(i,e,t,n)=>(Mi(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t),X=(i,e,t)=>(Mi(i,e,"access private method"),t);var en=(i,e,t,n)=>({set _(s){R(i,e,s,t)},get _(){return o(i,e,n)}});var _t=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Ut("Object expected");var n;t&&(n=e[ji("asyncDispose")]),n===void 0&&(n=e[ji("dispose")]),typeof n!="function"&&Ut("Object not disposable"),i.push([t,n,e])}else t&&i.push([t]);return e},xt=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(a,h,u,d){return d=Error(u),d.name="SuppressedError",d.error=a,d.suppressed=h,d},s=a=>e=t?new n(a,e,"An error was suppressed during disposal"):(t=!0,a),r=a=>{for(;a=i.pop();)try{var h=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(h).then(r,u=>(s(u),r()))}catch(u){s(u)}if(t)throw e};return r()};import{w as bi,b as v,a6 as di,a0 as E,M as L,S as qi,D as $,t as Je,a7 as ve,E as U,a1 as pn,Q as Zn,s as Qt,V as Ri,a8 as Jn,J as Fi,a9 as jn,m as Ii,aa as tn,H as es,x as nn,K as sn,U as mn,ab as We,ac as rn,$ as ts,y as an,ad as is,ae as ns}from"./index-D8eA2Snd.js";import{c as vn,m as wn,e as Ae,r as Ye,a as ss,b as rs}from"./index-DWAslvUv.js";import{c as as,a as os,i as At,e as hs,b as St,u as yi,d as ls,f as cs,g as ds}from"./RectFns-D2VKzQ-B5TdcvOe.js";import{E as Kt}from"./Emitter-B4Dl_G-CoLDBUlE.js";import{T as us}from"./TextRevisionSynchronizedQueue-B1Rn9G-BX2te2S9.js";import{i as on,w as hn,T as fs,a as Ai,t as ui,u as gs}from"./TextRangeManager-EblcS8-D4YHq293.js";import{m as _n,f as Et,a as ln}from"./NonEmptyArrayFns-oGa02u-CLyX5YlY.js";import{i as xn}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{i as ps}from"./GeometryRevisionFns-BWCMxs-DX1ABpMm.js";import"./Delta-Bv7tGR-CQrdco4K.js";import"./TextRangeUpdateSemantics-D8MqPO-S_bbHJO0.js";import"./CircularBuffer-BES1B1-Nicfgaw3.js";function ms(i,e,t,n,s){bn(i,e,t||0,n||i.length-1,s||vs)}function bn(i,e,t,n,s){for(;n>t;){if(n-t>600){var r=n-t+1,a=e-t+1,h=Math.log(r),u=.5*Math.exp(2*h/3),d=.5*Math.sqrt(h*u*(r-u)/r)*(a-r/2<0?-1:1),f=Math.max(t,Math.floor(e-a*u/r+d)),p=Math.min(n,Math.floor(e+(r-a)*u/r+d));bn(i,e,f,p,s)}var g=i[e],x=t,b=n;for(bt(i,t,e),s(i[n],g)>0&&bt(i,t,n);x<b;){for(bt(i,x,b),x++,b--;s(i[x],g)<0;)x++;for(;s(i[b],g)>0;)b--}s(i[t],g)===0?bt(i,t,b):(b++,bt(i,b,n)),b<=e&&(t=b+1),e<=b&&(n=b-1)}}function bt(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function vs(i,e){return i<e?-1:i>e?1:0}class yn{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!Ht(e,t))return n;const s=this.toBBox,r=[];for(;t;){for(let a=0;a<t.children.length;a++){const h=t.children[a],u=t.leaf?s(h):h;Ht(e,u)&&(t.leaf?n.push(h):Si(e,u)?this._all(h,n):r.push(h))}t=r.pop()}return n}collides(e){let t=this.data;if(!Ht(e,t))return!1;const n=[];for(;t;){for(let s=0;s<t.children.length;s++){const r=t.children[s],a=t.leaf?this.toBBox(r):r;if(Ht(e,a)){if(t.leaf||Si(e,a))return!0;n.push(r)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=tt([]),this}remove(e,t){if(!e)return this;let n=this.data;const s=this.toBBox(e),r=[],a=[];let h,u,d;for(;n||r.length;){if(n||(n=r.pop(),u=r[r.length-1],h=a.pop(),d=!0),n.leaf){const f=ws(e,n.children,t);if(f!==-1)return n.children.splice(f,1),r.push(n),this._condense(r),this}!d&&!n.leaf&&Si(n,s)?(r.push(n),a.push(h),h=0,u=n,n=n.children[0]):u?(h++,n=u.children[h],d=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,s){const r=n-t+1;let a=this._maxEntries,h;if(r<=a)return h=tt(e.slice(t,n+1)),et(h,this.toBBox),h;s||(s=Math.ceil(Math.log(r)/Math.log(a)),a=Math.ceil(r/Math.pow(a,s-1))),h=tt([]),h.leaf=!1,h.height=s;const u=Math.ceil(r/a),d=u*Math.ceil(Math.sqrt(a));cn(e,t,n,d,this.compareMinX);for(let f=t;f<=n;f+=d){const p=Math.min(f+d-1,n);cn(e,f,p,u,this.compareMinY);for(let g=f;g<=p;g+=u){const x=Math.min(g+u-1,p);h.children.push(this._build(e,g,x,s-1))}}return et(h,this.toBBox),h}_chooseSubtree(e,t,n,s){for(;s.push(t),!(t.leaf||s.length-1===n);){let r=1/0,a=1/0,h;for(let u=0;u<t.children.length;u++){const d=t.children[u],f=ki(d),p=bs(e,d)-f;p<a?(a=p,r=f<r?f:r,h=d):p===a&&f<r&&(r=f,h=d)}t=h||t.children[0]}return t}_insert(e,t,n){const s=n?e:this.toBBox(e),r=[],a=this._chooseSubtree(s,this.data,t,r);for(a.children.push(e),Mt(a,s);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(s,r,t)}_split(e,t){const n=e[t],s=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,s);const a=this._chooseSplitIndex(n,r,s),h=tt(n.children.splice(a,n.children.length-a));h.height=n.height,h.leaf=n.leaf,et(n,this.toBBox),et(h,this.toBBox),t?e[t-1].children.push(h):this._splitRoot(n,h)}_splitRoot(e,t){this.data=tt([e,t]),this.data.height=e.height+1,this.data.leaf=!1,et(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let s,r=1/0,a=1/0;for(let h=t;h<=n-t;h++){const u=yt(e,0,h,this.toBBox),d=yt(e,h,n,this.toBBox),f=ys(u,d),p=ki(u)+ki(d);f<r?(r=f,s=h,a=p<a?p:a):f===r&&p<a&&(a=p,s=h)}return s||n-t}_chooseSplitAxis(e,t,n){const s=e.leaf?this.compareMinX:_s,r=e.leaf?this.compareMinY:xs,a=this._allDistMargin(e,t,n,s),h=this._allDistMargin(e,t,n,r);a<h&&e.children.sort(s)}_allDistMargin(e,t,n,s){e.children.sort(s);const r=this.toBBox,a=yt(e,0,t,r),h=yt(e,n-t,n,r);let u=Nt(a)+Nt(h);for(let d=t;d<n-t;d++){const f=e.children[d];Mt(a,e.leaf?r(f):f),u+=Nt(a)}for(let d=n-t-1;d>=t;d--){const f=e.children[d];Mt(h,e.leaf?r(f):f),u+=Nt(h)}return u}_adjustParentBBoxes(e,t,n){for(let s=n;s>=0;s--)Mt(t[s],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():et(e[t],this.toBBox)}}function ws(i,e,t){if(!t)return e.indexOf(i);for(let n=0;n<e.length;n++)if(t(i,e[n]))return n;return-1}function et(i,e){yt(i,0,i.children.length,e,i)}function yt(i,e,t,n,s){s||(s=tt(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let r=e;r<t;r++){const a=i.children[r];Mt(s,i.leaf?n(a):a)}return s}function Mt(i,e){return i.minX=Math.min(i.minX,e.minX),i.minY=Math.min(i.minY,e.minY),i.maxX=Math.max(i.maxX,e.maxX),i.maxY=Math.max(i.maxY,e.maxY),i}function _s(i,e){return i.minX-e.minX}function xs(i,e){return i.minY-e.minY}function ki(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function Nt(i){return i.maxX-i.minX+(i.maxY-i.minY)}function bs(i,e){return(Math.max(e.maxX,i.maxX)-Math.min(e.minX,i.minX))*(Math.max(e.maxY,i.maxY)-Math.min(e.minY,i.minY))}function ys(i,e){const t=Math.max(i.minX,e.minX),n=Math.max(i.minY,e.minY),s=Math.min(i.maxX,e.maxX),r=Math.min(i.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,r-n)}function Si(i,e){return i.minX<=e.minX&&i.minY<=e.minY&&e.maxX<=i.maxX&&e.maxY<=i.maxY}function Ht(i,e){return e.minX<=i.maxX&&e.minY<=i.maxY&&e.maxX>=i.minX&&e.maxY>=i.minY}function tt(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function cn(i,e,t,n,s){const r=[e,t];for(;r.length;){if(t=r.pop(),e=r.pop(),t-e<=n)continue;const a=e+Math.ceil((t-e)/n/2)*n;ms(i,a,e,t,s),r.push(e,a,a,t)}}var Wt,Re,Gt,ct,Ge,Ne,ke,Se,De,j,Pt,Pe,dt,wi,ut,F,ft,He,N,Mn,Rn,kn,Sn,Zt;class Ms{constructor(e){_(this,N);_(this,Wt);_(this,Re,new DisposableStack);_(this,Gt);_(this,ct);_(this,Ge,new Map);_(this,Ne,new Map);_(this,ke,null);_(this,Se,new Map);_(this,De,new Set);_(this,j,new Rs);_(this,Pt);_(this,Pe);_(this,dt,o(this,Re).use(vn(()=>X(this,N,Mn).call(this),wn)));_(this,wi,0);_(this,ut,!0);_(this,F,null);_(this,ft,null);_(this,He,new Kt);Lt(this,"onPointerEvent",o(this,He));var n,s;R(this,Wt,bi.createLogger("InteractiveGeometryManager",e.label)),R(this,Pe,e.emitMetrics),R(this,ct,(n=e.pointerPositionThrottleTimeMs)!=null?n:1e3/30);const t=v(E.fromSubscribable(e.pointerMove),o(this,ct)===0?di:E.throttleTime(o(this,ct)));R(this,Pt,e.getViewport),o(this,Re).use(v(t,E.subscribe(r=>X(this,N,Rn).call(this,r)))),o(this,Re).use(e.pointerDown.subscribe(r=>X(this,N,kn).call(this,r))),o(this,Re).use(e.pointerUp.subscribe(r=>X(this,N,Sn).call(this,r))),R(this,ke,e.compareZIndex?null:new Map),R(this,Gt,(s=e.compareZIndex)!=null?s:(r,a)=>{var h,u,d,f;return((u=(h=o(this,ke))==null?void 0:h.get(r.rect))!=null?u:0)-((f=(d=o(this,ke))==null?void 0:d.get(a.rect))!=null?f:0)}),o(this,Re).defer(()=>this.clear())}async upsert(e,t){o(this,De).delete(e),o(this,Se).set(e,t),await o(this,dt).enqueue()}async remove(e){o(this,Se).delete(e),o(this,De).add(e),await o(this,dt).enqueue()}clear(){var e,t;o(this,j).clear(),o(this,Ge).clear(),o(this,Ne).clear(),(e=o(this,ke))==null||e.clear(),o(this,Se).clear(),o(this,De).clear(),o(this,dt).cancel(),(t=o(this,Pe))==null||t.call(this,{interactiveRectCount:0})}disablePointerEvents(){var e;R(this,ut,!1),(e=o(this,Pe))==null||e.call(this,{interactiveRectCount:0})}enablePointerEvents(){var e;R(this,ut,!0),(e=o(this,Pe))==null||e.call(this,{interactiveRectCount:o(this,j).size})}[Symbol.dispose](){o(this,Re).dispose()}}Wt=new WeakMap,Re=new WeakMap,Gt=new WeakMap,ct=new WeakMap,Ge=new WeakMap,Ne=new WeakMap,ke=new WeakMap,Se=new WeakMap,De=new WeakMap,j=new WeakMap,Pt=new WeakMap,Pe=new WeakMap,dt=new WeakMap,wi=new WeakMap,ut=new WeakMap,F=new WeakMap,ft=new WeakMap,He=new WeakMap,N=new WeakSet,Mn=function(){var s,r,a,h;var u=[];try{const e=v(o(this,De),qi(g=>{var x;return(x=o(this,Ge).get(g))!=null?x:[]}),L);const t=v(o(this,Se),$(([g,x])=>{var b;return[(b=o(this,Ge).get(g))!=null?b:[],x]}),L);if(e.length===0&&t.length===0)return;const n=_t(u,Je.startSpan("InteractiveGeometryManager.flushQueues()",{attributes:{removals:e.length,updates:t.length,treeSize:o(this,j).size}}));for(const g of e)o(this,j).remove(g),o(this,Ne).delete(g),(s=o(this,ke))==null||s.delete(g);for(const g of o(this,De))o(this,Ge).delete(g),((r=o(this,F))==null?void 0:r.geometry)===g&&R(this,F,null);for(const[g,x]of t)for(const b of g)o(this,j).remove(b);for(const[g,x]of o(this,Se)){for(const b of x)o(this,Ne).set(b,g),(a=o(this,ke))==null||a.set(b,en(this,wi)._++);o(this,Ge).set(g,x)}o(this,j).load(t.flatMap(([g,x])=>x));o(this,De).clear();o(this,Se).clear();(h=o(this,Pe))==null||h.call(this,{interactiveRectCount:o(this,j).size});o(this,Wt).verbose("queue flushed",{removals:e.length,updates:t.length,treeSize:o(this,j).size})}catch(d){var f=d,p=!0}finally{xt(u,f,p)}},Rn=function(e){var s;const t=X(this,N,Zt).call(this,e),n={};if(t){if(((s=o(this,F))==null?void 0:s.geometry)===t.geometry)return;o(this,F)!==null&&o(this,F).geometry!==t.geometry&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:o(this,F).rect,target:o(this,F).geometry}),n.pointerEnter={kind:"pointerEnter",position:e,currentTarget:t.rect,target:t.geometry},R(this,F,t)}else o(this,F)!==null&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:o(this,F).rect,target:o(this,F).geometry},R(this,F,null));Object.values(n).some(ve)&&o(this,He).emit(n)},kn=function(e){const t=X(this,N,Zt).call(this,e);t&&(R(this,ft,t.geometry),o(this,He).emit({pointerDown:{kind:"pointerDown",position:e,currentTarget:t.rect,target:t.geometry}}))},Sn=function(e){const t=X(this,N,Zt).call(this,e);if(!t)return;const n={pointerUp:{kind:"pointerUp",position:e,currentTarget:t.rect,target:t.geometry}};o(this,ft)===t.geometry&&(n.pointerClick={kind:"pointerClick",position:e,currentTarget:t.rect,target:t.geometry}),R(this,ft,null),Object.values(n).some(ve)&&o(this,He).emit(n)},Zt=function(e){return!as(o(this,Pt).call(this),e)||!o(this,ut)?null:v(o(this,j).search({minX:e.x,minY:e.y,maxX:e.x,maxY:e.y}),$(t=>v(o(this,Ne).get(t),n=>n?{rect:t,geometry:n}:null)),U(ve),L,t=>{var n;return(n=t.sort((s,r)=>o(this,Gt).call(this,s,r)).at(-1))!=null?n:null})};let Rs=class extends yn{constructor(){super(...arguments);Lt(this,"_rects",new Set)}toBBox(t){return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(t,n){return t.x-n.x}compareMinY(t,n){return t.y-n.y}load(t){return t.forEach(n=>this._rects.add(n)),super.load(t)}insert(t){return this._rects.add(t),super.insert(t)}remove(t,n){return this._rects.delete(t),super.remove(t,n)}clear(){var t;return(t=this._rects)==null||t.clear(),super.clear()}get size(){return this._rects.size}};function dn(i){return e=>({x:i(e.x),y:i(e.y),width:i(e.width),height:i(e.height)})}function ks(i,e=1.5,t=1.5){if(i.length===0)return[];if(i.length===1)return[i[0]];const n=[];let s=i[0];const r=i.length;for(let a=1;a<r;a++){const h=i[a],u=h.y+h.height,d=u<s.y,f=Ae(u,s.y)&&h.height>0&&s.height>0;if(d||f)continue;const p=Math.min(s.x,h.x),g=Math.min(s.y,h.y),x=Math.max(s.x+s.width,h.x+h.width),b=Math.max(s.y+s.height,u),ne=x-p,M=b-g,A=ne<=s.width+h.width+e,D=M<=s.height+h.height-t,W=Ae(M,s.height+h.height)&&(Ae(h.height,0)||Ae(s.height,0));Ae(h.width,s.width)&&Ae(h.height,s.height)&&Ae(h.x,s.x)&&Ae(h.y,s.y)||(A&&(D||W)?s=os({y:g,x:p,height:M,width:ne}):(n.push(s),s=h))}return n.push(s),n}function Rt(i){return v(i,Ss,ks)}function Ss(i){return[...i].sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)}function Ei(i,e){return i.text>e.text&&i.geometry>=e.geometry||i.geometry>e.geometry&&i.text>=e.text}function Bi(i,e){return i.text>=e.text&&i.geometry>=e.geometry}function Jt({text:i,geometry:e}){return"Revision({ text: ".concat(i,", geometry: ").concat(e," })")}var ee,Qe,_i,Xt,Ke,Te,Ze,pe,te,gt,Yt,oe,he,pt,$t,Ot,O,Dn,it,Tn,In,An;class Ds{constructor(e){_(this,O);_(this,ee,bi.createLogger("TextRangeGeometryManager"));_(this,Qe,new DisposableStack);_(this,_i,new pn);_(this,Xt,100);_(this,Ke);_(this,Te,new Map);_(this,Ze,new Map);_(this,pe,new Set);_(this,te,new Map);_(this,gt,new E.Subject);_(this,Yt);_(this,oe);_(this,he);_(this,pt,!0);_(this,$t);_(this,Ot);R(this,$t,e.getRects),R(this,Ot,e.getBoundingRects),R(this,Yt,e.emitMetrics),R(this,he,e.initialRevision),R(this,oe,on(e.initialVisibleTextRange)?e.initialVisibleTextRange:hn(e.initialVisibleTextRange,o(this,Xt))),R(this,Ke,o(this,Qe).use(new fs({initialTextRevision:e.initialRevision.text,label:"TextRangeGeometryManager/TextRangeManager"}))),o(this,Qe).use(v(o(this,gt),E.debounceTime(0),E.exhaustMapWithTrailing(()=>X(this,O,Tn).call(this)),E.subscribe())),o(this,Qe).defer(()=>{o(this,Te).clear(),o(this,Ze).clear(),o(this,pe).clear()})}get _revisionForTests(){throw new Error("Only available for accessing the revision in tests")}disableGeometryUpdate(){R(this,pt,!1)}enableGeometryUpdate(){R(this,pt,!0),o(this,gt).next()}add({id:e,geometryKind:t,metadata:n,revision:s,ranges:r,visible:a}){const h=Zn(v(r,_n(({id:f,range:p,metadata:g,updateSemantics:x})=>o(this,Ke).add({id:f!=null?f:o(this,_i).next(),range:p,metadata:g,revision:s,updateSemantics:x}))));if(!h.ok)return h;const u=h.value,d=new Ts({id:e,ranges:u,geometryKind:t,metadata:n,enqueueGetRects:f=>{const p=o(this,te).get(d);(!p||Ei(f,p.revision))&&X(this,O,it).call(this,[d],"enqueueGetRects",!0)},onDispose:()=>X(this,O,Dn).call(this,d)});return u.forEach(f=>o(this,Te).set(f,d)),o(this,Ze).set(d.id,d),a&&o(this,pe).add(d.id),Ai(o(this,oe),d.boundingRange)&&X(this,O,it).call(this,[d],"add"),Qt(d)}pushTextChange(e,t){var u=[];try{const n=_t(u,Je.startSpan("TextRangeGeometryManager.pushTextChange()",{attributes:{change:e,skipGeometryUpdate:t}}));R(this,he,{geometry:o(this,he).geometry,text:e.revision});const{getChangedRanges:s,affectedRanges:r}=o(this,Ke).pushTextChange(e);const a=v(r,$(g=>o(this,Te).get(g)),U(ve),Ri,L);const h=v(s(),$(g=>o(this,Te).get(g)),U(ve),Jn(g=>g.boundingRange.start<o(this,oe).end),Ri,Et);o(this,ee).verbose("pushTextChange",{change:e,affectedGroups:a.map(g=>g.id),onScreenChangedGroups:h==null?void 0:h.map(g=>g.id)});h&&!t&&X(this,O,it).call(this,h,"textChange");return{affected:a,visibleChanged:h!=null?h:[]}}catch(d){var f=d,p=!0}finally{xt(u,f,p)}}pushDocumentGeometryChange(e,t){var r=[];try{const n=_t(r,Je.startSpan("TextRangeGeometryManager.pushDocumentGeometryChange()",{attributes:{visibleTextRange:e,geometryRevision:t}}));R(this,he,{text:o(this,he).text,geometry:t});R(this,oe,on(e)?e:hn(e,o(this,Xt)));const s=v(o(this,Ke).getIntersecting(o(this,oe)),$(d=>o(this,Te).get(d)),U(ve),Ri,Et);o(this,ee).verbose("pushDocumentGeometryChange",{visibleTextRange:ui(o(this,oe)),onScreenGroups:s==null?void 0:s.map(d=>d.id)});o(this,te).clear();s&&X(this,O,it).call(this,s,"documentGeometryChange");return{visible:s!=null?s:[]}}catch(a){var h=a,u=!0}finally{xt(r,h,u)}}setVisibility(e,t){const n=new Set;for(const s of e)if(t){if(!o(this,pe).has(s)){o(this,pe).add(s);const r=o(this,Ze).get(s);r&&n.add(r)}}else o(this,pe).delete(s);n.size>0&&X(this,O,it).call(this,n,"visibilityChange")}[Symbol.dispose](){o(this,Qe).dispose()}}ee=new WeakMap,Qe=new WeakMap,_i=new WeakMap,Xt=new WeakMap,Ke=new WeakMap,Te=new WeakMap,Ze=new WeakMap,pe=new WeakMap,te=new WeakMap,gt=new WeakMap,Yt=new WeakMap,oe=new WeakMap,he=new WeakMap,pt=new WeakMap,$t=new WeakMap,Ot=new WeakMap,O=new WeakSet,Dn=function(e){e.ranges.forEach(t=>o(this,Te).delete(t)),o(this,Ze).delete(e.id),o(this,pe).delete(e.id),o(this,te).delete(e),Fi(e)},it=function(e,t,n){const s=L(e);o(this,ee).verbose("queueGeometryUpdateFor",{revision:Jt(o(this,he)),groups:s.map(r=>r.toString()),visibleTextRange:ui(o(this,oe)),reason:t});for(const r of s)o(this,te).set(r,{revision:{...o(this,he)},force:n});s.length>0&&o(this,gt).next()},Tn=async function(){var x,b,ne;var M=[];try{if(!o(this,pt))return;const e={...o(this,he)};const t=L(v(o(this,te),U(([m,{force:k}])=>k===!0||o(this,pe).has(m.id)&&Ai(o(this,oe),m.boundingRange))));if(t.length===0)return;const n=_t(M,Je.startSpan("TextRangeGeometryManager.#requestGeometryForGroups()",{attributes:{revision:e,groups:t.map(([m,k])=>({id:m.id,ranges:m.ranges.length,queuedRevision:k}))}}));const s=jn(t,([m])=>m.geometryKind==="singleBoundingBox"?"boundingBox":"rects");const r=(x=s.get("rects"))!=null?x:[];const a=(b=s.get("boundingBox"))!=null?b:[];const h=r.flatMap(([m])=>m.ranges);const u=a.flatMap(([m])=>m.ranges);o(this,ee).verbose("geometry request",{revision:Jt(e),groups:t.map(([m,k])=>({id:m.id,ranges:m.ranges.map(B=>({start:B.start,end:B.end})),queuedRevision:k}))});const d={rects:new Map,revision:e};const f={rects:new Map,revision:e};const[p,g]=await Promise.all([v(h,ln({nonEmpty:m=>X(this,O,In).call(this,m,d),empty:()=>Promise.resolve(d)})),v(u,ln({nonEmpty:m=>X(this,O,An).call(this,m,f),empty:()=>Promise.resolve(f)}))]);for(const[m]of r){const k=o(this,te).get(m);k&&Bi(p.revision,k.revision)&&o(this,te).delete(m)}for(const[m]of a){const k=o(this,te).get(m);k&&Bi(g.revision,k.revision)&&o(this,te).delete(m)}r.forEach(([m])=>m.resolveRects(m.ranges.map(k=>{var B;return(B=p.rects.get(k.id))!=null?B:[]}),p.revision));a.forEach(([m])=>m.resolveRects(m.ranges.map(k=>{var B;return[(B=g.rects.get(k.id))!=null?B:[]].flat()}),g.revision));(ne=o(this,Yt))==null||ne.call(this,{rangeCount:t.flatMap(([m])=>m.ranges).length,rectCount:Array.from(p.rects.values()).flat().length+g.rects.size});o(this,ee).verbose("geometry response",{revision:Jt(e),groups:t.map(([m])=>m.id),rectsAndRevisions:p,boundingBoxesAndRevisions:g})}catch(A){var D=A,W=!0}finally{xt(M,D,W)}},In=function(e,t){return v(tn(()=>v(o(this,$t).call(this,new Map(v(e,$(n=>[n.id,{start:n.start,end:n.end}])))),nn(sn(n=>o(this,ee).error("Unexpected error getting rects",n)))),{maxRetries:3,delayMs:()=>1e3}),Ii({success:di,failure:n=>(o(this,ee).error("Unexpected error getting rects - reached max retries, returning empty rects",n),t)}))},An=function(e,t){return v(tn(()=>v(o(this,Ot).call(this,new Map(v(e,$(n=>[n.id,{start:n.start,end:n.end}])))),nn(sn(n=>o(this,ee).error("Unexpected error getting bounding rects",n)))),{maxRetries:3,delayMs:()=>1e3}),Ii({success:di,failure:n=>(o(this,ee).error("Unexpected error getting bounding rects - reached max retries, returning empty rects",n),t)}))};var zt,qt,mt,Xe,xi,Ft,Vt,Ie;class Ts{constructor(e){_(this,zt,new DisposableStack);_(this,qt);_(this,mt);_(this,Xe);_(this,xi,new pn);_(this,Ft);_(this,Vt);_(this,Ie,new E.BehaviorSubject(null));Lt(this,"id");var t;this.id=(t=e.id)!=null?t:o(this,xi).next(),R(this,Xe,e.ranges),R(this,qt,e.metadata),R(this,mt,e.geometryKind),R(this,Vt,e.onDispose),R(this,Ft,e.enqueueGetRects),o(this,zt).defer(()=>{o(this,Xe).forEach(Fi),o(this,Vt).call(this)})}get geometryKind(){return o(this,mt)}get metadata(){return o(this,qt)}get revision(){return o(this,Xe)[0].revision}get textAndGeometryRevision(){var e,t;return(t=(e=o(this,Ie).getValue())==null?void 0:e.revision)!=null?t:null}get ranges(){return o(this,Xe)}get boundingRange(){return gs(...o(this,Xe))}getRects(e){const t=o(this,Ie).getValue();return(!t||Ei(e,t.revision))&&o(this,Ft).call(this,e),es(E.firstValueFrom(v(o(this,Ie),E.map(n=>n&&Bi(n.revision,e)?n:null),E.filter(ve))))}toString(){var n;const e=this.ranges.map(s=>ui(s)).join(", "),t=(n=o(this,Ie).getValue())==null?void 0:n.revision;return"TextRangeGroupGeometry({ id: ".concat(this.id,", ranges: [").concat(e,"], revision: ").concat(t?Jt(t):null," })")}resolveRects(e,t){const n=o(this,Ie).getValue();(!n||Ei(t,n.revision))&&o(this,Ie).next({rects:o(this,mt)==="lineBoundingBox"?e.map(Rt):e,revision:t})}[Symbol.dispose](){o(this,zt).dispose()}}zt=new WeakMap,qt=new WeakMap,mt=new WeakMap,Xe=new WeakMap,xi=new WeakMap,Ft=new WeakMap,Vt=new WeakMap,Ie=new WeakMap;function Is(i,e){return t=>t.kind==="createElement"?e({...t,id:"".concat(i,"-").concat(t.id),parentId:t.parentId===null?null:"".concat(i,"-").concat(t.parentId)}):e({...t,id:"".concat(i,"-").concat(t.id)})}function As(i,e){return t=>t.kind==="createElement"?e({...t,parentId:t.parentId||i}):e(t)}function Di(i,e,t=n=>n){const n={};for(const[s,r]of Object.entries(i))n[e(s)]=t(r);return n}function Vi(i,e){if(i.kind==="fadeIn"){const t=un(i.startTime,performance.now(),i.duration);return t===1&&(i.running=!1),{alpha:t,running:i.running}}else if(i.kind==="fadeOut"){const t=1-un(i.startTime,performance.now(),i.duration);return t===0&&(i.running=!1),{alpha:t,running:i.running}}else throw new mn(i.kind)}function un(i,e,t){return Math.min(1,Math.max((e-i)/t,0))}var Es=Object.defineProperty,Bs=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),fi=i=>{throw TypeError(i)},Cs=(i,e,t)=>e in i?Es(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,fn=(i,e,t)=>Cs(i,typeof e!="symbol"?e+"":e,t),Ui=(i,e,t)=>e.has(i)||fi("Cannot "+t),c=(i,e,t)=>(Ui(i,e,"read from private field"),e.get(i)),T=(i,e,t)=>e.has(i)?fi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),V=(i,e,t,n)=>(Ui(i,e,"write to private field"),e.set(i,t),t),lt=(i,e,t)=>(Ui(i,e,"access private method"),t),Ws=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&fi("Object expected");var n;n===void 0&&(n=e[Bs("dispose")]),typeof n!="function"&&fi("Object not disposable"),i.push([t,n,e])}return e},Gs=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(a,h,u,d){return d=Error(u),d.name="SuppressedError",d.error=a,d.suppressed=h,d},s=a=>e=t?new n(a,e,"An error was suppressed during disposal"):(t=!0,a),r=a=>{for(;a=i.pop();)try{var h=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(h).then(r,u=>(s(u),r()))}catch(u){s(u)}if(t)throw e};return r()},Li,Ni,jt,Me,C,gi,xe,$e,me,de,le,ce,Bt,Ci,je,Ct,J,I,Dt,Le,ie,kt,Oe,En,Bn,Cn,Wn,Gn,Pn;class Ps{constructor(e){T(this,Oe),T(this,Li,!1),T(this,Ni,!1),T(this,jt,new DisposableStack),T(this,Me),T(this,C),T(this,gi),T(this,xe,new Map),T(this,$e,new Set),T(this,me,new Set),T(this,de,new Set),T(this,le,new Set),T(this,ce,new Set),T(this,Bt,new Set),T(this,Ci,!0),T(this,je,new Xs({returnAllDrawables:!c(this,Ci)})),T(this,Ct),T(this,J,new E.Subject),T(this,I),T(this,Dt),T(this,Le,!1),T(this,ie),T(this,kt,null),V(this,Me,e.canvas),V(this,C,e.context),V(this,I,e.viewportGeometry),V(this,Dt,e.devicePixelRatio),V(this,gi,e.oversamplingFactor),V(this,Ct,e.emitRenderMetrics);let t=!1;const n=[];c(this,jt).use(v(c(this,J),E.tap(s=>{s.reason&&n.push(s.reason),s.immediate&&(t=!0)}),E.exhaustMapWithTrailing(()=>{const s=t,r=[...n];return t=!1,n.length=0,v(E.of(c(this,kt)),E.observeOn(s?E.asapScheduler:E.animationFrameScheduler),E.mergeMap(a=>a?lt(this,Oe,En).call(this,a,[...new Set(r)].join(", ")):E.EMPTY))}),E.subscribe(s=>{s&&c(this,J).next({reason:"animation"})})))}add(e){for(const{drawable:t,visible:n,onscreen:s}of e)c(this,$e).add(t),s&&(c(this,le).add(t),c(this,me).add(t)),n||c(this,de).add(t);c(this,J).next({reason:"add-drawable"})}remove(e){for(const t of e)c(this,le).delete(t),c(this,ce).delete(t),c(this,me).delete(t),c(this,$e).delete(t),c(this,je).remove(t),c(this,Bt).add(t);c(this,J).next({reason:"remove-drawable"})}requestRender(e){for(const t of e)c(this,ce).add(t);c(this,J).next({reason:"request-render"})}requestLayout(e,t){V(this,kt,t);for(const n of e)c(this,le).add(n);c(this,J).next({reason:"request-layout",immediate:!0})}setViewport(e,t,n,s){V(this,kt,s),V(this,I,t),V(this,Dt,n),c(this,me).clear(),c(this,le).clear(),c(this,je).clear();for(const r of e)c(this,le).add(r),c(this,me).add(r);c(this,J).next({reason:"viewport-change",immediate:!0})}setVisibility(e,t){for(const n of e)t?c(this,de).delete(n)&&c(this,ce).add(n):c(this,de).has(n)||(c(this,de).add(n),c(this,ce).add(n));c(this,J).next({reason:"set-visibility"})}showAllVisible(){if(c(this,Le)){V(this,Le,!1),V(this,ie,{kind:"fadeIn",startTime:performance.now(),duration:300,running:!0,metadata:void 0});for(const e of c(this,me))c(this,ce).add(e);c(this,J).next({reason:"show-all-visible"})}}hideAllVisible(){c(this,Le)||(V(this,Le,!0),V(this,ie,void 0),c(this,J).next({reason:"hide-all-visible"}))}[Symbol.dispose](){c(this,jt).dispose()}}Li=new WeakMap;Ni=new WeakMap;jt=new WeakMap;Me=new WeakMap;C=new WeakMap;gi=new WeakMap;xe=new WeakMap;$e=new WeakMap;me=new WeakMap;de=new WeakMap;le=new WeakMap;ce=new WeakMap;Bt=new WeakMap;Ci=new WeakMap;je=new WeakMap;Ct=new WeakMap;J=new WeakMap;I=new WeakMap;Dt=new WeakMap;Le=new WeakMap;ie=new WeakMap;kt=new WeakMap;Oe=new WeakSet;En=async function(i,e){var t,n,s,r,a=[];try{const d=Ws(a,Je.startSpan("CanvasRenderer.#render()",{attributes:{reason:e,minimumRevision:i}}));if(c(this,Le)&&!((t=c(this,ie))!=null&&t.running)){c(this,C).clearRect(0,0,c(this,Me).width,c(this,Me).height);const D={drawablesRenderedOnLastRenderLoop:0,renderedVisibleOnscreenDrawables:new Set,visibleDrawables:c(this,$e).difference(c(this,de)),allDrawables:new Set(c(this,$e))};return queueMicrotask(()=>c(this,Ct).call(this,D)),!1}let f=(n=c(this,ie))!=null&&n.running&&c(this,ie).kind==="fadeOut"?c(this,I):await lt(this,Oe,Gn).call(this,i);const p=c(this,Dt)*c(this,gi),g=Ye(c(this,I).width*p),x=Ye(c(this,I).height*p);if((c(this,Me).width!==g||c(this,Me).height!==x)&&(c(this,Me).width=g,c(this,Me).height=x,f=c(this,I)),(s=c(this,ie))!=null&&s.running&&c(this,ie).kind==="fadeIn"&&(f=c(this,I)),!f)return!1;c(this,C).save(),c(this,C).scale(p,p),c(this,C).translate(-Ye(c(this,I).x),-Ye(c(this,I).y)),c(this,C).globalCompositeOperation="source-over";const b=c(this,ie)?Vi(c(this,ie)).alpha:1;c(this,C).globalAlpha=b;const ne=lt(this,Oe,Bn).call(this,f),M=lt(this,Oe,Cn).call(this,f,ne);c(this,Ni)&&(c(this,C).strokeStyle="blue",c(this,C).strokeRect(c(this,I).x,c(this,I).y,Math.floor(c(this,I).width),Math.floor(c(this,I).height))),c(this,C).restore();const A={drawablesRenderedOnLastRenderLoop:ne.size,renderedVisibleOnscreenDrawables:v(c(this,me).difference(c(this,de)),U(D=>At(c(this,I),D.boundingRect)),U(D=>D.visibleRects.some(W=>At(c(this,I),W))),We),visibleDrawables:c(this,$e).difference(c(this,de)),allDrawables:new Set(c(this,$e))};return queueMicrotask(()=>c(this,Ct).call(this,A)),M||((r=c(this,ie))==null?void 0:r.running)===!0}catch(d){var h=d,u=!0}finally{Gs(a,h,u)}};Bn=function(i){return v((hs(i,c(this,I))?c(this,me):c(this,je).getIntersections(i)).difference(c(this,de)),U(e=>At(c(this,I),e.boundingRect)),We)};Cn=function(i,e){return c(this,C).clearRect(i.x,i.y,i.width,i.height),c(this,Li)&&(c(this,C).strokeStyle="red",c(this,C).strokeRect(i.x,i.y,i.width,i.height)),c(this,C).rect(i.x,i.y,i.width,i.height),c(this,C).clip(),lt(this,Oe,Wn).call(this,e)};Wn=function(i){for(const n of c(this,xe).keys())i.has(n)||c(this,xe).delete(n);for(const n of i)c(this,xe).has(n)||c(this,xe).set(n,n.render(c(this,C)));let e=c(this,xe).size;const t=L(c(this,xe).entries()).sort((n,s)=>n[0].zIndex-s[0].zIndex);for(const[n,s]of t){for(const a of n.opaqueRects)c(this,C).clearRect(a.x,a.y,a.width,a.height);const{done:r}=s.next();r?(e--,c(this,ce).delete(n),c(this,xe).set(n,n.render(c(this,C)))):c(this,ce).add(n)}return e>0};Gn=async function(i){const e=[];if(c(this,le).size>0){const n=await lt(this,Oe,Pn).call(this,i);n&&e.push(n)}for(const n of c(this,ce))!St(n.boundingRect)&&At(c(this,I),n.boundingRect)&&(e.push(n.boundingRect),c(this,ce).delete(n));for(const n of c(this,Bt))c(this,Bt).delete(n),!St(n.boundingRect)&&At(c(this,I),n.boundingRect)&&e.push(n.boundingRect);const t=v(e.map(ls(1)),yi(null));return t&&!St(t)?cs(t,c(this,I)):null};Pn=async function(i){if(c(this,le).size===0)return null;const e=[],t=new Set;for(const s of c(this,le)){if(c(this,de).has(s)||!c(this,me).has(s))continue;const r=s.boundingRect;e.push([r,s.layout(i)]),t.add(s),c(this,le).delete(s),c(this,je).remove(s)}const n=await Promise.all(e.map(async([s,r])=>[s,await r]));return c(this,je).load(t),v(n,qi(di),U(s=>!St(s)),L,yi(null))};class Xs extends yn{constructor(e){var t;super(),fn(this,"_drawables",new Set),fn(this,"_returnAllDrawables"),this._returnAllDrawables=(t=e.returnAllDrawables)!=null?t:!1}toBBox(e){const t=e.boundingRect;return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(e,t){const n=e.boundingRect,s=t.boundingRect;return n.x-s.x}compareMinY(e,t){const n=e.boundingRect,s=t.boundingRect;return n.y-s.y}load(e){const t=We(e);return t.forEach(n=>this._drawables.add(n)),this._returnAllDrawables?this:super.load(L(t))}insert(e){return this._drawables.add(e),super.insert(e)}remove(e){return this._drawables.delete(e),this._returnAllDrawables?this:super.remove(e)}clear(){var e;return(e=this._drawables)==null||e.clear(),this._returnAllDrawables?this:super.clear()}getIntersections(e){return this._returnAllDrawables?this._drawables:new Set(super.search({minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height}))}}var Ys=Object.defineProperty,Xn=i=>{throw TypeError(i)},$s=(i,e,t)=>e in i?Ys(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Os=(i,e,t)=>$s(i,e+"",t),Hi=(i,e,t)=>e.has(i)||Xn("Cannot "+t),w=(i,e,t)=>(Hi(i,e,"read from private field"),t?t.call(i):e.get(i)),H=(i,e,t)=>e.has(i)?Xn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),z=(i,e,t,n)=>(Hi(i,e,"write to private field"),e.set(i,t),t),qe=(i,e,t)=>(Hi(i,e,"access private method"),t),Wi,Tt,nt,Fe,ot,G,Ve,Ue,Ee,Gi,ei,ze,Q,It,Yn,$n,On,zn,ti;const zs="outside",qn=2;function Ti(i,e){return JSON.stringify([i,e])}function Pi(i){const[e,t]=JSON.parse(i);return{decorationId:e,segmentId:t}}let qs=0;class Fs{constructor(e){H(this,Q),H(this,Wi,bi.createLogger("CanvasTextDecoration")),H(this,Tt,new DisposableStack),H(this,nt),H(this,Fe),H(this,ot),H(this,G),H(this,Ve,null),H(this,Ue,null),H(this,Ee,null),H(this,Gi,qs++/1e9),H(this,ei,0),Os(this,"id"),H(this,ze),this.id=e.decorationId,z(this,ze,e.inspector),z(this,nt,e.interactiveGeometryManager),z(this,Fe,e.rangesGroup),z(this,G,e.segments.map(t=>({...t,rects:[],rawRects:[]}))),z(this,ot,e.isFocused),w(this,Tt).defer(()=>{var t;e.onDispose(),this.removeInteractiveGeometry(),(t=w(this,ze))==null||t.call(this,{kind:"removeElement",id:this.id})}),qe(this,Q,On).call(this)}get segments(){return w(this,G)}get zIndex(){return w(this,ot).call(this)?Number.MAX_SAFE_INTEGER:w(this,ei)+w(this,Gi)}get opaqueRects(){return w(this,ot).call(this)?this.rects:[]}get boundingRect(){return w(this,Ve)?w(this,Ve):(z(this,Ve,v(w(this,G).flatMap(e=>e.rects),yi(ds()))),w(this,Ve))}get visibleRects(){return w(this,Ee)?w(this,Ee):(z(this,Ee,v(w(this,G),U(e=>!!e.background||!!e.underline),qi(e=>Rt(e.rects)),L)),w(this,Ee))}get rects(){return w(this,Ue)?w(this,Ue):(z(this,Ue,v(w(this,G).flatMap(e=>e.rects),Rt)),w(this,Ue))}toString(){return"CanvasTextDecoration({ id: ".concat(this.id,", rangesGroup: ").concat(w(this,Fe)," })")}removeInteractiveGeometry(){for(const e of w(this,G))w(this,nt).remove(Ti(this.id,e.id)),qe(this,Q,ti).call(this,e.id,!1)}registerInteractiveGeometry(){for(const e of w(this,G))e.interactive?(w(this,nt).upsert(Ti(this.id,e.id),e.rects),qe(this,Q,ti).call(this,e.id,!0)):(w(this,nt).remove(Ti(this.id,e.id)),qe(this,Q,ti).call(this,e.id,!1))}patchSegment(e,{interactive:t,underline:n,background:s}){let r=!1;z(this,G,w(this,G).map(a=>{if(a.id!==e)return a;t!==a.interactive&&(r=!0);const h=n===null?void 0:n!=null?n:a.underline,u=s===null?void 0:s!=null?s:a.background;return{id:a.id,rawRects:a.rawRects,rects:a.rawRects.map(gn(h)),backgroundAnimation:Vs(s,a),underlineAnimation:Us(n,a),interactive:t!=null?t:a.interactive,underline:h,background:u}})),r&&this.registerInteractiveGeometry(),z(this,Ee,null)}async layout(e){if(w(this,Q,It))return this.boundingRect;const t=await v(w(this,Fe).getRects(e),Ii({success:({rects:n})=>n,failure:n=>(w(this,Wi).error("Unexpected error getting rects - returning empty rects",n),[])}));return w(this,Q,It)?this.boundingRect:(z(this,G,v(rn(w(this,G),t),L,n=>n.map(([s,r])=>({...s,rawRects:v(r,Rt,a=>a.map(dn(Ye))),rects:v(r.map(gn(s.underline)),Rt,a=>a.map(dn(Ye)))})))),this.registerInteractiveGeometry(),z(this,ei,v(rn(w(this,G),w(this,Fe).ranges),U(([n])=>!!n.interactive),$(([n,s])=>s.start),L,n=>n.length===0?w(this,Fe).ranges.map(s=>s.start):n,n=>n.length===0?0:Math.min(...n))),z(this,Ve,null),z(this,Ue,null),z(this,Ee,null),qe(this,Q,zn).call(this),this.boundingRect)}*render(e){if(!w(this,Q,It))for(;;){e.save();const t=qe(this,Q,Yn).call(this,e),n=qe(this,Q,$n).call(this,e);if(e.restore(),t||n)yield;else return}}[Symbol.dispose](){w(this,Tt).dispose()}}Wi=new WeakMap;Tt=new WeakMap;nt=new WeakMap;Fe=new WeakMap;ot=new WeakMap;G=new WeakMap;Ve=new WeakMap;Ue=new WeakMap;Ee=new WeakMap;Gi=new WeakMap;ei=new WeakMap;ze=new WeakMap;Q=new WeakSet;It=function(){return w(this,Tt).disposed};Yn=function(i){var e;let t=!1;for(const n of w(this,G)){const s=n.backgroundAnimation,r=(e=n.background)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.background:void 0;if(r){if(i.save(),s){const{alpha:a,running:h}=Vi(s);t||(t=h),i.globalAlpha=a}for(const a of n.rawRects)a.width<=0||a.height<=0||(i.fillStyle=r.color,i.fillRect(a.x,a.y,a.width,a.height));i.restore()}}return t};$n=function(i){var e;let t=!1;for(const n of w(this,G)){const s=n.underlineAnimation,r=(e=n.underline)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.underline:void 0;if(!r)continue;const{underlineThickness:a,verticalOffset:h}=Vn(n.underline);if(i.save(),s){const{alpha:d,running:f}=Vi(s);t||(t=f),i.globalAlpha=d}for(const d of n.rawRects)d.width<=0||d.height<=0||(i.lineWidth=a,i.strokeStyle=r.color,i.setLineDash(r.style==="dotted"?[a,a]:[]),i.lineCap="butt",i.beginPath(),i.moveTo(d.x,d.y+d.height+h),i.lineTo(d.x+d.width,d.y+d.height+h),i.stroke());i.restore();const u=n.rawRects.at(-1);if(r.style==="ellipsis"&&u){if(u.width<=0||u.height<=0)continue;i.beginPath(),i.lineWidth=0,i.fillStyle=r.color;const d=u.x+u.width,f=u.y+u.height+h,{radius:p,gap:g}=Fn(a),x=2*Math.PI;i.arc(d+g*1,f,p,0,x),i.arc(d+g*2,f,p,0,x),i.arc(d+g*3,f,p,0,x),i.fill()}}return t};On=function(){const i=w(this,ze);i&&(i({kind:"createElement",tagName:"text-decoration",id:this.id,parentId:null}),w(this,G).forEach(e=>{i({kind:"createElement",tagName:"text-decoration-segment",id:e.id,parentId:this.id}),i({kind:"updateAttributes",id:e.id,attributes:{segmentId:e.id,interactive:e.interactive?"true":"false"}})}))};zn=function(){const i=w(this,ze);if(!i)return;const e=this.boundingRect;i({kind:"updateAttributes",id:this.id,attributes:{decorationId:this.id,zIndex:"".concat(this.zIndex),focused:w(this,ot).call(this)?"true":null,style:St(e)?null:"position: absolute; z-index: ".concat(Math.floor(this.zIndex),"; left: ").concat(e.x,"px; top: ").concat(e.y,"px; width: ").concat(e.width,"px; height: ").concat(e.height,"px;")}}),w(this,G).forEach(t=>{const n=v(t.rects,yi(null));i({kind:"updateAttributes",id:t.id,attributes:{segmentId:t.id,...t.underline?Di(t.underline,s=>"underline-".concat(s),String):{align:null,color:null,style:null,thickness:null},...t.background?Di(t.background,s=>"background-".concat(s),String):{color:null},style:n?"position: absolute; left: ".concat(n.x-e.x,"px; top: ").concat(n.y-e.y,"px; width: ").concat(n.width,"px; height: ").concat(n.height,"px;"):null,interactive:t.interactive?"true":null}}),i({kind:"removeAllChildren",id:t.id}),n&&t.rects.forEach((s,r)=>{i({kind:"createElement",tagName:"text-decoration-rect",id:"".concat(t.id,"-").concat(r),parentId:t.id}),i({kind:"updateAttributes",id:"".concat(t.id,"-").concat(r),attributes:{...Di(s,a=>"rect-".concat(a),String),style:"left: ".concat(s.x-n.x,"px; top: ").concat(s.y-n.y,"px; width: ").concat(s.width,"px; height: ").concat(s.height,"px; position: absolute;"),class:"reset-absolute-origin"}})})})};ti=function(i,e){!w(this,ze)||w(this,Q,It)||w(this,ze).call(this,{kind:"updateAttributes",id:i,attributes:{interactive:e?"true":"false"}})};function Fn(i){return{radius:.6*i,gap:2.5*i}}function Vs(i,e){return i&&!e.background?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{background:i},running:!0}:i===null&&e.background?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{background:e.background},running:!0}:e==null?void 0:e.backgroundAnimation}function Us(i,e){return i&&!e.underline?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{underline:i},running:!0}:i===null&&e.underline?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{underline:e.underline},running:!0}:e==null?void 0:e.underlineAnimation}function Vn(i){var e,t;const n=(e=i==null?void 0:i.thickness)!=null?e:qn,s=(t=i==null?void 0:i.align)!=null?t:zs,r=s==="inside"?-n/2:s==="center"?0:n/2;return{underlineThickness:n,verticalOffset:r,align:s}}function gn(i){return e=>{var t;const{underlineThickness:n,align:s}=Vn(i),r=s==="center"?n/2:s==="outside"?n:0,a=Fn((t=i==null?void 0:i.thickness)!=null?t:qn),h=(i==null?void 0:i.style)==="ellipsis"?3*a.gap+a.radius:0;return{...e,height:Ye(e.height+r+.5),width:Ye(e.width+h+.5)}}}var Ls=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),pi=i=>{throw TypeError(i)},Qi=(i,e,t)=>e.has(i)||pi("Cannot "+t),l=(i,e,t)=>(Qi(i,e,"read from private field"),t?t.call(i):e.get(i)),S=(i,e,t)=>e.has(i)?pi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),q=(i,e,t,n)=>(Qi(i,e,"write to private field"),e.set(i,t),t),Y=(i,e,t)=>(Qi(i,e,"access private method"),t),Ns=(i,e,t,n)=>({set _(s){q(i,e,s)},get _(){return l(i,e,n)}}),Xi=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&pi("Object expected");var n;n===void 0&&(n=e[Ls("dispose")]),typeof n!="function"&&pi("Object not disposable"),i.push([t,n,e])}return e},Yi=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(a,h,u,d){return d=Error(u),d.name="SuppressedError",d.error=a,d.suppressed=h,d},s=a=>e=t?new n(a,e,"An error was suppressed during disposal"):(t=!0,a),r=a=>{for(;a=i.pop();)try{var h=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(h).then(r,u=>(s(u),r()))}catch(u){s(u)}if(t)throw e};return r()},Ki,_e,be,ii,y,ni,si,mi,st,ye,Ce,K,ri,ai,oi,rt,hi,Be,li,vi,se,re,$i,ht,ge,ae,P,Oi,Un,ci,Zi,zi,Ln,at;const Nn=class Hn{constructor(e){S(this,P),S(this,_e,new DisposableStack),S(this,be),S(this,ii),S(this,y),S(this,ni),S(this,si),S(this,mi),S(this,st),S(this,ye),S(this,Ce),S(this,K,new Map),S(this,ri,new Kt),S(this,ai,new Kt),S(this,oi,new Kt),S(this,rt,new Map),S(this,hi,new Set),S(this,Be,new Set),S(this,li,null),S(this,vi,new ts({decorationsRenderedOnLastRenderLoop:0,interactiveRectCount:0,renderedVisibleOnscreenDecorationCount:0,visibleDecorationCount:0,allDecorationCount:0,rectCount:0,rangeCount:0})),S(this,se,new Set),S(this,re),S(this,$i,l(this,_e).use(vn((M,A)=>Y(this,P,Un).call(this,M,A),wn))),S(this,ht,new us),S(this,ge,"canvas-text-decoration-manager-".concat(Ns(Hn,Ki)._++)),S(this,ae);var t,n,s,r,a,h,u,d,f,p,g,x,b;q(this,be,bi.createLogger("CanvasTextDecorationManager",e.documentId)),q(this,ii,e.canvas.getContext("2d")),q(this,mi,e.emitSegmentPointerEvents),q(this,st,e.emitHideAllReasons),q(this,ni,e.getRects),q(this,si,e.getBoundingRects),q(this,y,e.documentGeometry),q(this,ae,e.inspector),(t=l(this,ae))==null||t.call(this,{kind:"createElement",id:l(this,ge),tagName:"canvas-text-decoration-manager",parentId:null}),q(this,re,l(this,_e).use(new Ps({canvas:e.canvas,context:l(this,ii),devicePixelRatio:e.devicePixelRatio,oversamplingFactor:e.overSamplingFactor,viewportGeometry:{x:(r=(s=(n=l(this,y))==null?void 0:n.scrollPosition)==null?void 0:s.x)!=null?r:0,y:(u=(h=(a=l(this,y))==null?void 0:a.scrollPosition)==null?void 0:h.y)!=null?u:0,width:(f=(d=l(this,y))==null?void 0:d.documentFrame.width)!=null?f:0,height:(g=(p=l(this,y))==null?void 0:p.documentFrame.height)!=null?g:0},emitRenderMetrics:M=>{const A=v(M.renderedVisibleOnscreenDrawables,$(m=>m.id),We),D=v(M.visibleDrawables,$(m=>m.id),We),W=v(M.allDrawables,$(m=>m.id),We);ss(A,l(this,hi))||(q(this,hi,A),e.emitVisibleOnscreenDecorationsChange(A)),Y(this,P,ci).call(this,{decorationsRenderedOnLastRenderLoop:M.drawablesRenderedOnLastRenderLoop,renderedVisibleOnscreenDecorationCount:A.size,visibleDecorationCount:D.size,allDecorationCount:W.size})}}))),q(this,ye,new Ds({initialRevision:e.initialRevision,initialVisibleTextRange:(b=(x=l(this,y))==null?void 0:x.visibleTextRange)!=null?b:{start:0,end:0},getRects:M=>v(l(this,ni).call(this,M),an(({rects:A,revision:D})=>{var W,m;return D.geometry!==((W=l(this,y))==null?void 0:W.revision)&&((m=l(this,y))==null?void 0:m.scrollPosition)!==void 0&&l(this,be).warn("Expected document geometry revision ".concat(l(this,y).revision," to equal revision ").concat(D.geometry," from getRects() response")),{rects:new Map(v(A.entries(),$(([k,B])=>[k,B.map(Z=>{var ue,fe,we,vt,wt,Ji;return{...Z,x:Z.x+((we=(fe=(ue=l(this,y))==null?void 0:ue.scrollPosition)==null?void 0:fe.x)!=null?we:0),y:Z.y+((Ji=(wt=(vt=l(this,y))==null?void 0:vt.scrollPosition)==null?void 0:wt.y)!=null?Ji:0)}})]))),revision:D}})),getBoundingRects:M=>v(l(this,si).call(this,M),an(({rects:A,revision:D})=>{var W,m;return D.geometry!==((W=l(this,y))==null?void 0:W.revision)&&((m=l(this,y))==null?void 0:m.scrollPosition)!==void 0&&l(this,be).warn("Expected document geometry revision ".concat(l(this,y).revision," to equal revision ").concat(D.geometry," from getRects() response")),{rects:new Map(v(A.entries(),$(([k,B])=>{var Z,ue,fe,we,vt,wt;return[k,{...B,x:B.x+((fe=(ue=(Z=l(this,y))==null?void 0:Z.scrollPosition)==null?void 0:ue.x)!=null?fe:0),y:B.y+((wt=(vt=(we=l(this,y))==null?void 0:we.scrollPosition)==null?void 0:vt.y)!=null?wt:0)}]}))),revision:D}})),emitMetrics:M=>Y(this,P,ci).call(this,M)})),l(this,_e).use(l(this,vi).subscribe(M=>e.emitDecorationMetrics(M))),q(this,Ce,l(this,_e).use(new Ms({label:e.documentId,pointerMove:l(this,ri),pointerDown:l(this,oi),pointerUp:l(this,ai),getViewport:()=>{var M,A,D,W,m,k,B,Z,ue,fe;return{x:(D=(A=(M=l(this,y))==null?void 0:M.scrollPosition)==null?void 0:A.x)!=null?D:0,y:(k=(m=(W=l(this,y))==null?void 0:W.scrollPosition)==null?void 0:m.y)!=null?k:0,width:(Z=(B=l(this,y))==null?void 0:B.documentFrame.width)!=null?Z:0,height:(fe=(ue=l(this,y))==null?void 0:ue.documentFrame.height)!=null?fe:0}},compareZIndex:(M,A)=>{const D=Pi(M.geometry),W=Pi(A.geometry),m=l(this,K).get(D.decorationId),k=l(this,K).get(W.decorationId);if(!m||!k)return 0;if(m.zIndex===k.zIndex){const B=m.segments.find(we=>we.id===D.segmentId),Z=k.segments.find(we=>we.id===W.segmentId);if(!B||!Z)return 0;const ue=B.underline?1:0,fe=Z.underline?1:0;return ue-fe}return m.zIndex-k.zIndex},emitMetrics:M=>Y(this,P,ci).call(this,{interactiveRectCount:M.interactiveRectCount})}))),l(this,_e).use(l(this,Ce).onPointerEvent.subscribe(M=>Y(this,P,Ln).call(this,M)));const ne=Et(e.initialHideAllReasons);ne&&this.addHideAllReasons(ne)}notifyPointerEvent(e){var t,n,s,r,a,h,u,d,f,p;const g={x:e.position.x-((n=(t=l(this,y))==null?void 0:t.documentFrame.x)!=null?n:0)+((a=(r=(s=l(this,y))==null?void 0:s.scrollPosition)==null?void 0:r.x)!=null?a:0),y:e.position.y-((u=(h=l(this,y))==null?void 0:h.documentFrame.y)!=null?u:0)+((p=(f=(d=l(this,y))==null?void 0:d.scrollPosition)==null?void 0:f.y)!=null?p:0)};switch(e.kind){case"pointerMove":return l(this,ri).emit(g);case"pointerDown":return l(this,oi).emit(g);case"pointerUp":return l(this,ai).emit(g);default:throw new mn(e.kind)}}notifyDocumentGeometryChanged(e,t){return l(this,$i).enqueue(e,t)}notifyTextChanged(e){var t,n,s,r=[];try{const u=Xi(r,Je.startSpan("CanvasTextDecorationManager.#handleTextChanged()",{attributes:{change:e}})),{visibleChanged:d}=l(this,ye).pushTextChange(e);l(this,ht).pushNewTextRevision(e.revision);const f=v(d,$(p=>l(this,K).get(p.metadata)),U(ve),L);l(this,re).requestLayout(f,{text:(t=l(this,ht).textRevision)!=null?t:xn,geometry:(s=(n=l(this,y))==null?void 0:n.revision)!=null?s:ps}),f.length>0&&l(this,be).verbose("text changed",{change:e,visibleChangedDecorationsCount:f.length,visibleChangedSegmentsCount:Array.from(f).flatMap(p=>p.segments).length})}catch(u){var a=u,h=!0}finally{Yi(r,a,h)}}async upsert(e){var t,n;this.remove([e.id]),e.visibility==="visible"&&l(this,Be).add(e.id);const s=Et(e.segments);if(!s)return Qt();const r=new AbortController;if(l(this,rt).set(e.id,r),await l(this,ht).enqueue({kind:"add",options:e},e.revision),l(this,rt).get(e.id)===r&&l(this,rt).delete(e.id),r.signal.aborted)return Qt();const a=l(this,ye).add({id:e.id,revision:e.revision,geometryKind:"rects",ranges:v(s,_n(d=>({id:d.id,range:d.range,updateSemantics:d.updateSemantics,metadata:void 0}))),metadata:e.id,visible:l(this,Be).has(e.id)});if(!a.ok)return a;const h=a.value,u=new Fs({decorationId:e.id,rangesGroup:h,segments:s,interactiveGeometryManager:l(this,Ce),isFocused:()=>l(this,li)===e.id,onDispose:()=>{Fi(h),this.remove([e.id])},inspector:l(this,ae)?Is(l(this,ge),As(l(this,ge),l(this,ae))):void 0});return l(this,K).set(e.id,u),l(this,re).add([{drawable:u,visible:l(this,Be).has(e.id),onscreen:Ai(h.boundingRange,(n=(t=l(this,y))==null?void 0:t.visibleTextRange)!=null?n:{start:0,end:0})}]),l(this,be).verbose("added ".concat(l(this,Be).has(e.id)?"visible":"hidden"," decoration #").concat(e.id)),Qt()}remove(e){var t=[];try{const r=We(e);r.forEach(u=>{var d;return(d=l(this,rt).get(u))==null?void 0:d.abort()});const a=Y(this,P,Oi).call(this,r);if(a.length===0)return;const h=Xi(t,new DisposableStack);a.map(u=>{l(this,K).delete(u.id),h.use(u)}),l(this,re).remove(a),l(this,be).verbose("removed decorations ".concat(a.map(u=>u.id).join(", ")))}catch(r){var n=r,s=!0}finally{Yi(t,n,s)}}setVisibility(e,t){const n=We(e);l(this,ye).setVisibility(n,t),n.forEach(r=>t?l(this,Be).add(r):l(this,Be).delete(r));const s=Y(this,P,Oi).call(this,n);s.length!==0&&(t?s.forEach(r=>r.registerInteractiveGeometry()):s.forEach(r=>r.removeInteractiveGeometry()),l(this,re).setVisibility(s,t))}removeHideAllReasons(e){var t,n;e.length!==0&&(e.forEach(s=>l(this,se).delete(s)),l(this,se).size>0||l(this,K).size===0?((t=l(this,ae))==null||t.call(this,{kind:"updateAttributes",id:l(this,ge),attributes:{hidden:Array.from(l(this,se)).join(" ")}}),l(this,st).call(this,l(this,se))):((n=l(this,ae))==null||n.call(this,{kind:"updateAttributes",id:l(this,ge),attributes:{hidden:null}}),l(this,st).call(this,l(this,se)),l(this,Ce).enablePointerEvents(),l(this,ye).enableGeometryUpdate(),l(this,re).showAllVisible()))}addHideAllReasons(e){var t;const n=l(this,se).size>0;e.forEach(s=>l(this,se).add(s)),(t=l(this,ae))==null||t.call(this,{kind:"updateAttributes",id:l(this,ge),attributes:{hidden:Array.from(l(this,se)).join(" ")}}),l(this,st).call(this,l(this,se)),!(n||l(this,K).size===0)&&(l(this,Ce).disablePointerEvents(),l(this,ye).disableGeometryUpdate(),l(this,re).hideAllVisible())}patchSegment(e,t,n){const s=l(this,K).get(e);s&&(s.patchSegment(t,n),l(this,re).requestRender([s]))}focus(e){q(this,li,e)}dispose(){var e;l(this,_e).disposed||(l(this,_e).dispose(),(e=l(this,ae))==null||e.call(this,{kind:"removeElement",id:l(this,ge)}))}};Ki=new WeakMap;_e=new WeakMap;be=new WeakMap;ii=new WeakMap;y=new WeakMap;ni=new WeakMap;si=new WeakMap;mi=new WeakMap;st=new WeakMap;ye=new WeakMap;Ce=new WeakMap;K=new WeakMap;ri=new WeakMap;ai=new WeakMap;oi=new WeakMap;rt=new WeakMap;hi=new WeakMap;Be=new WeakMap;li=new WeakMap;vi=new WeakMap;se=new WeakMap;re=new WeakMap;$i=new WeakMap;ht=new WeakMap;ge=new WeakMap;ae=new WeakMap;P=new WeakSet;Oi=function(i){return v(i,$(e=>l(this,K).get(e)),U(ve),L)};Un=function(i,e){var t,n,s,r,a,h,u=[];try{const p=Xi(u,Je.startSpan("CanvasTextDecorationManager.#handleGeometryChange()",{attributes:{documentGeometry:i,devicePixelRatio:e}}));q(this,y,i),(t=l(this,ae))==null||t.call(this,{kind:"updateAttributes",id:l(this,ge),attributes:{style:"width: ".concat(i.documentFrame.width,"px; height: ").concat(i.documentFrame.height,"px; position: absolute; top: ").concat(i.documentFrame.y,"px; left: ").concat(i.documentFrame.x,"px;")}});const{visible:g}=l(this,ye).pushDocumentGeometryChange(i.visibleTextRange,i.revision),x=v(g,$(b=>l(this,K).get(b.metadata)),U(ve),b=>new Set(b));l(this,Ce).clear(),l(this,re).setViewport(x,{x:(s=(n=i.scrollPosition)==null?void 0:n.x)!=null?s:0,y:(a=(r=i.scrollPosition)==null?void 0:r.y)!=null?a:0,width:i.documentFrame.width,height:i.documentFrame.height},e,{text:(h=l(this,ht).textRevision)!=null?h:xn,geometry:i.revision}),l(this,be).verbose("geometry changed",{visibleTextRange:ui(i.visibleTextRange)})}catch(p){var d=p,f=!0}finally{Yi(u,d,f)}};ci=function(i){l(this,vi).update(e=>({...e,...i}))};Zi=function(i){var e,t,n,s,r,a,h,u,d,f;return rs({x:i.x-((n=(t=(e=l(this,y))==null?void 0:e.scrollPosition)==null?void 0:t.x)!=null?n:0)+((r=(s=l(this,y))==null?void 0:s.documentFrame.x)!=null?r:0),y:i.y-((u=(h=(a=l(this,y))==null?void 0:a.scrollPosition)==null?void 0:h.y)!=null?u:0)+((f=(d=l(this,y))==null?void 0:d.documentFrame.y)!=null?f:0)})};zi=function(i){return{...Y(this,P,Zi).call(this,i),width:i.width,height:i.height}};Ln=function(i){l(this,mi).call(this,{pointerEnter:Y(this,P,at).call(this,i.pointerEnter),pointerLeave:Y(this,P,at).call(this,i.pointerLeave),pointerDown:Y(this,P,at).call(this,i.pointerDown),pointerUp:Y(this,P,at).call(this,i.pointerUp),pointerClick:Y(this,P,at).call(this,i.pointerClick)})};at=function(i){var e,t,n;if(!i)return;const{decorationId:s,segmentId:r}=Pi(i.target),a=l(this,K).get(s),h=Et((n=(t=(e=a==null?void 0:a.segments)==null?void 0:e.find(u=>u.id===r))==null?void 0:t.rects)!=null?n:[]);return!a||!h?void 0:{kind:i.kind,segmentId:r,id:s,position:Y(this,P,Zi).call(this,i.position),rect:Y(this,P,zi).call(this,i.currentTarget),decorationRects:a.rects.map(u=>Y(this,P,zi).call(this,u))}};S(Nn,Ki,0);let Hs=Nn;async function Qs(i){return is(new Hs(i))}const Ks=Object.freeze(Object.defineProperty({__proto__:null,createCanvasTextDecorationManager:Qs},Symbol.toStringTag,{value:"Module"}));ns(Ks);
//# sourceMappingURL=createCanvasTextDecorationManager-C_w8N5Vj.js.map
