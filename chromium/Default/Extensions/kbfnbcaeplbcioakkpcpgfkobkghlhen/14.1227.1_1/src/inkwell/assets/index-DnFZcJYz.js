import{$ as O,w as pe,s as de,b as g,x as X,K,y as re,a0 as u,X as Ie,l as Pe,L as fe,e as le,B as xe,q as ze,m as Ge,Q as Ce,Y as Be,c as qe,o as Le}from"./index-D8eA2Snd.js";import{A as Se}from"./index-CsxX5Jny.js";import{D as He}from"./Delta-Bv7tGR-CQrdco4K.js";import{t as Ne}from"./timeoutWith-lGRlQu-D2GsbXJn.js";import{R as Xe}from"./RandomSampler-Ba-P26-DyiLAlld.js";import{E as be}from"./Emitter-B4Dl_G-CoLDBUlE.js";import{i as Ke}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{c as Qe,i as ne}from"./GeometryRevisionFns-BWCMxs-DX1ABpMm.js";import{c as te,R as q,L as Ye}from"./index-BUrsDwB9.js";import{d as Je}from"./defineFactory-En4T0P-BKA6DmWp.js";var De=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),Z=t=>{throw TypeError(t)},me=(t,e,s)=>e.has(t)||Z("Cannot "+s),i=(t,e,s)=>(me(t,e,"read from private field"),s?s.call(t):e.get(t)),m=(t,e,s)=>e.has(t)?Z("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),v=(t,e,s,r)=>(me(t,e,"write to private field"),e.set(t,s),s),oe=(t,e,s)=>(me(t,e,"access private method"),s),ae=(t,e,s)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Z("Object expected");var r;r=e[De("asyncDispose")],r===void 0&&(r=e[De("dispose")]),typeof r!="function"&&Z("Object not disposable"),t.push([s,r,e])}else t.push([s]);return e},ce=(t,e,s)=>{var r=typeof SuppressedError=="function"?SuppressedError:function(o,a,c,d){return d=Error(c),d.name="SuppressedError",d.error=o,d.suppressed=a,d},h=o=>e=s?new r(o,e,"An error was suppressed during disposal"):(s=!0,o),l=o=>{for(;o=t.pop();)try{var a=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(a).then(l,c=>(h(c),l()))}catch(c){h(c)}if(s)throw e};return l()},y,k,M,Q,I,w,_,D,x,Y,P,z,C,$,A,F,G,Te,ue;class Ze{constructor(e,s){m(this,G),m(this,y),m(this,k,new DisposableStack),m(this,M,new O({revision:Ke,content:new He})),m(this,Q,new O([])),m(this,I,new Xe({probability:.01})),m(this,w,!1),m(this,_,!1),m(this,D,!1),m(this,x,new O({geometry:null,windowFrameMoving:!1,windowFrameResizing:!1,documentFrameScrolling:!1})),m(this,Y,new be),m(this,P,new O(!1)),m(this,z,new be),m(this,C,[]),m(this,$),m(this,A,{getRects:0,getBoundingRects:0}),m(this,F),v(this,F,e),v(this,$,s),v(this,y,pe.createLogger("TextDocument",e.id));const r=Ne(g(e.getText(),re(n=>{i(this,M).setValue(n);const f=new Se({revision:n.revision,change:n.content});i(this,C).push(f),i(this,z).emit(f)}),X(K(n=>{i(this,y).error("Unexpected error when fetching initial text",n)}))),{timeoutMs:5e3,defaultValue:de(),onTimeout:()=>{i(this,y).warn("Did not receive initial text within 5s.")}});i(this,k).use(g(u.fromSubscribable(e.onTextDidChange),u.bufferUntil(r),u.subscribe(n=>{const f=i(this,M).getValue();if(n.revision<=f.revision)return;const T=f.content.compose(n.change);i(this,M).setValue({revision:n.revision,content:T});const N=new Se(n);i(this,C).push(N),i(this,z).emit(N),queueMicrotask(()=>oe(this,G,Te).call(this))}))),i(this,k).use(e.onSelectionDidChange.subscribe(n=>i(this,Q).setValue(Array.from(n))));const h=u.fromSubscribable(e.onGeometryWillChange).pipe(u.share()),l=u.fromSubscribable(e.onGeometryDidChange).pipe(u.share());i(this,k).use(g(h,u.subscribe(n=>{v(this,D,n.has("DocumentFrameScrolled")?!0:i(this,D)),v(this,_,n.has("WindowFrameChanged")?!0:i(this,_)),v(this,w,n.has("WindowFrameChanged")?!0:i(this,w)),i(this,Y).emit({reasons:n,documentFrameScrolling:i(this,D),windowFrameResizing:i(this,_),windowFrameMoving:i(this,w)})}))),i(this,k).use(g(l,u.subscribe(n=>{v(this,D,n.has("DocumentFrameScrolled")?!1:i(this,D)),v(this,w,n.has("WindowFrameChanged")?!1:i(this,w)),v(this,_,n.has("WindowFrameChanged")?!1:i(this,_))}))),i(this,k).use(e.hasFocus.subscribe(n=>{i(this,P).setValue(n),n||(v(this,D,!1),v(this,w,!1),v(this,_,!1),i(this,x).update(f=>({...f,windowFrameMoving:i(this,w),windowFrameResizing:i(this,_),documentFrameScrolling:i(this,D)})))}));const o=g(h,u.switchMap(()=>{const n=i(this,w)||i(this,_)?2e3:1e3;return g(l,u.take(1),u.timeout({first:n,with:()=>u.of(null)}),u.filter(f=>f===null),u.tap(()=>{}))}));let a=ne;const c=new u.Subject;let d=0;i(this,k).use(g(u.merge(u.fromSubscribableState(e.hasFocus),l,o,c),u.tap(()=>{a=Qe(a+1)}),u.filter(()=>e.hasFocus.getValue()),u.exhaustMapWithTrailing(async(n,f)=>{var T=[];try{const ie=ae(T,s.duration("get_geometry",{labels:{request_kind:f===0?"initial":"other"},sampler:i(this,I)}),!0);return await g(e.getGeometry(),X(K(Oe=>ie.close(Oe))))}catch(ie){var N=ie,Ue=!0}finally{var ye=ce(T,N,Ue);ye&&await ye}}),u.subscribe(Ie({success:n=>{d=0,i(this,x).setValue({geometry:{...n,revision:a},windowFrameMoving:i(this,w),windowFrameResizing:i(this,_),documentFrameScrolling:i(this,D)})},failure:n=>{i(this,y).error("Unexpected error when fetching document geometry",n),i(this,P).getValue()&&d<3?(d++,c.next()):i(this,$).count("get_geometry_aborted")}}))))}get onTextDidChange(){return i(this,z)}get id(){return i(this,F).id}get connectorId(){return i(this,F).connectorId}get text(){return i(this,M)}get selection(){return i(this,Q)}get geometry(){return i(this,x)}get geometryWillChange(){return i(this,Y)}get hasFocus(){return i(this,P)}setText(e){return i(this,F).setText(e)}setSelection(e){return i(this,F).setSelection(i(this,M).getValue().revision,e)}async getRects(e){var s,r=[];try{const a=i(this,x).getValue().geometry;a||i(this,y).warn("Calling TextDocument.getRects() with no geometry revision yet");const c=i(this,M).getValue().revision,d=(s=a==null?void 0:a.revision)!=null?s:ne,n=ae(r,i(this,$).duration("get_rects",{labels:{request_kind:i(this,A).getRects===0?"initial":"other",bucket_size:oe(this,G,ue).call(this,e.size)},sampler:i(this,I)}),!0);return i(this,A).getRects++,await g(i(this,F).getRectsForRanges(c,e),re(({rects:f,textRevision:T})=>({rects:f,revision:{text:T,geometry:d}})),X(K(f=>{n.close(f),i(this,y).error("Unexpected error when calling RemoteDocument.getRectsForRanges()",f)})))}catch(a){var h=a,l=!0}finally{var o=ce(r,h,l);o&&await o}}async getBoundingRects(e){var s,r=[];try{const a=i(this,x).getValue().geometry;a||i(this,y).warn("Calling TextDocument.getBoundingRects() with no geometry revision yet");const c=(s=a==null?void 0:a.revision)!=null?s:ne,d=ae(r,i(this,$).duration("get_bounding_rects",{labels:{request_kind:i(this,A).getBoundingRects===0?"initial":"other",bucket_size:oe(this,G,ue).call(this,e.size)},sampler:i(this,I)}),!0);return i(this,A).getBoundingRects++,await g(i(this,F).getBoundingRectForRanges(i(this,M).getValue().revision,e),re(({rects:n,textRevision:f})=>({rects:n,revision:{text:f,geometry:c}})),X(K(n=>{d.close(n),i(this,y).error("Unexpected error when calling RemoteDocument.getBoundingRectForRanges()",n)})))}catch(a){var h=a,l=!0}finally{var o=ce(r,h,l);o&&await o}}[Symbol.dispose](){i(this,k).dispose()}}y=new WeakMap;k=new WeakMap;M=new WeakMap;Q=new WeakMap;I=new WeakMap;w=new WeakMap;_=new WeakMap;D=new WeakMap;x=new WeakMap;Y=new WeakMap;P=new WeakMap;z=new WeakMap;C=new WeakMap;$=new WeakMap;A=new WeakMap;F=new WeakMap;G=new WeakSet;Te=function(){for(var t;((t=i(this,C).at(0))==null?void 0:t.inUse)===!1;)i(this,C).shift();i(this,C).length>1e3&&i(this,y).warn("Document history is too long.")};ue=function(t){return Math.ceil(t/10).toString()};var je=Object.defineProperty,$e=t=>{throw TypeError(t)},et=(t,e,s)=>e in t?je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,he=(t,e,s)=>et(t,typeof e!="symbol"?e+"":e,s),Ae=(t,e,s)=>e.has(t)||$e("Cannot "+s),U=(t,e,s)=>(Ae(t,e,"read from private field"),s?s.call(t):e.get(t)),ke=(t,e,s)=>e.has(t)?$e("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),tt=(t,e,s,r)=>(Ae(t,e,"write to private field"),e.set(t,s),s),E,J;class st{constructor(e,s){he(this,"startedAt",performance.now()),he(this,"remoteDocument"),he(this,"document"),ke(this,E,new AsyncDisposableStack),ke(this,J,this.startedAt),this.remoteDocument=e,this.document=U(this,E).use(new Ze(e,s)),U(this,E).use(this.document.hasFocus.subscribe(r=>{r&&tt(this,J,performance.now())}))}get lastFocusAt(){return U(this,J)}use(e){return U(this,E).use(e)}async[Symbol.asyncDispose](){await U(this,E).disposeAsync()}}E=new WeakMap;J=new WeakMap;var it=Object.defineProperty,Me=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),j=t=>{throw TypeError(t)},rt=(t,e,s)=>e in t?it(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,nt=(t,e,s)=>rt(t,e+"",s),ge=(t,e,s)=>e.has(t)||j("Cannot "+s),p=(t,e,s)=>(ge(t,e,"read from private field"),s?s.call(t):e.get(t)),R=(t,e,s)=>e.has(t)?j("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Fe=(t,e,s,r)=>(ge(t,e,"write to private field"),e.set(t,s),s),W=(t,e,s)=>(ge(t,e,"access private method"),s),We=(t,e,s)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&j("Object expected");var r;s&&(r=e[Me("asyncDispose")]),r===void 0&&(r=e[Me("dispose")]),typeof r!="function"&&j("Object not disposable"),t.push([s,r,e])}else s&&t.push([s]);return e},ot=(t,e,s)=>{var r=typeof SuppressedError=="function"?SuppressedError:function(o,a,c,d){return d=Error(c),d.name="SuppressedError",d.error=o,d.suppressed=a,d},h=o=>e=s?new r(o,e,"An error was suppressed during disposal"):(s=!0,o),l=o=>{for(;o=t.pop();)try{var a=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(a).then(l,c=>(h(c),l()))}catch(c){h(c)}if(s)throw e};return l()},V,S,ee,L,B,H,b,ve,se,Ee,we,Ve;const at=te(Symbol("TextDocument")),ct=te(Symbol("DocumentSession")),ht=100;class lt{constructor(e,s,r){R(this,b),R(this,V,new AsyncDisposableStack),R(this,S,[]),R(this,ee),R(this,L),R(this,B,new O(null)),R(this,H,pe.createLogger("DocumentSessionManager")),nt(this,"activeDocumentId",p(this,B)),Fe(this,ee,e),Fe(this,L,r),p(this,V).use(s.onDocumentDidCreate.subscribe(h=>{p(this,V).use(g(u.fromSubscribableState(h.hasFocus),u.subscribe(l=>{l?(p(this,B).setValue(h.id),W(this,b,Ee).call(this,h)||W(this,b,Ve).call(this,h)):p(this,B).setValue(null)})))})),p(this,V).use(s.onDocumentWillDestroy.subscribe(h=>{const l=W(this,b,we).call(this,h);l&&W(this,b,se).call(this,l,"document will destroy")}))}async[Symbol.asyncDispose](){return p(this,V).disposeAsync()}}V=new WeakMap;S=new WeakMap;ee=new WeakMap;L=new WeakMap;B=new WeakMap;H=new WeakMap;b=new WeakSet;ve=function(t){const e=p(this,S).indexOf(t);if(e===-1?p(this,S).push(t):(p(this,S).splice(e,1),p(this,S).push(t)),p(this,S).length>ht){const s=p(this,S).shift();s!==void 0&&W(this,b,se).call(this,s,"session list is overflown")}};se=function(t,e){const s=p(this,S).indexOf(t);s!==-1&&(p(this,S).splice(s,1),p(this,H).verbose({context:t.remoteDocument.id},"Disposing session for document because ".concat(e,"."))),Pe(t)};Ee=function(t){const e=W(this,b,we).call(this,t);return e&&W(this,b,ve).call(this,e),e};we=function(t){var e;return(e=p(this,S).find(s=>s.remoteDocument.id===t.id))!=null?e:null};Ve=async function(t){var e=[];try{const l=We(e,p(this,L).duration("create_session")),o=We(e,new AsyncDisposableStack,!0),a=new st(t,p(this,L));a.use(t),p(this,H).verbose({context:a.remoteDocument.id},"Create a session for document."),W(this,b,ve).call(this,a),o.defer(()=>W(this,b,se).call(this,a,"session is disposed")),await g(p(this,ee).createExecutionScope("document-session",a),q.use(o),fe(c=>g(q.all([c.register({token:at,useValue:a.document}),c.register({token:ct,useValue:a})]),q.use(o),le(()=>c))),xe,ze(c=>c.start()),Ge({success:()=>{a.use(o.move())},failure:c=>{l.close(c),p(this,H).error("Failed to create a session due to:",c,{context:a.remoteDocument.id})}}))}catch(l){var s=l,r=!0}finally{var h=ot(e,s,r);h&&await h}};const Re=te(Symbol("FeatureContext")),_e=te(Symbol("DocumentSessionManager")),Dt=t=>q.all([g(Ce([t.getFeature("connector"),t.getFeature("monitoring"),t.getExecutionScope("global")]),fe(([e,s,r])=>q.all([...ut(t,r,e,s),de(r.onStart(async h=>h.resolve(_e)))]))),pt(t)]);function ut(t,e,s,r){return[e.register({token:Re,useValue:t}),e.register({token:_e,useFactory:Je(lt,[Re,s.provides.ConnectorDocumentManager,r.provides.Monitoring])},{lifetime:Ye.Singleton})]}function pt(t){return g(t.getExecutionScope("global"),le(e=>e.onStart(s=>g(t.getFeature("performance-hud"),fe(r=>Ce([s.resolve(r.provides.HUD),s.resolve(_e)])),le(([r,h])=>h.activeDocumentId.subscribe(l=>r.setActiveDocument(l))),Be(r=>(pe.error("Unexpected error using HUD in feature-document-session",r),de(qe(Le)))),xe))))}export{_e as DocumentSessionManagerToken,ct as DocumentSessionToken,at as TextDocumentToken,Dt as activate};
//# sourceMappingURL=index-DnFZcJYz.js.map
