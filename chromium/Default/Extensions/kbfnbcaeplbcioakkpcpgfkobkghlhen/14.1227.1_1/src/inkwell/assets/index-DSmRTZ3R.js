var Ct=t=>{throw TypeError(t)};var Dt=(t,e,i)=>e.has(t)||Ct("Cannot "+i);var T=(t,e,i)=>(Dt(t,e,"read from private field"),i?i.call(t):e.get(t)),ce=(t,e,i)=>e.has(t)?Ct("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),it=(t,e,i,s)=>(Dt(t,e,"write to private field"),s?s.call(t,i):e.set(t,i),i);import{w as vt,H as v,ah as ni,b as d,q as A,ab as Tt,ai,S as Rt,a6 as ri,y as Q,o as X,F as Y,$ as ft,E as oi,a7 as At,D as Ft,x as rt,K as ot,M as Vt,u as st,U as ci,a0 as m,t as Ht,L as li,s as hi,Q as xt,e as di}from"./index-D8eA2Snd.js";import{c as ui,R as pi,A as wi,L as vi,b as fi}from"./index-BUrsDwB9.js";import{r as mi,a as $t,c as le,d as he,b as nt}from"./index-DWAslvUv.js";import{A as gi}from"./index-CsxX5Jny.js";import{E as y}from"./Emitter-B4Dl_G-CoLDBUlE.js";import{C as _i}from"./CircularBuffer-BES1B1-Nicfgaw3.js";import{t as bi}from"./timeoutWith-lGRlQu-D2GsbXJn.js";import{D as yi}from"./Delta-Bv7tGR-CQrdco4K.js";import{a as ki,e as at,h as de,b as Pt}from"./RectFns-D2VKzQ-B5TdcvOe.js";import{i as Mi}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{i as Wi}from"./GeometryRevisionFns-BWCMxs-DX1ABpMm.js";import{f as Si}from"./NonEmptyArrayFns-oGa02u-CLyX5YlY.js";import{d as Ci}from"./defineFactory-En4T0P-BKA6DmWp.js";var wt,J,K,ie;class Di{constructor(){ce(this,wt,vt.createLogger("FastDOM"));ce(this,J,[]);ce(this,K,[]);ce(this,ie,!1)}get estimatedExecutionDuration(){return(T(this,J).length+T(this,K).length*7)/40}measure(e){const i=Promise.withResolvers();return T(this,J).push(()=>{try{i.resolve(e())}catch(s){i.reject(s)}}),this._schedule(),v(i.promise)}mutate(e){const i=Promise.withResolvers();return T(this,K).push(async()=>{try{i.resolve(await e())}catch(s){i.reject(s)}}),this._schedule(),v(i.promise)}_schedule(){T(this,ie)||(it(this,ie,!0),requestAnimationFrame(()=>this.flush()))}flush(){performance.now();const e=T(this,J).splice(0),i=T(this,K).splice(0);e.forEach(s=>s()),performance.now(),i.forEach(s=>s()),performance.now(),it(this,ie,!1)}clear(){T(this,J).length=0,T(this,K).length=0}}wt=new WeakMap,J=new WeakMap,K=new WeakMap,ie=new WeakMap;const Ri=new Di;function B(t,e,i){t.style.getPropertyValue(e)!==i&&(i==null?t.style.removeProperty(e):t.style.setProperty(e,String(i)))}function ye(t,e=window.devicePixelRatio){const i=e===1?0:e<10?1:e<100?2:Math.ceil(Math.log10(e));return mi(t,i)}const Fi=ni(new Worker(new URL("createCanvasTextDecorationManager-C_w8N5Vj.js",import.meta.url),{type:"module"}));var Ot=t=>{throw TypeError(t)},Vi=(t,e,i)=>e.has(t)||Ot("Cannot "+i),D=(t,e,i)=>(Vi(t,e,"read from private field"),i?i.call(t):e.get(t)),Pi=(t,e,i)=>e.has(t)?Ot("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),W;class Ei{constructor(){Pi(this,W,Promise.withResolvers())}init(e){return v(Fi.createCanvasTextDecorationManager(e).then(i=>D(this,W).resolve(i)).catch(i=>D(this,W).reject(i)))}notifyPointerEvent(e){return d(v(D(this,W).promise),A(i=>v(i.notifyPointerEvent(e))))}notifyDocumentGeometryChanged(e,i){return d(v(D(this,W).promise),A(s=>s.notifyDocumentGeometryChanged(e,i)))}notifyTextChanged(e){return d(v(D(this,W).promise),A(i=>v(i.notifyTextChanged(e))))}upsert(e){return d(v(D(this,W).promise),A(i=>i.upsert(e)))}remove(e){return d(v(D(this,W).promise),A(i=>v(i.remove(e))))}setVisibility(e,i){return d(v(D(this,W).promise),A(s=>v(s.setVisibility(e,i))))}focus(e){return d(v(D(this,W).promise),A(i=>v(i.focus(e))))}removeHideAllReasons(e){return d(v(D(this,W).promise),A(i=>v(i.removeHideAllReasons(e))))}addHideAllReasons(e){return d(v(D(this,W).promise),A(i=>v(i.addHideAllReasons(e))))}patchSegment(e,i,s){return d(v(D(this,W).promise),A(a=>v(a.patchSegment(e,i,s))))}[Symbol.asyncDispose](){return D(this,W).promise.then(e=>e.dispose())}}W=new WeakMap;function Lt(){return crypto.randomUUID()}var Ti=Object.defineProperty,zt=t=>{throw TypeError(t)},Ai=(t,e,i)=>e in t?Ti(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,z=(t,e,i)=>Ai(t,typeof e!="symbol"?e+"":e,i),Ut=(t,e,i)=>e.has(t)||zt("Cannot "+i),h=(t,e,i)=>(Ut(t,e,"read from private field"),i?i.call(t):e.get(t)),F=(t,e,i)=>e.has(t)?zt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Et=(t,e,i,s)=>(Ut(t,e,"write to private field"),e.set(t,i),i),P,H,ke,Me,We,Se,Ce,De,Re,Fe,ue,Ve;class Hi{constructor(e){F(this,P,new DisposableStack),F(this,H),F(this,ke),F(this,Me,new y),F(this,We,new y),F(this,Se,new y),F(this,Ce,new y),F(this,De,new y),F(this,Re,new y),F(this,Fe,new y),F(this,ue,new ft(new Set)),F(this,Ve,new Map),z(this,"onPointerEnter",h(this,Me)),z(this,"onPointerLeave",h(this,We)),z(this,"onPointerHoverChange",h(this,Se)),z(this,"onPointerDown",h(this,Ce)),z(this,"onPointerUp",h(this,De)),z(this,"onPointerClick",h(this,Re)),z(this,"onFocusChange",h(this,Fe)),z(this,"visibleOnscreenDecorations",h(this,ue)),z(this,"id",Lt()),Et(this,H,e.children),Et(this,ke,e.upsert),e.children.forEach(i=>{h(this,P).use(i.onPointerEnter.subscribe(s=>h(this,Me).emit(s))),h(this,P).use(i.onPointerLeave.subscribe(s=>h(this,We).emit(s))),h(this,P).use(i.onPointerHoverChange.subscribe(s=>h(this,Se).emit(s))),h(this,P).use(i.onPointerDown.subscribe(s=>h(this,Ce).emit(s))),h(this,P).use(i.onPointerUp.subscribe(s=>h(this,De).emit(s))),h(this,P).use(i.onPointerClick.subscribe(s=>h(this,Re).emit(s))),h(this,P).use(i.onFocusChange.subscribe(s=>h(this,Fe).emit(s))),h(this,P).use(i.visibleOnscreenDecorations.subscribe(s=>{h(this,Ve).set(i,s);const a=d(h(this,Ve).values(),Rt(ri),ai,Tt);$t(a,h(this,ue).getValue())||h(this,ue).setValue(a)}))})}upsert(e){return h(this,ke).call(this,e)}delete(e){return d(Y(h(this,H).map(i=>i.delete(e))),Q(X))}get(e){for(const i of h(this,H)){const s=i.get(e);if(s)return s}}getAll(){return d(h(this,H),Rt(e=>e.getAll()))}setVisibility(e,i){return d(Y(h(this,H).map(s=>s.setVisibility(e,i))),Q(X))}removeHideAllReasons(e){return d(Y(h(this,H).map(i=>i.removeHideAllReasons(e))),Q(X))}addHideAllReasons(e){return d(Y(h(this,H).map(i=>i.addHideAllReasons(e))),Q(X))}focus(e,i){return d(h(this,H).map(s=>s.focus(e,i)),Y,Q(X))}async[Symbol.asyncDispose](){h(this,P).dispose()}}P=new WeakMap;H=new WeakMap;ke=new WeakMap;Me=new WeakMap;We=new WeakMap;Se=new WeakMap;Ce=new WeakMap;De=new WeakMap;Re=new WeakMap;Fe=new WeakMap;ue=new WeakMap;Ve=new WeakMap;var xi=Object.defineProperty,It=t=>{throw TypeError(t)},$i=(t,e,i)=>e in t?xi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,U=(t,e,i)=>$i(t,typeof e!="symbol"?e+"":e,i),mt=(t,e,i)=>e.has(t)||It("Cannot "+i),o=(t,e,i)=>(mt(t,e,"read from private field"),i?i.call(t):e.get(t)),M=(t,e,i)=>e.has(t)?It("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),pe=(t,e,i,s)=>(mt(t,e,"write to private field"),e.set(t,i),i),$=(t,e,i)=>(mt(t,e,"access private method"),i),Oi=(t,e,i,s)=>({set _(a){pe(t,e,a)},get _(){return o(t,e,s)}}),q,Z,g,C,ct,Ae,He,xe,$e,Oe,Le,ze,we,E,V,Nt,Pe,qt,G;class Li{constructor(e){M(this,V),M(this,q),M(this,Z,new AsyncDisposableStack),M(this,g,new Map),M(this,C,null),M(this,ct,0),M(this,Ae,new y),M(this,He,new y),M(this,xe,new y),M(this,$e,new y),M(this,Oe,new y),M(this,Le,new y),M(this,ze,new y),M(this,we,new ft(new Set)),U(this,"onPointerEnter",o(this,Ae)),U(this,"onPointerLeave",o(this,He)),U(this,"onPointerHoverChange",o(this,xe)),U(this,"onPointerDown",o(this,$e)),U(this,"onPointerUp",o(this,Oe)),U(this,"onPointerClick",o(this,Le)),U(this,"onFocusChange",o(this,ze)),U(this,"visibleOnscreenDecorations",o(this,we)),U(this,"id"),M(this,E);var i;this.id=(i=e.id)!=null?i:Lt(),pe(this,q,vt.createLogger("TextDecorationStore",e.label)),pe(this,E,e.decorationsWorker),o(this,Z).use(e.segmentPointerEvents.subscribe(s=>$(this,V,qt).call(this,s))),o(this,Z).use(e.visibleOnscreenDecorations.subscribe(s=>{const a=d(s,Ft(r=>{var l;return(l=o(this,g).get(r))==null?void 0:l.decoration}),oi(At),Tt);$t(a,o(this,we).getValue())||o(this,we).setValue(a)})),o(this,Z).defer(async()=>{e.onDispose(),await this.delete(o(this,g).keys()),o(this,g).clear()})}async upsert(e){var i;const s=o(this,g).get(e.id),a=e.segments.map(u=>({id:"".concat(e.id,"-").concat(Oi(this,ct)._++),range:u.range,updateSemantics:u.updateSemantics,interactive:u.interactive,underline:u.underline,background:u.background,metadata:u.metadata})),r=$(this,V,Nt).call(this,e.id,a),l=()=>{var u,L;return(L=(u=o(this,g).get(e.id))==null?void 0:u.visibility)!=null?L:"hidden"},w=()=>{var u;return d((u=o(this,g).get(e.id))==null?void 0:u.segments,L=>L?Array.from(L.values()):[])},k=()=>{var u;return(u=o(this,g).get(e.id))==null?void 0:u.metadata},b=(i=s==null?void 0:s.decoration)!=null?i:{id:e.id,get visibility(){return l()},get metadata(){return k()},get segments(){return w()},focus:u=>this.focus(e.id,u),show:()=>this.setVisibility([e.id],!0),hide:()=>this.setVisibility([e.id],!1),[Symbol.asyncDispose]:async()=>{await d(this.delete([e.id]),rt(ot(u=>o(this,q).error("Unexpected error while disposing decoration ".concat(b.id),u))))}};return o(this,g).set(e.id,{decoration:b,metadata:e.metadata,visibility:e.visibility,segments:new Map(r.map(u=>[u.id,u]))}),d(o(this,E).upsert({...e,segments:a,visibility:e.visibility==="focused"?"visible":e.visibility}),Q(()=>(o(this,q).verbose("Upserted decoration #".concat(b.id),b),b)),rt(ot(u=>{o(this,q).error("Failed to upsert decoration",u),o(this,q).verbose("Failed to upsert decoration ".concat(b.id),u),o(this,g).delete(e.id)})))}async delete(e){const i=Vt(e);for(const s of i)o(this,g).delete(s);return o(this,E).remove(i)}get(e){var i;return(i=o(this,g).get(e))==null?void 0:i.decoration}getAll(){return d(o(this,g).values(),Ft(e=>e.decoration))}setVisibility(e,i){var s,a;const r=Vt(e);let l=st();for(const w of r){const k=o(this,g).get(w);k&&(i?k.visibility=((s=o(this,C))==null?void 0:s.decoration.id)===w?"focused":"visible":(k.visibility="hidden",((a=o(this,C))==null?void 0:a.decoration.id)===w&&(l=this.focus(null))))}return d(Y([v(o(this,E).setVisibility(r,i)),l]),Q(X))}removeHideAllReasons(e){return o(this,E).removeHideAllReasons(e)}addHideAllReasons(e){return o(this,E).addHideAllReasons(e)}focus(e,i){var s,a,r;if(e){const l=o(this,g).get(e),w=i!==void 0?l==null?void 0:l.segments.get(i):void 0;return((s=o(this,C))==null?void 0:s.decoration.id)===e&&((a=o(this,C).segment)==null?void 0:a.id)===(w==null?void 0:w.id)?st():(((r=o(this,C))==null?void 0:r.decoration.id)!==e&&$(this,V,Pe).call(this,!1),pe(this,C,l?{decoration:l.decoration,segment:w}:null),$(this,V,Pe).call(this,!0),o(this,E).focus(e))}else return o(this,C)===null?st():($(this,V,Pe).call(this,!1),pe(this,C,null),o(this,E).focus(null))}async[Symbol.asyncDispose](){await o(this,Z).disposeAsync()}}q=new WeakMap;Z=new WeakMap;g=new WeakMap;C=new WeakMap;ct=new WeakMap;Ae=new WeakMap;He=new WeakMap;xe=new WeakMap;$e=new WeakMap;Oe=new WeakMap;Le=new WeakMap;ze=new WeakMap;we=new WeakMap;E=new WeakMap;V=new WeakSet;Nt=function(t,e){const i=new Map(e.map(s=>[s.id,{interactive:s.interactive,background:s.background,underline:s.underline,metadata:s.metadata}]));return e.map(s=>({id:s.id,get underline(){var a;return(a=i.get(s.id))==null?void 0:a.underline},get background(){var a;return(a=i.get(s.id))==null?void 0:a.background},get interactive(){var a,r;return(r=(a=i.get(s.id))==null?void 0:a.interactive)!=null?r:!1},get metadata(){var a,r;return(r=(a=i.get(s.id))==null?void 0:a.metadata)!=null?r:s.metadata},patch:({metadata:a,underline:r,background:l,interactive:w})=>(i.set(s.id,{interactive:w!=null?w:s.interactive,metadata:a!=null?a:s.metadata,underline:r===null?void 0:r!=null?r:s.underline,background:l===null?void 0:l!=null?l:s.background}),o(this,E).patchSegment(t,s.id,{underline:r,background:l,interactive:w}))}))};Pe=function(t){if(o(this,C)){const e=o(this,g).get(o(this,C).decoration.id);e&&(e.visibility=t?"focused":e.visibility==="focused"?"visible":e.visibility);const i=o(this,C).decoration,s=o(this,C).segment;o(this,ze).emit({decoration:i,segment:s,focused:t})}};qt=function(t){if(t.pointerEnter||t.pointerLeave){const e=$(this,V,G).call(this,t.pointerEnter),i=$(this,V,G).call(this,t.pointerLeave);o(this,xe).emit({pointerEnter:e,pointerLeave:i})}t.pointerDown&&$(this,V,G).call(this,t.pointerDown),t.pointerUp&&$(this,V,G).call(this,t.pointerUp),t.pointerClick&&$(this,V,G).call(this,t.pointerClick)};G=function(t){if(!t)return;const e=o(this,g).get(t.id),i=e==null?void 0:e.segments.get(t.segmentId);if(!e||!i)return;const s={kind:t.kind,segment:i,decoration:e.decoration,position:t.position,rect:t.rect,decorationRects:t.decorationRects};switch(t.kind){case"pointerEnter":o(this,Ae).emit(s);break;case"pointerLeave":o(this,He).emit(s);break;case"pointerDown":o(this,$e).emit(s);break;case"pointerUp":o(this,Oe).emit(s);break;case"pointerClick":o(this,Le).emit(s);break;default:throw new ci(t.kind)}return s};var zi=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),Ue=t=>{throw TypeError(t)},gt=(t,e,i)=>e.has(t)||Ue("Cannot "+i),n=(t,e,i)=>(gt(t,e,"read from private field"),i?i.call(t):e.get(t)),c=(t,e,i)=>e.has(t)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),f=(t,e,i,s)=>(gt(t,e,"write to private field"),e.set(t,i),i),R=(t,e,i)=>(gt(t,e,"access private method"),i),_t=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Ue("Object expected");var s;s===void 0&&(s=e[zi("dispose")]),typeof s!="function"&&Ue("Object not disposable"),t.push([i,s,e])}return e},bt=(t,e,i)=>{var s=typeof SuppressedError=="function"?SuppressedError:function(l,w,k,b){return b=Error(k),b.name="SuppressedError",b.error=l,b.suppressed=w,b},a=l=>e=i?new s(l,e,"An error was suppressed during disposal"):(i=!0,l),r=l=>{for(;l=t.pop();)try{var w=l[1]&&l[1].call(l[2]);if(l[0])return Promise.resolve(w).then(r,k=>(a(k),r()))}catch(k){a(k)}if(i)throw e};return r()},O,p,se,x,Ee,Ie,Qt,Ne,yt,kt,Bt,fe,je,_,et,lt,ht,dt,ut,pt,ne,ae,re,j,me,ee,ge,qe,Qe,Be,Je,Ke,Xe,Ye,Ze,ve,_e,te,oe,be,Ge,S,Jt,Kt,Xt,Mt,Yt,Zt,Gt,jt,ei,ti,ii,si;function Ui(t,e=1){return Number.isInteger(t)?t.toString():t.toFixed(e)}class Te{constructor(e,i,s,a){c(this,S),c(this,O),c(this,p,new AsyncDisposableStack),c(this,se),c(this,x,new Map),c(this,Ee),c(this,Ie,new y),c(this,Qt,new _i({capacity:100})),c(this,Ne,new ft(new Set)),c(this,yt,1e3/30),c(this,kt,1),c(this,Bt,new Set),c(this,fe,0),c(this,je,0),c(this,_,n(this,p).use(new Ei)),c(this,et,!1),c(this,lt,250),c(this,ht,250),c(this,dt,250),c(this,ut,250),c(this,pt,500),c(this,ne,le(()=>n(this,_).removeHideAllReasons(["documentScrolling"]),he(n(this,lt)))),c(this,ae,le(()=>n(this,_).removeHideAllReasons(["windowMoving"]),he(n(this,ht)))),c(this,re,le(()=>n(this,_).removeHideAllReasons(["windowResizing"]),he(n(this,dt)))),c(this,j,le(()=>n(this,_).removeHideAllReasons(["canvasResizing"]),he(n(this,ut)))),c(this,me,le(()=>n(this,_).removeHideAllReasons(["geometryUpdateLatencyTooHigh"]),he(n(this,pt)))),c(this,ee,null),c(this,ge),c(this,qe),c(this,Qe),c(this,Be),c(this,Je),c(this,Ke),c(this,Xe),c(this,Ye),c(this,Ze),c(this,ve,Promise.withResolvers()),c(this,_e),c(this,te),c(this,oe),c(this,be),c(this,Ge),f(this,Ge,a),f(this,be,a.duration("ready_to_render")),f(this,ge,i),f(this,_e,s),f(this,te,e.document),f(this,oe,e),f(this,O,vt.createLogger("TextDecorationManager",e.document.id));const{visibleTextRangeView:r,renderedDecorationCountView:l,visibleOnscreenDecorationCountView:w,visibleDecorationCountView:k,allDecorationCountView:b,interactiveRectCountView:u,rangesFetchedView:L,rectsFetchedView:tt,latencyView:N,latencyStatsView:Wt}=R(this,S,Kt).call(this,e.document,i);f(this,qe,r),f(this,Qe,l),f(this,Be,w),f(this,Je,k),f(this,Ke,b),f(this,Xe,u),f(this,Ze,L),f(this,Ye,tt),n(this,p).use(n(this,Ie).subscribe(I=>{N.push(I.value),Wt==null||Wt.push(I)})),f(this,se,R(this,S,Xt).call(this,n(this,ve).promise)),R(this,S,Jt).call(this,e.document),R(this,S,Gt).call(this),R(this,S,jt).call(this,e.document);const St=n(this,p).use(this.createStore());f(this,Ee,n(this,p).use(new Hi({children:[...n(this,x).values()].map(I=>I.store).concat(St),upsert:I=>St.upsert(I)}))),n(this,p).use(d(m.fromSubscribableState(e.document.hasFocus),m.filter(I=>!I),m.subscribe(()=>f(this,ee,null))))}setCanvas(e){n(this,ve).resolve(e)}createStore(e){const i=new DisposableStack,s=e!==void 0?n(this,x).get(e):void 0;if(s!=null&&s.store)return s.store;const a=new y,r=n(this,p).use(new Li({id:e,label:n(this,te).id,decorationsWorker:n(this,_),segmentPointerEvents:a,visibleOnscreenDecorations:n(this,Ne),onDispose:()=>i.dispose()}));return n(this,O).verbose("Created text decoration store",r),n(this,x).set(r.id,{store:r,segmentPointerEventEmitter:a}),i.defer(()=>{n(this,x).delete(r.id)}),i.use(r.onFocusChange.subscribe(l=>{l.focused&&n(this,x).forEach(w=>{w.store!==r&&w.store.focus(null)})})),n(this,p).use(i),r}getStore(e){return e?n(this,x).get(e):n(this,Ee)}async[Symbol.asyncDispose](){n(this,ne).cancel(),n(this,ae).cancel(),n(this,re).cancel(),n(this,me).cancel(),n(this,x).clear(),await n(this,p).disposeAsync()}}O=new WeakMap;p=new WeakMap;se=new WeakMap;x=new WeakMap;Ee=new WeakMap;Ie=new WeakMap;Qt=new WeakMap;Ne=new WeakMap;yt=new WeakMap;kt=new WeakMap;Bt=new WeakMap;fe=new WeakMap;je=new WeakMap;_=new WeakMap;et=new WeakMap;lt=new WeakMap;ht=new WeakMap;dt=new WeakMap;ut=new WeakMap;pt=new WeakMap;ne=new WeakMap;ae=new WeakMap;re=new WeakMap;j=new WeakMap;me=new WeakMap;ee=new WeakMap;ge=new WeakMap;qe=new WeakMap;Qe=new WeakMap;Be=new WeakMap;Je=new WeakMap;Ke=new WeakMap;Xe=new WeakMap;Ye=new WeakMap;Ze=new WeakMap;ve=new WeakMap;_e=new WeakMap;te=new WeakMap;oe=new WeakMap;be=new WeakMap;Ge=new WeakMap;S=new WeakSet;Jt=async function(t){const e=t.geometry.getValue().geometry;await Promise.all([R(this,S,Zt).call(this,t),e?R(this,S,Mt).call(this,e,n(this,se)):Promise.resolve()]),(await n(this,_)).removeHideAllReasons(["workerInitializing"])};Kt=function(t,e){const i=n(this,p).use(e.createValue({documentId:t.id,label:"Visible text range",stringify:N=>"[".concat(N.start,", ").concat(N.end,")")})),s="Decorations Metrics 📈",a=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"Latency",unit:"ms",getColorFor:N=>{if(!(N<1e3/60))return N<1e3/30?"warning-default":"critical-default"}})),r=void 0,l=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"All"})),w=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"Visible"})),k=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"Visible Onscreen"})),b=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"Just rendered"})),u=n(this,p).use(e.createValue({documentId:t.id,section:s,label:"Interactive rects"})),L=n(this,p).use(n(this,ge).createValue({documentId:t.id,section:s,label:"Ranges fetched"})),tt=n(this,p).use(n(this,ge).createValue({documentId:t.id,section:s,label:"Rects fetched"}));return{visibleTextRangeView:i,latencyView:a,latencyStatsView:r,renderedDecorationCountView:b,visibleOnscreenDecorationCountView:k,visibleDecorationCountView:w,allDecorationCountView:l,interactiveRectCountView:u,rangesFetchedView:L,rectsFetchedView:tt}};Xt=function(t){return t.then(e=>(B(e,"position","fixed"),B(e,"pointer-events","none"),B(e,"image-rendering","crisp-edges"),e))};Mt=async function(t,e){const i=n(this,_e).screenRect,s=ki({x:t.windowFrame.x+t.viewportFrame.x,y:t.windowFrame.y+t.viewportFrame.y,width:t.viewportFrame.width,height:t.viewportFrame.height});let a;if(at(i,s)?a=Promise.resolve():(n(this,O).verbose("Resizing window to ".concat(de(s))),a=R(this,S,Yt).call(this,s)),Pt(s)||Pt(t.documentFrame)){n(this,O).warn("Collapsed window ".concat(de(s)," or document frame ").concat(de(t.documentFrame)," - waiting for non-collapsed rects before resizing canvas")),n(this,j).cancel(),n(this,_).addHideAllReasons(["canvasResizing"]);return}if(n(this,ee)&&at(i,s)&&at(n(this,ee).documentFrame,t.documentFrame)){n(this,j).enqueue(),n(this,be).close(null,{durationInSeconds:(performance.now()-n(this,oe).lastFocusAt)/1e3});return}f(this,ee,t),n(this,j).cancel(),n(this,_).addHideAllReasons(["canvasResizing"]),n(this,O).verbose("Resizing canvas to ".concat(de(t.documentFrame)));try{await Promise.all([a,Ri.mutate(async()=>{const r=await e;B(r,"top","".concat(ye(t.documentFrame.y),"px")),B(r,"left","".concat(ye(t.documentFrame.x),"px")),B(r,"width","".concat(ye(t.documentFrame.width),"px")),B(r,"height","".concat(ye(t.documentFrame.height),"px"))})])}finally{n(this,j).enqueue()}n(this,be).close(null,{durationInSeconds:(performance.now()-n(this,oe).lastFocusAt)/1e3})};Yt=async function(t){await bi(d(n(this,_e).setScreenRect(t),rt(ot(e=>n(this,O).error("Failed to update window rect",e)))),{timeoutMs:1e3,defaultValue:void 0,onTimeout:()=>n(this,O).warn("Timeout updating window rect to ".concat(de(t)))})};Zt=async function(t){const e=new m.Subject;n(this,p).use(d(e,m.throttleTime(50),m.subscribe(a=>{n(this,Qe).push(a.decorationsRenderedOnLastRenderLoop),n(this,Be).push(a.renderedVisibleOnscreenDecorationCount),n(this,Je).push(a.visibleDecorationCount),n(this,Ke).push(a.allDecorationCount),n(this,Xe).push(a.interactiveRectCount),n(this,Ye).push(a.rectCount),n(this,Ze).push(a.rangeCount)})));const i=await n(this,se);let s=0;await n(this,_).init({documentId:t.id,canvas:i.transferControlToOffscreen(),devicePixelRatio:window.devicePixelRatio,documentGeometry:t.geometry.getValue().geometry,overSamplingFactor:n(this,kt),initialRevision:{text:Mi,geometry:Wi},initialHideAllReasons:["workerInitializing"],getRects:a=>t.getRects(a),getBoundingRects:a=>t.getBoundingRects(a),emitSegmentPointerEvents:a=>n(this,x).forEach(r=>r.segmentPointerEventEmitter.emit(a)),emitDecorationMetrics:a=>{if(a.decorationsRenderedOnLastRenderLoop>0){if(s===0){const{revision:r}=n(this,te).text.getValue();n(this,Ge).duration("first_decoration_render",{labels:{revision_history_info:r<=1?"initial":r<10?"early":"late"}}).close(null,{durationInSeconds:(performance.now()-n(this,oe).lastFocusAt)/1e3})}s++}e.next(a),i.dataset.allDecorations=a.allDecorationCount.toString(),i.dataset.visibleDecorations=a.visibleDecorationCount.toString(),i.dataset.visibleOnscreenDecorations=a.renderedVisibleOnscreenDecorationCount.toString()},emitVisibleOnscreenDecorationsChange:a=>n(this,Ne).setValue(a),emitHideAllReasons:a=>n(this,ve).promise.then(r=>{r.dataset.hideAllReasons=Array.from(a).join(" ")}),inspector:void 0}),f(this,et,!0)};Gt=function(){n(this,p).use(d(m.fromEvent(window,"pointermove"),m.map(t=>({kind:"pointerMove",position:nt({x:t.x,y:t.y})})),m.subscribe(t=>n(this,_).notifyPointerEvent(t)))),n(this,p).use(d(m.fromEvent(window,"pointerdown"),m.map(t=>({kind:"pointerDown",position:nt({x:t.x,y:t.y})})),m.subscribe(t=>n(this,_).notifyPointerEvent(t)))),n(this,p).use(d(m.fromEvent(window,"pointerup"),m.map(t=>({kind:"pointerUp",position:nt({x:t.x,y:t.y})})),m.subscribe(t=>n(this,_).notifyPointerEvent(t))))};jt=function(t){n(this,p).use(d(m.fromSubscribable(t.onTextDidChange),m.startWith(d(t.text.getValue(),e=>new gi({revision:e.revision,change:new yi({ops:e.content.ops})}))),m.concatMap(async e=>{var i=[];try{const r=_t(i,e.take());await n(this,_).notifyTextChanged({revision:r.value.revision,change:{ops:r.value.change.ops}})}catch(r){var s=r,a=!0}finally{bt(i,s,a)}}),m.subscribe())),n(this,p).use(d(m.fromSubscribableState(t.geometry),m.exhaustMapWithTrailing(e=>R(this,S,ei).call(this,e)),m.subscribe())),n(this,p).use(t.geometryWillChange.subscribe(e=>R(this,S,ti).call(this,e)))};ei=async function(t){var e=[];try{const a=_t(e,Ht.startSpan("TextDecorationManager.#handleGeometryChange()",{attributes:{documentGeometry:t}}));if(t.documentFrameScrolling?n(this,ne).cancel():n(this,ne).enqueue(),t.windowFrameMoving?n(this,ae).cancel():n(this,ae).enqueue(),t.windowFrameResizing?n(this,re).cancel():n(this,re).enqueue(),!n(this,te).hasFocus.getValue()||!t.geometry)return;n(this,qe).push(t.geometry.visibleTextRange),R(this,S,ii).call(this),await Promise.all([R(this,S,Mt).call(this,t.geometry,n(this,se)),n(this,_).notifyDocumentGeometryChanged(t.geometry,window.devicePixelRatio)]),R(this,S,si).call(this)}catch(a){var i=a,s=!0}finally{bt(e,i,s)}};ti=function(t){var e=[];try{const a=_t(e,Ht.startSpan("TextDecorationManager.#notifyGeometryWillChange()",{attributes:{event:t}})),r=Si([t.documentFrameScrolling?"documentScrolling":null,t.windowFrameResizing?"windowMoving":null,t.windowFrameResizing?"windowResizing":null,n(this,je)>n(this,yt)?"geometryUpdateLatencyTooHigh":null].filter(At));r&&(r.includes("documentScrolling")&&n(this,ne).cancel(),r.includes("windowMoving")&&n(this,ae).cancel(),r.includes("windowResizing")&&n(this,re).cancel(),r.includes("geometryUpdateLatencyTooHigh")&&(n(this,me).cancel(),n(this,me).enqueue()),n(this,_).addHideAllReasons(r))}catch(a){var i=a,s=!0}finally{bt(e,i,s)}};ii=function(){n(this,et)&&f(this,fe,performance.now())};si=function(){if(n(this,fe)===0)return;const t=performance.now()-n(this,fe);f(this,je,t),n(this,Ie).emit({min:NaN,max:NaN,mean:NaN,value:t}),n(this,O).verbose("decorations updated in ".concat(Ui(t),"ms"))};const Ii=ui(Symbol("TextDecorationManager")),ns=t=>d(xt([t.getExecutionScope("document-session"),t.getFeature("document-session"),t.getFeature("document-session-ui"),t.getFeature("performance-hud"),t.getFeature("monitoring")]),li(([e,i,s,a,r])=>pi.all([e.register({token:Te,useFactory:Ci(Te,[i.provides.DocumentSession,a.provides.HUD,wi,r.provides.Monitoring])},{lifetime:vi.ContainerScoped}),e.register({token:Ii,useToken:Te}),hi(e.onStart(async l=>Ni(l,s)))])));function Ni(t,e){return d(xt([t.resolve(e.provides.DocumentSessionViewContainer),t.resolve(Te)]),di(([i,s])=>i.add(()=>fi.createElement("canvas",{ref:a=>a&&s.setCanvas(a),"data-document-id":t.api.document.id,"data-connector-id":t.api.document.connectorId}),{slot:"decorations"})))}export{Ii as TextDecorationManagerToken,ns as activate};
//# sourceMappingURL=index-DSmRTZ3R.js.map
