import{a0 as _,w as L,b as w,M as A,D as J,E as N,L as Q,s as U,F as $,y as q,Q as z,e as G}from"./index-D8eA2Snd.js";import{T as O}from"./TextRevisionSynchronizedQueue-B1Rn9G-BX2te2S9.js";import{c as I}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{c as x,R as B,L as P}from"./index-BUrsDwB9.js";import{d as H}from"./defineFactory-En4T0P-BKA6DmWp.js";import"./Emitter-B4Dl_G-CoLDBUlE.js";var K=Object.defineProperty,y=t=>{throw TypeError(t)},V=(t,e,i)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,M=(t,e,i)=>V(t,typeof e!="symbol"?e+"":e,i),k=(t,e,i)=>e.has(t)||y("Cannot "+i),s=(t,e,i)=>(k(t,e,"read from private field"),i?i.call(t):e.get(t)),c=(t,e,i)=>e.has(t)?y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),b=(t,e,i,r)=>(k(t,e,"write to private field"),e.set(t,i),i),S=(t,e,i)=>(k(t,e,"access private method"),i),p,l,a,m,u,f,v,d,h,R,E,T,W;class X{constructor(e,i){c(this,h),c(this,p),c(this,l,new DisposableStack),c(this,a,new Map),c(this,m,new _.Subject),c(this,u,new _.Subject),c(this,f),c(this,v,new O),c(this,d,null),M(this,"onSuggestionUpserted",_.toSubscribable(s(this,m))),M(this,"onSuggestionRemoved",_.toSubscribable(s(this,u))),b(this,f,e),b(this,p,L.createLogger("CAPISuggestionProvider",e.id)),s(this,l).use(i.status.subscribe(r=>{if(r.kind==="connected"&&b(this,d,r.sessionId),r.kind==="connected"&&r.isNewSession){const o=w(s(this,a).entries(),N(([n,{sessionId:g}])=>g!==r.sessionId),J(([n])=>n),A);s(this,u).next(o),o.forEach(n=>s(this,a).delete(n)),s(this,p).verbose("Reset alert collection for document ".concat(s(this,f).id," and session ID ").concat(r.sessionId))}})),s(this,l).use(s(this,v).messages.subscribe(r=>S(this,h,R).call(this,r))),s(this,l).use(i.onEvent.subscribe(r=>s(this,v).enqueue(r,"rev"in r?I(r.rev):void 0))),s(this,l).use(e.text.subscribe(({revision:r})=>s(this,v).pushNewTextRevision(r))),s(this,l).defer(()=>{s(this,u).next(A(s(this,a).keys())),s(this,a).clear(),s(this,p).verbose("Clear alert collection for document ".concat(s(this,f).id))})}[Symbol.dispose](){s(this,l).dispose()}}p=new WeakMap;l=new WeakMap;a=new WeakMap;m=new WeakMap;u=new WeakMap;f=new WeakMap;v=new WeakMap;d=new WeakMap;h=new WeakSet;R=function(t){switch(t.action){case"alert":return S(this,h,E).call(this,t);case"alert_changes":return S(this,h,T).call(this,t);case"remove":return S(this,h,W).call(this,t);default:return}};E=function({action:t,...e}){if(s(this,d)===null)return;const i=String(e.id),r={id:i,kind:"capi",revision:I(e.rev),transforms:C(e),alert:e};s(this,a).set(i,{alert:e,sessionId:s(this,d)}),s(this,m).next([r])};T=function({action:t,...e}){var i;if(s(this,d)===null)return;const r=String(e.id),{alert:o}=(i=s(this,a).get(r))!=null?i:{};if(!o)return;const n={...o,...e},g={id:r,kind:"capi",revision:I(e.rev),transforms:C(e),alert:n};s(this,a).set(r,{alert:n,sessionId:s(this,d)}),s(this,m).next([g])};W=function(t){const e=String(t.id);s(this,a).delete(e),s(this,u).next([e])};function C(t){if(t.transformJson){const e=t.transformJson.context;return[{context:{start:e.s,end:e.e},alternatives:t.transformJson.alternatives}]}else return t.subalerts?t.subalerts.flatMap(C):[]}const D=x(Symbol("CAPISuggestionProvider")),Y=x(Symbol("CAPISuggestionCollection")),ne=t=>w(z([t.getExecutionScope("document-session"),t.getFeature("document-session"),t.getFeature("suggestion"),t.getFeature("capi")]),Q(([e,i,r,o])=>B.all([...Z(e,i,o,r),U(e.onStart(n=>w($([n.resolve(r.provides.SuggestionManager),n.resolve(D)]),q(([g,F])=>g.register(F)))))])));function Z(t,e,i,r){return[t.register({token:D,useFactory:H(X,[e.provides.TextDocument,i.provides.CAPIConnection])},{lifetime:P.ContainerScoped}),t.register({token:Y,useFactory:o=>w(o.resolve(r.provides.SuggestionManager),G(n=>n.getCollection("capi")))},{lifetime:P.ContainerScoped})]}export{Y as CAPISuggestionCollectionToken,D as CAPISuggestionProviderToken,ne as activate};
//# sourceMappingURL=index-DCn8g2bz.js.map
