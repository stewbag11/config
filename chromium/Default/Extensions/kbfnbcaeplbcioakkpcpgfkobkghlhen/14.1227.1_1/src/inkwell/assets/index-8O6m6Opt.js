import{a0 as s,b as v,M as P,D as $,w as A,x as L,K as O,L as R,s as V,Q as k,e as B,B as G}from"./index-D8eA2Snd.js";import{R as N,L as x}from"./index-BUrsDwB9.js";import{d as M}from"./defineFactory-En4T0P-BKA6DmWp.js";var z=Object.defineProperty,E=e=>{throw TypeError(e)},K=(e,t,i)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Q=(e,t,i)=>K(e,t+"",i),U=(e,t,i)=>t.has(e)||E("Cannot "+i),o=(e,t,i)=>(U(e,t,"read from private field"),i?i.call(e):t.get(e)),w=(e,t,i)=>t.has(e)?E("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),f,n,g;class S{constructor(t,i){w(this,f,new DisposableStack),w(this,n,new Map),w(this,g,new s.Subject),Q(this,"visibilityChanges",s.toSubscribable(s.concat(s.defer(()=>o(this,n).size>0?s.of({partial:!1,changes:v(o(this,n).entries(),$(([a,r])=>({id:{kind:"suggestion",suggestionId:a},visibility:r})),P)}):s.EMPTY),o(this,g)))),o(this,f).use(v(s.fromSubscribable(i.onSetTextDecorationVisibility(t.id)),s.map(a=>({partial:a.partial,changes:a.changes.map(r=>({id:{kind:"suggestion",suggestionId:r.alertId},visibility:r.visibility}))})),s.tap(a=>{a.partial||o(this,n).clear(),a.changes.forEach(r=>{r.visibility==="hidden"?o(this,n).delete(r.id.suggestionId):o(this,n).set(r.id.suggestionId,r.visibility)})}),s.subscribe(o(this,g))))}[Symbol.dispose](){o(this,f).dispose()}}f=new WeakMap;n=new WeakMap;g=new WeakMap;var Y=Object.defineProperty,F=e=>{throw TypeError(e)},H=(e,t,i)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,J=(e,t,i)=>H(e,t+"",i),W=(e,t,i)=>t.has(e)||F("Cannot "+i),p=(e,t,i)=>(W(e,t,"read from private field"),i?i.call(e):t.get(e)),u=(e,t,i)=>t.has(e)?F("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),m=(e,t,i,a)=>(W(e,t,"write to private field"),t.set(e,i),i),_,y,D,b;class I{constructor(t,i,a){u(this,_),u(this,y),u(this,D),u(this,b,A.createLogger("ConnectorTextDecorationInteractionObserver")),J(this,"onTextDecorationInteraction",({kind:r,suggestionId:h,position:c,rect:C,decorationRects:T})=>{if(h===void 0)return;const d=p(this,y).getById(h);if(!d)return p(this,b).error("Failed to find suggestion by id");v(p(this,D).notifyTextDecorationInteraction({documentID:p(this,_).id,interactionType:r,alertId:String(d.alert.id),position:c,rect:C,decorationRects:T}),L(O(l=>p(this,b).error("Failed to send notifyTextDecorationInteraction",l))))}),m(this,_,t),m(this,y,i),m(this,D,a)}}_=new WeakMap;y=new WeakMap;D=new WeakMap;b=new WeakMap;const ee=e=>v(k([e.getExecutionScope("document-session"),e.getFeature("document-session"),e.getFeature("capi-suggestion"),e.getFeature("inline-decorations"),e.getFeature("connector")]),R(([t,i,a,r,h])=>N.all([...X(t,i,a,h),V(t.onStart(c=>v(k([c.resolve(S),c.resolve(I),c.resolve(r.provides.TextDecorationController)]),B(([C,T,d])=>{const l=new DisposableStack;return l.use(d.addVisibilitySource(C.visibilityChanges)),l.use(d.onUnhandledTextDecorationInteraction(T.onTextDecorationInteraction)),l}),G)))])));function X(e,t,i,a){return[e.register({token:S,useFactory:M(S,[t.provides.TextDocument,a.provides.ConnectorTextDecoration])},{lifetime:x.ContainerScoped}),e.register({token:I,useFactory:M(I,[t.provides.TextDocument,i.provides.CAPISuggestionCollection,a.provides.ConnectorTextDecoration])},{lifetime:x.ContainerScoped})]}export{ee as activate};
//# sourceMappingURL=index-8O6m6Opt.js.map
