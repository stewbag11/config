var xt=(n,e)=>(e=Symbol[n])?e:Symbol.for("Symbol."+n),Oe=n=>{throw TypeError(n)};var mt=(n,e,t)=>e.has(n)||Oe("Cannot "+t);var p=(n,e,t)=>(mt(n,e,"read from private field"),t?t.call(n):e.get(n)),P=(n,e,t)=>e.has(n)?Oe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),b=(n,e,t,s)=>(mt(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),V=(n,e,t)=>(mt(n,e,"access private method"),t);var It=(n,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Oe("Object expected");var s;t&&(s=e[xt("asyncDispose")]),s===void 0&&(s=e[xt("dispose")]),typeof s!="function"&&Oe("Object not disposable"),n.push([t,s,e])}else t&&n.push([t]);return e},kt=(n,e,t)=>{var s=typeof SuppressedError=="function"?SuppressedError:function(i,c,u,g){return g=Error(u),g.name="SuppressedError",g.error=i,g.suppressed=c,g},a=i=>e=t?new s(i,e,"An error was suppressed during disposal"):(t=!0,i),h=i=>{for(;i=n.pop();)try{var c=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(c).then(h,u=>(a(u),h()))}catch(u){a(u)}if(t)throw e};return h()};import{w as H,c as st,G as ln,J as Z,b as l,a0 as r,I as hn,x as dn,K as un,C as ut,y as Ae,D as Mt,a6 as pn,$ as mn,s as N,f as te,u as ee,e as E,r as gn,L as $t,q as fn,B as Et,Q as pt,Y as vn,a7 as Dn,o as _n}from"./index-D8eA2Snd.js";import{T as wn}from"./TextRevisionSynchronizedQueue-B1Rn9G-BX2te2S9.js";import{E as Me}from"./Emitter-B4Dl_G-CoLDBUlE.js";import{g as Sn,a as Ft,c as ne,R as Cn,L as T,D as yn}from"./index-BUrsDwB9.js";import{D as Pt}from"./Delta-Bv7tGR-CQrdco4K.js";import{a as de,m as ue,u as bn,g as xn}from"./RectFns-D2VKzQ-B5TdcvOe.js";import{c as Ot,m as At}from"./PointFns-CVDzed-C40BfvWp.js";import{c as In}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{d as L}from"./defineFactory-En4T0P-BKA6DmWp.js";import{C as kn}from"./CAPIProvider-Bo9ptg-CMo3PDFX.js";import{R as Mn}from"./RandomSampler-Ba-P26-DyiLAlld.js";var me,I,Te;class Gt{constructor(){P(this,me,[]);P(this,I,null);P(this,Te,!1)}emit(e){p(this,I)?p(this,I).next(e):p(this,me).push(e)}subscribe(e){var s=[];try{if(p(this,Te))return H.warn("Cannot subscribe to closed SingleConsumerBufferedEmitter"),st(()=>{});if(p(this,I))return H.error("SingleConsumerBufferedEmitter supports only one subscriber."),st(()=>{});const t=It(s,new DisposableStack);b(this,I,ln(e));t.defer(()=>b(this,I,null));p(this,me).forEach(c=>{var u;return(u=p(this,I))==null?void 0:u.next(c)});p(this,me).length=0;return t.move()}catch(a){var h=a,i=!0}finally{kt(s,h,i)}}[Symbol.dispose](){var e;(e=p(this,I))==null||e.complete(),b(this,I,null),b(this,Te,!0)}}me=new WeakMap,I=new WeakMap,Te=new WeakMap;var Nt=n=>{throw TypeError(n)},yt=(n,e,t)=>e.has(n)||Nt("Cannot "+t),x=(n,e,t)=>(yt(n,e,"read from private field"),t?t.call(n):e.get(n)),Ge=(n,e,t)=>e.has(n)?Nt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Rn=(n,e,t,s)=>(yt(n,e,"write to private field"),e.set(n,t),t),Rt=(n,e,t)=>(yt(n,e,"access private method"),t),ve,K,ie,Be,_t;class Ue{constructor(e,t){Ge(this,Be),Ge(this,ve),Ge(this,K,new Map),Ge(this,ie,new DisposableStack),Rn(this,ve,e),x(this,ie).use(x(this,ve).onMessage.subscribe(s=>Rt(this,Be,_t).call(this,s.message).emit(s))),x(this,ie).use(t.onDocumentWillDestroy.subscribe(s=>{Z(x(this,K).get(s.id)),x(this,K).delete(s.id)})),x(this,ie).defer(()=>{Z(x(this,K).values()),x(this,K).clear()})}create(e){return{onMessage:Rt(this,Be,_t).call(this,{documentID:e}),send:t=>x(this,ve).send({...t,documentID:e})}}[Symbol.dispose](){x(this,ie).dispose()}}ve=new WeakMap;K=new WeakMap;ie=new WeakMap;Be=new WeakSet;_t=function(n){const e=n.documentID;let t=x(this,K).get(e);return t||(t=new Gt,x(this,K).set(e,t)),t};var Vt=n=>{throw TypeError(n)},Bt=(n,e,t)=>e.has(n)||Vt("Cannot "+t),O=(n,e,t)=>(Bt(n,e,"read from private field"),t?t.call(n):e.get(n)),Ne=(n,e,t)=>e.has(n)?Vt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),se=(n,e,t,s)=>(Bt(n,e,"write to private field"),e.set(n,t),t),De,oe,J,_e;class Tn{constructor(e,t){Ne(this,De),Ne(this,oe),Ne(this,J,null),Ne(this,_e,null),se(this,oe,e),se(this,De,t)}[Symbol.dispose](){Z(O(this,_e))}async create(e){Z(O(this,_e));let t=O(this,J);const s=H.createLogger("CAPITransport",O(this,oe)),a=O(this,oe),h=new Map,i=new wn,c=new Gt,u=new Me,g=new Me,F=Promise.withResolvers(),Ee=new DisposableStack;t!==null&&F.resolve(t);const Fe=O(this,De).onMessage.subscribe(m=>{if(Ee.disposed)return H.warn("Received a message after the transport was disposed.");switch(m.kind){case"connected":se(this,J,m.message.sessionID),t===null?(t=m.message.sessionID,s.verbose("Connected to session ".concat(t)),F.resolve(t)):t!==m.message.sessionID&&(s.warn("Received a 'connected' message for session \"".concat(m.message.sessionID,'" while already connected with the session ').concat(t,".")),Z(Fe),u.emit({webSocket:void 0}));break;case"disconnected":O(this,J)===m.message.sessionID&&se(this,J,null),t===m.message.sessionID?(F.reject(new Wn(t)),s.verbose("Disconnected from session ".concat(t)),t=null,Z(Fe),u.emit({webSocket:void 0})):t!==null?s.warn("Received a 'disconnected' message for session \"".concat(m.message.sessionID,'" while connected with the session "').concat(t,'".')):s.warn("Received a 'disconnected' message for session \"".concat(m.message.sessionID,'" while not connected.'));break;case"messageReceived":{const f=m.message.message;t===null?(t=m.message.sessionID,s.verbose("Connected to session ".concat(t)),se(this,J,t),F.resolve(t),s.warn("Received a '".concat(f.action,"' message before 'connected' message. Assuming CAPI is connected with the session \"").concat(t,'".')),i.enqueue(f,"rev"in f?f.rev:void 0)):t===m.message.sessionID?i.enqueue(f,"rev"in f?f.rev:void 0):s.warn("Received a '".concat(f.action,"' message for session \"").concat(m.message.sessionID,'" while connected with the session "').concat(t,'".'));break}case"textRevision":{const{capiRevision:f,documentRevision:Pe}=m.message;t===m.message.sessionID?(s.verbose("Received text revision:",m.message),h.set(f,Pe),i.pushNewTextRevision(f)):s.warn("Received a text revision (capi ".concat(f," -> ").concat(Pe,') for session "').concat(m.message.sessionID,'" while connected with the session "').concat(t,'".'));break}}});return Ee.use(Fe),se(this,_e,Fe),Ee.use(l(r.fromSubscribable(i.messages),r.subscribe(m=>{if("rev"in m){const f=h.get(m.rev);f===void 0?s.warn("Received a message (".concat(m.action,") with unknown revision ").concat(m.rev)):Reflect.set(m,"rev",f)}c.emit(m)}))),hn(async()=>({sessionId:await F.promise,send:f=>{t===null?(s.warn("Attempt to send a message without a sessionID"),s.verbose("Message:",f)):l(O(this,De).send({documentID:a,sessionID:t,message:f}),dn(un(Pe=>{s.error("Failed to send a message",Pe),s.verbose("Message:",f)})))},onDidClose:u,onDidError:g,onDidReceive:c,[Symbol.dispose](){Ee.dispose()}}))}toString(){return"PerDocumentTransportFactory(".concat(O(this,oe),")")}}De=new WeakMap;oe=new WeakMap;J=new WeakMap;_e=new WeakMap;class Wn extends ut{constructor(e){super("CAPI Transport disconnected (SessionId: ".concat(e,")"))}}var We,k,M,R,W,we,Le;class $n{constructor(e){P(this,W);P(this,We);P(this,k,new Map);P(this,M,null);P(this,R,null);b(this,We,e.capacity)}get(e){const t=p(this,k).get(e);if(t)return V(this,W,we).call(this,t),V(this,W,Le).call(this,t),t.value}set(e,t){const s=p(this,k).get(e);if(s)s.value=t,V(this,W,we).call(this,s),V(this,W,Le).call(this,s);else{p(this,k).size>=p(this,We)&&p(this,R)&&(p(this,k).delete(p(this,R).key),V(this,W,we).call(this,p(this,R)));const a={key:e,value:t,prev:null,next:null};V(this,W,Le).call(this,a),p(this,k).set(e,a)}}delete(e){const t=p(this,k).get(e);t&&(V(this,W,we).call(this,t),p(this,k).delete(e))}clear(){p(this,k).clear(),b(this,M,null),b(this,R,null)}}We=new WeakMap,k=new WeakMap,M=new WeakMap,R=new WeakMap,W=new WeakSet,we=function(e){e===p(this,M)&&b(this,M,e.next),e===p(this,R)&&b(this,R,e.prev),e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev=null,e.next=null},Le=function(e){p(this,M)&&(p(this,M).prev=e),e.prev=null,e.next=p(this,M),b(this,M,e),p(this,R)===null&&b(this,R,p(this,M))};var En=Object.defineProperty,Ut=n=>{throw TypeError(n)},Fn=(n,e,t)=>e in n?En(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,B=(n,e,t)=>Fn(n,typeof e!="symbol"?e+"":e,t),Lt=(n,e,t)=>e.has(n)||Ut("Cannot "+t),d=(n,e,t)=>(Lt(n,e,"read from private field"),t?t.call(n):e.get(n)),Se=(n,e,t)=>e.has(n)?Ut("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),gt=(n,e,t,s)=>(Lt(n,e,"write to private field"),e.set(n,t),t),Ke,U,re,D,z,ae;class Pn{constructor(e,t,s={}){Se(this,Ke,new DisposableStack),B(this,"id"),B(this,"connectorId"),B(this,"hasFocusState",new r.BehaviorSubject(!1)),B(this,"geometryWillChange",new r.Subject),B(this,"geometryDidChange",new r.Subject),B(this,"textDidChange",new r.Subject),B(this,"selectionDidChange",new r.Subject),B(this,"settings"),this.id=t,this.connectorId=e,this.settings=s,d(this,Ke).defer(()=>{this.hasFocusState.complete(),this.geometryDidChange.complete(),this.geometryWillChange.complete(),this.selectionDidChange.complete(),this.textDidChange.complete(),this.selectionDidChange.complete()})}get pixelKind(){var e;return(e=this.settings.pixelKind)!=null?e:"physical"}[Symbol.dispose](){d(this,Ke).dispose()}get hasFocus(){return r.toSubscribableState(this.hasFocusState)}get onGeometryWillChange(){return r.toSubscribable(this.geometryWillChange)}get onGeometryDidChange(){return r.toSubscribable(this.geometryDidChange)}get onTextDidChange(){return r.toSubscribable(this.textDidChange)}get onSelectionDidChange(){return r.toSubscribable(this.selectionDidChange)}}Ke=new WeakMap;class ft{constructor(e,t){Se(this,z),Se(this,U),Se(this,re),Se(this,D),gt(this,re,H.createLogger("RemoteDocument",e.id)),gt(this,D,e),gt(this,U,t)}get id(){return d(this,D).id}get connectorId(){return d(this,D).connectorId}get hasFocus(){return d(this,D).hasFocus}get pixelKind(){return d(this,D).pixelKind}get onGeometryWillChange(){return d(this,D).onGeometryWillChange}get onGeometryDidChange(){return d(this,D).onGeometryDidChange}get onTextDidChange(){return d(this,D).onTextDidChange}get onSelectionDidChange(){return d(this,D).onSelectionDidChange}[Symbol.dispose](){d(this,D)[Symbol.dispose]()}async getText(){return await l(d(this,U).execute("getDocumentText",{documentID:d(this,D).id}),Ae(e=>({revision:e.revision,content:new Pt(e.document.ops)})))}async setText(e){return await d(this,U).execute("applyDocumentTextChange",{documentID:d(this,D).id,revision:e.revision,changes:e.change})}async setSelection(e,t){return await d(this,U).execute("setDocumentSelectedTextRanges",{documentID:d(this,D).id,revision:e,ranges:t})}getGeometry(){return l(d(this,U).execute("getDocumentGeometry",{documentID:d(this,D).id}),Ae(e=>{var t;return{windowFrame:l(de(e.windowFrame),ue(d(this,z,ae))),viewportFrame:l(de(e.viewportFrame),ue(d(this,z,ae))),documentFrame:l(de(e.documentFrame),ue(d(this,z,ae))),visibleTextRange:(t=e.visibleTextRange)!=null?t:{start:0,end:1/0},scrollPosition:e.documentScrollOffset?l(Ot(e.documentScrollOffset),At(d(this,z,ae))):void 0}}))}getRectsForRanges(e,t){return t.size===0&&d(this,re).warn("getRectsForRanges() is called with an empty range map."),l(d(this,U).execute("getBoundingBoxesForTextRanges",{documentID:d(this,D).id,revision:e,ranges:Object.fromEntries(t)}),Ae(s=>({rects:new Map(l(t.keys(),Mt(a=>{const h=s.boundingBoxes[a];return h||d(this,re).warn("No bounding box found for range with id: ".concat(a)),[a,(h!=null?h:[]).map(i=>l(de(i),ue(d(this,z,ae))))]}))),textRevision:In(s.revision)})))}getBoundingRectForRanges(e,t){return t.size===0&&d(this,re).warn("getBoundingRectForRanges() is called with an empty range map."),l(this.getRectsForRanges(e,t),Ae(s=>({rects:new Map(l(s.rects.entries(),Mt(([a,h])=>[a,l(h,bn(xn()))]))),textRevision:s.textRevision})))}}U=new WeakMap;re=new WeakMap;D=new WeakMap;z=new WeakSet;ae=function(){return d(this,D).pixelKind==="physical"?On:pn};function On(n){return n/devicePixelRatio}var An=Object.defineProperty,Gn=(n,e)=>(e=Symbol[n])?e:Symbol.for("Symbol."+n),it=n=>{throw TypeError(n)},Nn=(n,e,t)=>e in n?An(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,X=(n,e,t)=>Nn(n,typeof e!="symbol"?e+"":e,t),bt=(n,e,t)=>e.has(n)||it("Cannot "+t),o=(n,e,t)=>(bt(n,e,"read from private field"),t?t.call(n):e.get(n)),_=(n,e,t)=>e.has(n)?it("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ge=(n,e,t,s)=>(bt(n,e,"write to private field"),e.set(n,t),t),y=(n,e,t)=>(bt(n,e,"access private method"),t),Vn=(n,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&it("Object expected");var s;s===void 0&&(s=e[Gn("dispose")]),typeof s!="function"&&it("Object not disposable"),n.push([t,s,e])}return e},Bn=(n,e,t)=>{var s=typeof SuppressedError=="function"?SuppressedError:function(i,c,u,g){return g=Error(u),g.name="SuppressedError",g.error=i,g.suppressed=c,g},a=i=>e=t?new s(i,e,"An error was suppressed during disposal"):(t=!0,i),h=i=>{for(;i=n.pop();)try{var c=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(c).then(h,u=>(a(u),h()))}catch(u){a(u)}if(t)throw e};return h()},pe,$,He,G,ot,rt,at,Je,Ce,ct,lt,C,w,Kt,Ht,Jt,zt,Yt,wt,Qt,$e,Xt,Y,ce;const Un="ca77b3794901e345f5f1a3c5872169ec06411679: O Grammarly, O Grammarly, wherefore art thou open devtools? Deny thy debugger and refuse thy console.log; Or, if thou wilt not, be but sworn my love, And I'll no longer be a developer.";class j{constructor(e,t){_(this,w),_(this,pe,H.createLogger("ConnectorDocumentManager")),_(this,$,new DisposableStack),_(this,He),_(this,G,new $n({capacity:10})),_(this,ot,o(this,$).use(new Me)),_(this,rt,o(this,$).use(new Me)),_(this,at,o(this,$).use(new Me)),_(this,Je,new Map),_(this,Ce,0),_(this,ct,o(this,$).use(new mn(null))),_(this,lt,new r.BehaviorSubject(null)),_(this,C,null),X(this,"onDocumentDidCreate",o(this,ot)),X(this,"onDocumentWillDestroy",o(this,rt)),X(this,"onDebugSignal",o(this,at)),X(this,"lastActiveDocumentConnectionId",o(this,ct)),X(this,"handler",{echo:i=>ee(i),cancel:()=>ee(),documentDidDestroy:async i=>y(this,w,Qt).call(this,i),documentDidFocus:(i,c)=>{var u;return y(this,w,wt).call(this,c.connectorId,i,(u=o(this,Je).get(c.connectorId))!=null?u:{})},documentGeometryDidChange:async(i,c)=>y(this,w,Yt).call(this,c.connectorId,i),documentSelectedTextRangesDidChange:async(i,c)=>y(this,w,zt).call(this,c.connectorId,i),documentTextDidChange:async(i,c)=>y(this,w,Jt).call(this,c.connectorId,i),documentGeometryWillChange:async(i,c)=>y(this,w,Ht).call(this,c.connectorId,i),handshake:async(i,c)=>{if(c&&o(this,Je).set(c.connectorId,i.options),i.protocolVersion!==o(this,Ce))return gn(new Ln({protocolVersion:i.protocolVersion,expectedProtocolVersion:o(this,Ce)}));const u=Sn(),g={client:u.name,version:u.version,protocolVersion:o(this,Ce),options:{nonce:await o(this,He).getNonce(),pixelKind:i.options.pixelKind}};return ee(g)}});var s=[];try{ge(this,He,e);const i=Vn(s,new DisposableStack);i.use(l(o(this,lt),r.map(c=>c&&c.documentId!==null?c.connectionId:null),r.switchMap(c=>c===null?r.EMPTY:l(r.fromSubscribable(t.connectionTimedOut(c,e.connectorTimeoutMs)),r.map(()=>c))),r.subscribe(c=>y(this,w,wt).call(this,c,null,{})))),o(this,$).defer(()=>o(this,G).clear()),o(this,$).use(i.move())}catch(i){var a=i,h=!0}finally{Bn(s,a,h)}}[Symbol.dispose](){o(this,$).dispose()}getRemoteDocument(e){const t=o(this,G).get(e);return t?N(t):te(new fe(e))}}pe=new WeakMap;$=new WeakMap;He=new WeakMap;G=new WeakMap;ot=new WeakMap;rt=new WeakMap;at=new WeakMap;Je=new WeakMap;Ce=new WeakMap;ct=new WeakMap;lt=new WeakMap;C=new WeakMap;w=new WeakSet;Kt=function(n){var e;((e=o(this,C))==null?void 0:e.id)===n&&ge(this,C,null);const t=o(this,G).get(n);return t?(o(this,G).delete(n),o(this,rt).emit(t),N()):te(new fe(n))};Ht=function(n,e){const t=y(this,w,$e).call(this,e.documentID);return t?(t.geometryWillChange.next(new Set(e.reasons)),N()):te(new fe(e.documentID))};Jt=function(n,e){const t=y(this,w,$e).call(this,e.documentID);if(!t)return te(new fe(e.documentID));const s=e.changes.ops.find(a=>"insert"in a&&typeof a.insert=="string");return s&&String(s.insert).includes(Un)&&o(this,at).emit(),t.textDidChange.next({revision:e.revision,change:new Pt(e.changes.ops)}),N()};zt=function(n,e){const t=y(this,w,$e).call(this,e.documentID);return t?(t.selectionDidChange.next(e.ranges),N()):te(new fe(e.documentID))};Yt=function(n,e){const t=y(this,w,$e).call(this,e.documentID);return t?(t.geometryDidChange.next(new Set(e.reasons)),N()):te(new fe(e.documentID))};wt=function(n,e,t){var s;const a=e?e.documentID:null;if(o(this,lt).next({connectionId:n,documentId:a}),a===null)return o(this,C)!==null&&(o(this,C).hasFocusState.next(!1),o(this,pe).verbose({context:o(this,C).id},"Document blurred"),ge(this,C,null)),ee();o(this,ct).setValue(n);const h=(s=o(this,G).get(a))!=null?s:y(this,w,Xt).call(this,n,a,t);return o(this,C)!==null&&h.id!==o(this,C).id&&(o(this,pe).verbose({context:o(this,C).id},"Document blurred"),o(this,C).hasFocusState.next(!1)),ge(this,C,h),h.hasFocusState.next(!0),o(this,pe).verbose({context:h.id},"Document focused"),ee()};Qt=function(n){return y(this,w,Kt).call(this,n.documentID)};$e=function(n){return o(this,G).get(n)};Xt=function(n,e,t){o(this,pe).verbose({context:e},"Document created");const s=o(this,$).use(new Pn(n,e,t));return o(this,G).set(e,s),queueMicrotask(()=>o(this,ot).emit(s)),s};class vt{constructor(e,t){_(this,Y),_(this,ce),ge(this,Y,e),ge(this,ce,t.createClient())}get onDebugSignal(){return o(this,Y).onDebugSignal}get onDocumentDidCreate(){return l(r.fromSubscribable(o(this,Y).onDocumentDidCreate),r.map(e=>new ft(e,o(this,ce))),r.toSubscribable)}get onDocumentWillDestroy(){return l(r.fromSubscribable(o(this,Y).onDocumentWillDestroy),r.map(e=>new ft(e,o(this,ce))),r.toSubscribable)}getRemoteDocument(e){return l(o(this,Y).getRemoteDocument(e),E(t=>new ft(t,o(this,ce))))}}Y=new WeakMap;ce=new WeakMap;class fe extends ut{constructor(e){super("Document not found"),this.documentId=e}toJSON(){return{...super.toJSON(),documentId:this.documentId}}}class Ln extends ut{constructor(e){super("Unsupported protocol version"),X(this,"protocolVersion"),X(this,"expectedProtocolVersion"),this.protocolVersion=e.protocolVersion,this.expectedProtocolVersion=e.expectedProtocolVersion}toJSON(){return{...super.toJSON(),protocolVersion:this.protocolVersion,expectedProtocolVersion:this.expectedProtocolVersion}}}var Zt=n=>{throw TypeError(n)},jt=(n,e,t)=>e.has(n)||Zt("Cannot "+t),Ve=(n,e,t)=>(jt(n,e,"read from private field"),t?t.call(n):e.get(n)),Tt=(n,e,t)=>e.has(n)?Zt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Kn=(n,e,t,s)=>(jt(n,e,"write to private field"),e.set(n,t),t),ye,ze;const Hn=4e3,Jn=1e3;class Re{constructor(e){Tt(this,ye),Tt(this,ze,new r.Subject),Kn(this,ye,e)}connectionTimedOut(e,t=Hn+Jn){return l(Ve(this,ze),r.filter(s=>s===e),r.debounceTime(t),r.map(()=>{}),r.take(1),r.toSubscribable)}onMessage(e){const t=(s,a)=>{e(s,a),Ve(this,ze).next(a.connectorId)};return Ve(this,ye).onMessage(t)}sendMessage(e){return Ve(this,ye).sendMessage(e)}}ye=new WeakMap;ze=new WeakMap;const zn=Ft(ne(Symbol("ConnectorMessageTransport"))),qt=Ft(ne(Symbol("ConnectorConfiguration")));var Yn=Object.defineProperty,en=n=>{throw TypeError(n)},Qn=(n,e,t)=>e in n?Yn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,St=(n,e,t)=>Qn(n,typeof e!="symbol"?e+"":e,t),tn=(n,e,t)=>e.has(n)||en("Cannot "+t),v=(n,e,t)=>(tn(n,e,"read from private field"),t?t.call(n):e.get(n)),le=(n,e,t)=>e.has(n)?en("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),nn=(n,e,t,s)=>(tn(n,e,"write to private field"),e.set(n,t),t),Ye,A,be,Ct,Q,Qe;class ht{constructor(e){le(this,Ye,new DisposableStack),le(this,A,new r.Subject),le(this,be,new Set),le(this,Ct,H.createLogger("ConnectorCAPI")),le(this,Q),St(this,"onMessage",r.toSubscribable(v(this,A))),St(this,"handler",{capiConnected:async t=>l(v(this,Q).getRemoteDocument(t.documentID),E(()=>{v(this,be).add(t.sessionID),v(this,A).next({kind:"connected",message:t})})),capiDisconnected:async t=>l(v(this,Q).getRemoteDocument(t.documentID),E(()=>{v(this,be).delete(t.sessionID),v(this,A).next({kind:"disconnected",message:t})})),capiMessageReceived:async t=>l(v(this,Q).getRemoteDocument(t.documentID),E(()=>v(this,A).next({kind:"messageReceived",message:t}))),capiAlertRemoved:async t=>l(v(this,Q).getRemoteDocument(t.documentID),$t(()=>v(this,be).has(t.sessionID)?N(v(this,A).next({kind:"messageReceived",message:{documentID:t.documentID,sessionID:t.sessionID,message:{id:parseInt(t.alertID),action:"remove"}}})):(v(this,Ct).warn("Received capiAlertRemoved for disconnected session ".concat(t.sessionID)),te(new Zn(t.sessionID))))),capiTextRevision:t=>ee(v(this,A).next({kind:"textRevision",message:t}))}),nn(this,Q,e),v(this,Ye).defer(()=>v(this,A).complete())}[Symbol.dispose](){v(this,Ye).dispose()}}Ye=new WeakMap;A=new WeakMap;be=new WeakMap;Ct=new WeakMap;Q=new WeakMap;class Xn{constructor(e,t){le(this,Qe),St(this,"onMessage"),this.onMessage=t.onMessage,nn(this,Qe,e.createClient())}send(e){return v(this,Qe).execute("sendCAPIMessage",e)}}Qe=new WeakMap;class Zn extends ut{constructor(e){super("Unknown CAPI session ID"),this.sessionId=e}toJSON(){return{...super.toJSON(),sessionId:this.sessionId}}}var sn=n=>{throw TypeError(n)},on=(n,e,t)=>e.has(n)||sn("Cannot "+t),jn=(n,e,t)=>(on(n,e,"read from private field"),t?t.call(n):e.get(n)),qn=(n,e,t)=>e.has(n)?sn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),es=(n,e,t,s)=>(on(n,e,"write to private field"),e.set(n,t),t),Xe;class ts{constructor(e){qn(this,Xe),es(this,Xe,e.createClient())}makeExperimentationRequest(e){return jn(this,Xe).execute("makeExperimentationRequest",e)}}Xe=new WeakMap;var ns=Object.defineProperty,rn=n=>{throw TypeError(n)},ss=(n,e,t)=>e in n?ns(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,is=(n,e,t)=>ss(n,e+"",t),an=(n,e,t)=>e.has(n)||rn("Cannot "+t),S=(n,e,t)=>(an(n,e,"read from private field"),t?t.call(n):e.get(n)),q=(n,e,t)=>e.has(n)?rn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Ze=(n,e,t,s)=>(an(n,e,"write to private field"),e.set(n,t),t),xe,Ie,je,he,qe,et,tt;class dt{constructor(e){q(this,xe,new DisposableStack),q(this,Ie,new r.Subject),q(this,je),q(this,he,new Map),is(this,"handlers",{setTextDecorationVisibility:async t=>l(S(this,je).getRemoteDocument(t.documentID),E(s=>{let a=S(this,he).get(s.id);a||(a=new Map,S(this,he).set(s.id,a)),t.partial||a.clear(),t.changes.forEach(h=>{h.visibility==="hidden"?a.delete(h.alertId):a.set(h.alertId,h)}),S(this,Ie).next(t)}))}),Ze(this,je,e),S(this,xe).use(e.onDocumentWillDestroy.subscribe(t=>{S(this,he).delete(t.id)})),S(this,xe).defer(()=>S(this,Ie).complete())}onSetTextDecorationVisibility(e){return l(r.concat(r.defer(()=>{var t;const s=(t=S(this,he).get(e))!=null?t:new Map;return s.size>0?r.of({documentId:e,partial:!1,changes:Array.from(s.values())}):r.EMPTY}),l(S(this,Ie),r.filter(t=>t.documentID===e))),r.toSubscribable)}[Symbol.dispose](){S(this,xe).dispose()}}xe=new WeakMap;Ie=new WeakMap;je=new WeakMap;he=new WeakMap;class os{constructor(e,t,s){q(this,qe),q(this,et),q(this,tt),Ze(this,qe,e.createClient()),Ze(this,et,t),Ze(this,tt,s)}onSetTextDecorationVisibility(e){return S(this,tt).onSetTextDecorationVisibility(e)}notifyTextDecorationInteraction(e){return l(S(this,et).getRemoteDocument(e.documentID),Et,fn(t=>S(this,qe).execute("handleTextDecorationInteraction",t.pixelKind==="logical"?e:{...e,position:l(Ot(e.position),At(Dt)),rect:l(de(e.rect),ue(Dt)),decorationRects:e.decorationRects.map(s=>l(de(s),ue(Dt)))})))}}qe=new WeakMap;et=new WeakMap;tt=new WeakMap;function Dt(n){return n*devicePixelRatio}const nt=ne(Symbol("ConnectorDocumentManager")),rs=ne(Symbol("ConnectorExperimentation")),Wt=ne(Symbol("ConnectorCAPI")),cn=ne(Symbol("ConnectorTextDecoration")),ke=ne(Symbol("RemoteFunctionManager")),bs=n=>l(pt([n.getExecutionScope("global"),n.getFeature("monitoring")]),$t(([e,t])=>Cn.all([...as(e),...cs(e,t),...ls(e),hs(e),ds(e,n)])));function as(n){return[n.register({token:j,useFactory:L(j,[qt,Re])},{lifetime:T.Singleton}),n.register({token:ht,useFactory:L(ht,[j])},{lifetime:T.Singleton}),n.register({token:dt,useFactory:L(dt,[j])},{lifetime:T.Singleton})]}function cs(n,e){return[n.register({token:Re,useFactory:t=>l(t.resolve(zn),E(s=>new Re(s)))},{lifetime:T.Singleton}),n.register({token:ke,useFactory:t=>l(pt([t.resolve(Re),t.resolve(j),t.resolve(ht),t.resolve(dt),t.resolve(e.provides.Monitoring)]),E(([s,a,h,i,c])=>{const u=new Mn({probability:.01});return new yn(s,{label:"RPC/Connector",handler:{...a.handler,...h.handler,...i.handlers},report:c&&u.shouldSelect()?g=>c.duration("".concat(g.kind,"_rpc_call"),{labels:{rpc_method_name:g.action}}).close(g.error,{durationInSeconds:g.durationInMs/1e3}):void 0})}))},{lifetime:T.Singleton})]}function ls(n){return[n.register({token:vt,useFactory:L(vt,[j,ke])},{lifetime:T.Singleton}),n.register({token:nt,useToken:vt}),n.register({token:rs,useFactory:L(ts,[ke])},{lifetime:T.Singleton}),n.register({token:Wt,useFactory:L(Xn,[ke,ht])},{lifetime:T.Singleton}),n.register({token:cn,useFactory:L(os,[ke,nt,dt])},{lifetime:T.Singleton}),n.register({token:Ue,useFactory:L(Ue,[Wt,nt])},{lifetime:T.Singleton}),n.register({token:kn,useFactory:e=>l(e.resolve(Ue),E(t=>({create:s=>new Tn(s,t.create(s))})))},{lifetime:T.Singleton})]}function hs(n){return N(n.onStart(e=>(pt([e.resolve(nt),e.resolve(cn),e.resolve(Ue)]),ee())))}function ds(n,e){return l(e.getFeature("performance-hud"),E(t=>n.onStart(s=>l(pt([s.resolve(t.provides.HUD),s.resolve(Re),s.resolve(j),s.resolve(qt)]),E(([a,h,i,c])=>{const u=a.createValue({label:"Connector"}),g=l(r.fromSubscribableState(i.lastActiveDocumentConnectionId),r.filter(Dn),r.switchMap(F=>l(r.fromSubscribable(h.connectionTimedOut(F,c.connectorTimeoutMs)),r.map(()=>"Inactive"),r.startWith("Active"))),r.subscribe(F=>u.push(F)));return st(()=>Z([g,u]))}),Et))),vn(t=>(H.error("Unexpected error using HUD in feature-connector",t),N(st(_n)))))}export{Wt as ConnectorCAPIToken,qt as ConnectorConfigurationToken,nt as ConnectorDocumentManagerToken,rs as ConnectorExperimentationToken,zn as ConnectorMessageTransportToken,cn as ConnectorTextDecorationToken,bs as activate};
//# sourceMappingURL=index-CYUG5bOA.js.map
