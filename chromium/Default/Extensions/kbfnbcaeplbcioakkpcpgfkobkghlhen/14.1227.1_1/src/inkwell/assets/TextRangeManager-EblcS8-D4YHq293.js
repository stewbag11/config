var vt=Object.defineProperty;var at=r=>{throw TypeError(r)};var Lt=(r,t,e)=>t in r?vt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var p=(r,t,e)=>Lt(r,typeof t!="symbol"?t+"":t,e),j=(r,t,e)=>t.has(r)||at("Cannot "+e);var h=(r,t,e)=>(j(r,t,"read from private field"),e?e.call(r):t.get(r)),m=(r,t,e)=>t.has(r)?at("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),D=(r,t,e,s)=>(j(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e),k=(r,t,e)=>(j(r,t,"access private method"),e);import{w as X,a1 as Bt,a7 as J,b as q,e as bt,M as H,E as U,D as V,s as nt,f as Ot,U as Tt,C as Ct}from"./index-D8eA2Snd.js";import{i as dt,a as ut,g as Z,b as kt,D as At,c as wt}from"./Delta-Bv7tGR-CQrdco4K.js";import{T as y}from"./TextRangeUpdateSemantics-D8MqPO-S_bbHJO0.js";import{c as pt}from"./TextRevisionFns-DnfI8a-DX1ABpMm.js";import{C as xt}from"./CircularBuffer-BES1B1-Nicfgaw3.js";function te(r,...t){return{start:Math.min(r.start,...t.map(e=>e.start)),end:Math.max(r.end,...t.map(e=>e.end))}}function ee(r,t){return!(t.start>r.end||t.end<r.start)}function re(r,t,e=[0,Number.MAX_SAFE_INTEGER]){return{start:Math.max(r.start-t,e[0]),end:Math.min(r.end+t,e[1])}}function se(r){return r.start===r.end}function ft(r){return"[".concat(r.start,", ").concat(r.end,")")}function rt(r,t){return(r&1<<t)!==0}function st(r,t){return r|1<<t}function it(r,t){return r&~(1<<t)}const o={Black:0,Red:1},S={Resize:0,Collapse:1},z=0,tt=1,et=2,A=-(1<<30),w=1<<30;function E(r){return rt(r.metadata,z)===!0?o.Red:o.Black}function c(r,t){t?r.metadata=st(r.metadata,z):r.metadata=it(r.metadata,z)}function g(r){return rt(r.metadata,tt)}function u(r,t){t?r.metadata=st(r.metadata,tt):r.metadata=it(r.metadata,tt)}function Et(r){return rt(r.metadata,et)===!0?S.Collapse:S.Resize}function Mt(r,t){t?r.metadata=st(r.metadata,et):r.metadata=it(r.metadata,et)}var ct,G,Nt;const R=class R{constructor(t,e,s,i){p(this,"metadata");p(this,"parent");p(this,"left");p(this,"right");p(this,"start");p(this,"end");p(this,"offset");p(this,"maxEnd");p(this,"cachedRevision");p(this,"cachedAbsoluteStart");p(this,"cachedAbsoluteEnd");p(this,"onBeforeEditOperation");this.metadata=0,this.onBeforeEditOperation=i,this.parent=this,this.left=this,this.right=this,c(this,o.Red),this.start=t,this.end=e,this.offset=0,this.maxEnd=e,Mt(this,s),this.cachedRevision=0,this.cachedAbsoluteStart=t,this.cachedAbsoluteEnd=e,u(this,!1)}reset(t,e,s){this.start=e,this.end=s,this.maxEnd=s,this.cachedRevision=t,this.cachedAbsoluteStart=e,this.cachedAbsoluteEnd=s}setCachedOffsets(t,e,s){this.cachedRevision=s,this.cachedAbsoluteStart=t,this.cachedAbsoluteEnd=e}detach(){this.parent=R.SENTINEL,this.left=R.SENTINEL,this.right=R.SENTINEL}};G=new WeakSet,Nt=function(){const t=new R(0,0,S.Resize);return t.parent=t,t.left=t,t.right=t,c(t,o.Black),t},m(R,G),p(R,"SENTINEL",k(ct=R,G,Nt).call(ct));let f=R;var x,gt,mt;class Dt{constructor(t=0){m(this,x);p(this,"root");p(this,"requestNormalizeOffsets");p(this,"revision");this.root=f.SENTINEL,this.revision=t,this.requestNormalizeOffsets=!1}intervalSearch(t,e){return this.root===f.SENTINEL?[]:Jt(this,t,e,this.revision)}getAllInOrder(){return this.root===f.SENTINEL?[]:Wt(this,this.revision)}insert(t){t.cachedRevision=this.revision,K(this,t),this.normalizeOffsetsIfNeeded()}delete(t){Q(this,t),this.normalizeOffsetsIfNeeded()}resolveNodeIfNeeded(t){if(t.cachedRevision!==this.revision){const e=t;let s=0;for(;t!==this.root;){if(t===f.SENTINEL)return X.warn("IntervalTree: Cannot resolve detached node");t===t.parent.right&&(s+=t.parent.offset),t=t.parent}const i=e.start+s,a=e.end+s;e.setCachedOffsets(i,a,this.revision)}}acceptEdit(t,e){const s=new Set;let i=0;t.ops.forEach(a=>{if(dt(a))i+=a.retain;else if(ut(a)){const n=k(this,x,gt).call(this,i,a);for(const d of n)s.add(d);i+=Z(a)}else if(kt(a)){const n=k(this,x,mt).call(this,i,a);for(const d of n)s.add(d)}}),this.revision=e;for(const a of s)this.resolveNodeIfNeeded(a);return[...s]}normalizeOffsetsIfNeeded(){this.requestNormalizeOffsets&&(this.requestNormalizeOffsets=!1,qt(this))}}x=new WeakSet,gt=function(t,e){var a;const s=typeof e.insert=="string"?e.insert:" ",i=lt(this,t,t);for(const n of i)(a=n.onBeforeEditOperation)==null||a.call(n,t,e);for(let n=0,d=i.length;n<d;n++){const l=i[n];Q(this,l)}this.normalizeOffsetsIfNeeded(),ht(this,t,t,s.length),this.normalizeOffsetsIfNeeded();for(let n=0,d=i.length;n<d;n++){const l=i[n];l.start=l.cachedAbsoluteStart,l.end=l.cachedAbsoluteEnd,$t(l,t,s),l.maxEnd=l.end,K(this,l)}return this.normalizeOffsetsIfNeeded(),i},mt=function(t,e){var a;const s=e.delete,i=lt(this,t,t+s);for(const n of i)(a=n.onBeforeEditOperation)==null||a.call(n,t,e);for(let n=0,d=i.length;n<d;n++){const l=i[n];Q(this,l)}this.normalizeOffsetsIfNeeded(),ht(this,t,t+s,0),this.normalizeOffsetsIfNeeded();for(let n=0,d=i.length;n<d;n++){const l=i[n];l.start=l.cachedAbsoluteStart,l.end=l.cachedAbsoluteEnd,Ft(l,t,s),l.maxEnd=l.end,K(this,l)}return this.normalizeOffsetsIfNeeded(),i};function qt(r){let t=r.root,e=0;for(;t!==f.SENTINEL;){if(t.left!==f.SENTINEL&&!g(t.left)){t=t.left;continue}if(t.right!==f.SENTINEL&&!g(t.right)){e+=t.offset,t=t.right;continue}t.start=e+t.start,t.end=e+t.end,t.offset=0,C(t),u(t,!0),u(t.left,!1),u(t.right,!1),t===t.parent.right&&(e-=t.parent.offset),t=t.parent}u(r.root,!1)}function ot(r){const t=r.charCodeAt(0);return t<48||t===58||t===59||t===63||t===8220||t===8221||t===8216||t===8217}function $t(r,t,e){const s=Et(r);if(!(t<r.start||t>r.end||e.length===0))if(t===r.start){const i=ot(e.charAt(e.length-1));s===S.Collapse&&!i?r.start=r.end=t+e.length:(r.start+=e.length,r.end+=e.length)}else if(t===r.end){const i=ot(e.charAt(0));s===S.Collapse&&!i&&(r.end=r.start)}else s===S.Resize?r.end+=e.length:r.end=r.start}function Ft(r,t,e){const s=Et(r);if(!(t+e<r.start||t>r.end||e===0))if(t<=r.start&&r.end<=t+e)r.end=r.start;else if(t<=r.start&&t+e>r.start)if(s===S.Collapse)r.end=r.start=t;else{const i=t+e-r.start,a=r.end-r.start-i;r.end=t+a,r.start=t}else t<=r.end&&t+e>r.end?s===S.Collapse?r.end=r.start:r.end=t:t>=r.start&&t+e<=r.end?s===S.Collapse?r.end=r.start:r.end-=e:s===S.Collapse?r.end=r.start=t:(r.end-=e,r.start-=e)}function lt(r,t,e){let s=r.root,i=0,a=0,n=0,d=0;const l=[];let v=0;for(;s!==f.SENTINEL;){if(g(s)){u(s.left,!1),u(s.right,!1),s===s.parent.right&&(i-=s.parent.offset),s=s.parent;continue}if(!g(s.left)){if(a=i+s.maxEnd,a<t){u(s,!0);continue}if(s.left!==f.SENTINEL){s=s.left;continue}}if(n=i+s.start,n>e){u(s,!0);continue}if(d=i+s.end,d>=t&&(s.setCachedOffsets(n,d,0),l[v++]=s),u(s,!0),s.right!==f.SENTINEL&&!g(s.right)){i+=s.offset,s=s.right;continue}}return u(r.root,!1),l}function ht(r,t,e,s){let i=r.root,a=0,n=0,d=0;const l=s-(e-t);for(;i!==f.SENTINEL;){if(g(i)){u(i.left,!1),u(i.right,!1),i===i.parent.right&&(a-=i.parent.offset),C(i),i=i.parent;continue}if(!g(i.left)){if(n=a+i.maxEnd,n<t){u(i,!0);continue}if(i.left!==f.SENTINEL){i=i.left;continue}}if(d=a+i.start,d>e){i.start+=l,i.end+=l,i.offset+=l,(i.offset<A||i.offset>w)&&(r.requestNormalizeOffsets=!0),u(i,!0);continue}if(u(i,!0),i.right!==f.SENTINEL&&!g(i.right)){a+=i.offset,i=i.right;continue}}u(r.root,!1)}function Wt(r,t){let e=r.root,s=0,i=0,a=0;const n=[];for(;e!==f.SENTINEL;){if(g(e)){u(e.left,!1),u(e.right,!1),e===e.parent.right&&(s-=e.parent.offset),e=e.parent;continue}if(e.left!==f.SENTINEL&&!g(e.left)){e=e.left;continue}if(i=s+e.start,a=s+e.end,e.setCachedOffsets(i,a,t),n.push(e),u(e,!0),e.right!==f.SENTINEL&&!g(e.right)){s+=e.offset,e=e.right;continue}}return u(r.root,!1),n}function Jt(r,t,e,s){let i=r.root,a=0,n=0,d=0,l=0;const v=[];for(;i!==f.SENTINEL;){if(g(i)){u(i.left,!1),u(i.right,!1),i===i.parent.right&&(a-=i.parent.offset),i=i.parent;continue}if(!g(i.left)){if(n=a+i.maxEnd,n<t){u(i,!0);continue}if(i.left!==f.SENTINEL){i=i.left;continue}}if(d=a+i.start,d>e){u(i,!0);continue}if(l=a+i.end,l>=t&&(i.setCachedOffsets(d,l,s),v.push(i)),u(i,!0),i.right!==f.SENTINEL&&!g(i.right)){a+=i.offset,i=i.right;continue}}return u(r.root,!1),v}function K(r,t){if(r.root===f.SENTINEL)return t.parent=f.SENTINEL,t.left=f.SENTINEL,t.right=f.SENTINEL,c(t,o.Black),r.root=t,r.root;Ut(r,t),L(t.parent);let e=t;for(;e!==r.root&&E(e.parent)===o.Red;)if(e.parent===e.parent.parent.left){const s=e.parent.parent.right;E(s)===o.Red?(c(e.parent,o.Black),c(s,o.Black),c(e.parent.parent,o.Red),e=e.parent.parent):(e===e.parent.right&&(e=e.parent,$(r,e)),c(e.parent,o.Black),c(e.parent.parent,o.Red),F(r,e.parent.parent))}else{const s=e.parent.parent.left;E(s)===o.Red?(c(e.parent,o.Black),c(s,o.Black),c(e.parent.parent,o.Red),e=e.parent.parent):(e===e.parent.left&&(e=e.parent,F(r,e)),c(e.parent,o.Black),c(e.parent.parent,o.Red),$(r,e.parent.parent))}return c(r.root,o.Black),t}function Ut(r,t){let e=0,s=r.root;const i=t.start,a=t.end;for(;;)if(Xt(i,a,s.start+e,s.end+e)<0)if(s.left===f.SENTINEL){t.start-=e,t.end-=e,t.maxEnd-=e,s.left=t;break}else s=s.left;else if(s.right===f.SENTINEL){t.start-=e+s.offset,t.end-=e+s.offset,t.maxEnd-=e+s.offset,s.right=t;break}else e+=s.offset,s=s.right;t.parent=s,t.left=f.SENTINEL,t.right=f.SENTINEL,c(t,o.Red)}function Q(r,t){let e,s;if(t.left===f.SENTINEL?(e=t.right,s=t,e.offset+=t.offset,(e.offset<A||e.offset>w)&&(r.requestNormalizeOffsets=!0),e.start+=t.offset,e.end+=t.offset):t.right===f.SENTINEL?(e=t.left,s=t):(s=Vt(t.right),e=s.right,e.start+=s.offset,e.end+=s.offset,e.offset+=s.offset,(e.offset<A||e.offset>w)&&(r.requestNormalizeOffsets=!0),s.start+=t.offset,s.end+=t.offset,s.offset=t.offset,(s.offset<A||s.offset>w)&&(r.requestNormalizeOffsets=!0)),s===r.root){r.root=e,c(e,o.Black),t.detach(),Y(),C(e),r.root.parent=f.SENTINEL;return}const i=E(s)===o.Red;if(s===s.parent.left?s.parent.left=e:s.parent.right=e,s===t?e.parent=s.parent:(s.parent===t?e.parent=s:e.parent=s.parent,s.left=t.left,s.right=t.right,s.parent=t.parent,c(s,E(t)),t===r.root?r.root=s:t===t.parent.left?t.parent.left=s:t.parent.right=s,s.left!==f.SENTINEL&&(s.left.parent=s),s.right!==f.SENTINEL&&(s.right.parent=s)),t.detach(),i){L(e.parent),s!==t&&(L(s),L(s.parent)),Y();return}L(e),L(e.parent),s!==t&&(L(s),L(s.parent));let a;for(;e!==r.root&&E(e)===o.Black;)e===e.parent.left?(a=e.parent.right,E(a)===o.Red&&(c(a,o.Black),c(e.parent,o.Red),$(r,e.parent),a=e.parent.right),E(a.left)===o.Black&&E(a.right)===o.Black?(c(a,o.Red),e=e.parent):(E(a.right)===o.Black&&(c(a.left,o.Black),c(a,o.Red),F(r,a),a=e.parent.right),c(a,E(e.parent)),c(e.parent,o.Black),c(a.right,o.Black),$(r,e.parent),e=r.root)):(a=e.parent.left,E(a)===o.Red&&(c(a,o.Black),c(e.parent,o.Red),F(r,e.parent),a=e.parent.left),E(a.left)===o.Black&&E(a.right)===o.Black?(c(a,o.Red),e=e.parent):(E(a.left)===o.Black&&(c(a.right,o.Black),c(a,o.Red),$(r,a),a=e.parent.left),c(a,E(e.parent)),c(e.parent,o.Black),c(a.left,o.Black),F(r,e.parent),e=r.root));c(e,o.Black),Y()}function Vt(r){for(;r.left!==f.SENTINEL;)r=r.left;return r}function Y(){f.SENTINEL.parent=f.SENTINEL,f.SENTINEL.offset=0,f.SENTINEL.start=0,f.SENTINEL.end=0}function $(r,t){const e=t.right;e.offset+=t.offset,(e.offset<A||e.offset>w)&&(r.requestNormalizeOffsets=!0),e.start+=t.offset,e.end+=t.offset,t.right=e.left,e.left!==f.SENTINEL&&(e.left.parent=t),e.parent=t.parent,t.parent===f.SENTINEL?r.root=e:t===t.parent.left?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e,C(t),C(e)}function F(r,t){const e=t.left;t.offset-=e.offset,(t.offset<A||t.offset>w)&&(r.requestNormalizeOffsets=!0),t.start-=e.offset,t.end-=e.offset,t.left=e.right,e.right!==f.SENTINEL&&(e.right.parent=t),e.parent=t.parent,t.parent===f.SENTINEL?r.root=e:t===t.parent.right?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e,C(t),C(e)}function St(r){let t=r.end;if(r.left!==f.SENTINEL){const e=r.left.maxEnd;e>t&&(t=e)}if(r.right!==f.SENTINEL){const e=r.right.maxEnd+r.offset;e>t&&(t=e)}return t}function C(r){r.maxEnd=St(r)}function L(r){for(;r!==f.SENTINEL;){const t=St(r);if(r.maxEnd===t)return;r.maxEnd=t,r=r.parent}}function Xt(r,t,e,s){return r===e?t-s:r-e}var b,I,N,P,W,M,It,Rt;class ie{constructor(t){m(this,M);m(this,b);m(this,I,new Map);m(this,N);m(this,P,new Bt);m(this,W,new xt({capacity:1e3}));var e;D(this,b,X.createLogger((e=t.label)!=null?e:"TextRangeManager")),D(this,N,new Dt(t.initialTextRevision))}pushTextChange({change:t,revision:e}){h(this,W).push({change:new At(t),revision:e});const s=h(this,N).acceptEdit(t,e).map(d=>h(this,I).get(d)).filter(J),i=t.ops[0],a=i&&dt(i)?i.retain:0,n=()=>Pt(s,q(h(this,N).intervalSearch(a,Number.MAX_SAFE_INTEGER),V(d=>h(this,I).get(d)),U(J)));return h(this,b).verbose("pushTextChange",{change:t,revision:e,affectedRanges:s}),{affectedRanges:s,getChangedRanges:n}}add(t){return q(k(this,M,It).call(this,t,pt(h(this,N).revision)),bt(e=>{var a;const s=new f(e.start,e.end,_t(t.updateSemantics),t.onBeforeEditOperation);h(this,N).insert(s);const i=new Gt({id:(a=t.id)!=null?a:h(this,P).next(),node:s,intervalTree:h(this,N),metadata:t.metadata,onDispose:()=>{h(this,N).delete(s),h(this,I).delete(s)}});return h(this,I).set(s,i),i}))}getIntersecting(t){return q(h(this,N).intervalSearch(t.start,t.end),V(e=>h(this,I).get(e)),U(J),H)}getAllInOrder(){return q(h(this,N).getAllInOrder(),V(t=>h(this,I).get(t)),U(J),H)}[Symbol.dispose](){h(this,I).clear()}}b=new WeakMap,I=new WeakMap,N=new WeakMap,P=new WeakMap,W=new WeakMap,M=new WeakSet,It=function(t,e){const{range:s,revision:i,updateSemantics:a}=t;if(i===h(this,N).revision)return nt(s);const n=k(this,M,Rt).call(this,i),d=n.reduce((v,_)=>_.transformPosition(v),s.start),l=n.reduce((v,_)=>_.transformPosition(v,!0),s.end);return l-d<=0||l-d!==s.end-s.start&&a===y.Collapse?(h(this,b).warn("Collapsed range ".concat(ft(s)," after rebasing from ").concat(i," to ").concat(h(this,N).revision,". New range: ").concat(ft({start:d,end:l}))),h(this,b).verbose("Changes:",n),Ot(new jt({fromRevision:t.revision,toRevision:e,range:t.range,rebasedRange:{start:d,end:l},deltas:n}))):nt({start:d,end:l})},Rt=function(t){return q(h(this,W),U(e=>e.revision>t),V(e=>e.change),H)};var B,O,T;class Gt{constructor(t){m(this,B);m(this,O);m(this,T,new DisposableStack);p(this,"id");p(this,"metadata");this.id=t.id,D(this,B,t.node),D(this,O,t.intervalTree),this.metadata=t.metadata,h(this,T).defer(t.onDispose)}get start(){return h(this,T).disposed?(X.warn("Cannot access DefaultLiveTextRange.start after disposal"),NaN):(h(this,O).resolveNodeIfNeeded(h(this,B)),h(this,B).cachedAbsoluteStart)}get end(){return h(this,T).disposed?(X.warn("Cannot access DefaultLiveTextRange.end after disposal"),NaN):(h(this,O).resolveNodeIfNeeded(h(this,B)),h(this,B).cachedAbsoluteEnd)}get revision(){return pt(h(this,O).revision)}[Symbol.dispose](){h(this,T).dispose()}toJSON(){return{start:this.start,end:this.end,revision:this.revision,metadata:this.metadata}}}B=new WeakMap,O=new WeakMap,T=new WeakMap;function*Pt(r,t){const e=new Set(r);for(const s of r)yield s;for(const s of t){if(e.size>0&&e.has(s)){e.delete(s);continue}yield s}}function _t(r){if(r===y.Resize)return S.Resize;if(r===y.Collapse)return S.Collapse;throw new Tt(r)}class jt extends Ct{constructor(e){super("Failed to rebase range");p(this,"fromRevision");p(this,"toRevision");p(this,"deltas");p(this,"range");p(this,"rebasedRange");this.fromRevision=e.fromRevision,this.toRevision=e.toRevision,this.deltas=e.deltas,this.range=e.range,this.rebasedRange=e.rebasedRange}toJSON(){return{...super.toJSON(),fromRevision:this.fromRevision,toRevision:this.toRevision,range:this.range,rebasedRange:this.rebasedRange,deltas:this.deltas.map(Ht)}}}function Ht(r){return{ops:r.ops.map(t=>({[wt(t)]:ut(t)?"x".repeat(Z(t)):Z(t),...t.attributes?{attributes:{...t.attributes,..."link"in t.attributes?{link:"x"}:{}}}:{}}))}}export{ie as T,ee as a,se as i,ft as t,te as u,re as w};
//# sourceMappingURL=TextRangeManager-EblcS8-D4YHq293.js.map
