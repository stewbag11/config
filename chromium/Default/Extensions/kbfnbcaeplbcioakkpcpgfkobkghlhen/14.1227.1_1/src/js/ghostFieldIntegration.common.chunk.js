(self.webpackChunk=self.webpackChunk||[]).push([[748],{38877:(e,t,i)=>{i.r(t),i.d(t,{GhostFieldIntegration:()=>N});var s=i(90023),n=i(92346),r=i(61804),a=i(49144),h=i(55446),c=i(73863),o=i(10859),l=i(27628),_=i(65647),d=i(18615),g=i(58303),p=i(1607),u=i(52256),v=i(43636),b=i(25770),S=i(21171),x=i(98995),C=i(65258),k=i(79992),m=i(4603),f=i(66895),T=i(8923),y=i(11456),w=i(94353),D=i(75792),A=i(10846),E=i(27804),F=i(65485),P=i(21409),U=i(94525),B=i(80649),I=i(45493),O=i(71666),R=i(92292),M=i(68857),G=i(34770),z=i(81259),H=i(4798),q=i(62549);class N{constructor({doc:e,textField:t,domain:i,layout:n,createCheckingService:o,state:l,gnar:_,felog:d,textObserver:p,experimentClient:u,createTextRevisionManager:v=(e=>M.n.create(e)),originalTextField:S=t,textEventsTarget:x,customizations:k={},mapChange:m=s.yR,integrationName:T,fieldIntegrationStore:y}){this._initialSessionUUID=b.h.create(g.YP),this._disposables=[],this._checkingService=b.h.create(null),this._sduiBufferService=b.h.create(g.YP),this._publishedAckReceived=new a.X(!1),this._canDisposeCheckingService=new a.X(!1),this._canDisposeCheckingServicePromise=this._canDisposeCheckingService.pipe(h.h((e=>e)),c.q(1)).toPromise(),this._checkingStatus=b.h.create(P.H.idle),this._readyState=b.h.create(U.kQ.notReady),this._nativeSpellcheckEnabled=b.h.create(!1),this._generalScore=b.h.create(null),this._lowestGeneralScore=b.h.create(null),this._paragraphsCount=b.h.create(0),this._formattingSpansCount=b.h.create(0),this._requestAwaitService=new B.e,this._capiStartAckMessage=b.h.create(g.YP),this._isDisposed=!1,this._subs=[],this._domain=i,this._layout=n,this._createCheckingService=o,this._state=l,this._gnar=_,this._felog=d,this._textObserver=p,this._createTextRevisionManager=v,this._originalTextField=S,this._textEventsTarget=x,this._customizations=k,this._experimentClient=u,this._initialWebkitUserSelect=this._originalTextField.style.webkitUserSelect,this._mapChange=m,this._integrationName=T,this._textRevisionManager=this._createTextRevisionManager(p),this._disposables.push(this._textRevisionManager),this._disposables.push(this._alertProcessor),this._disposables.push(this._userEngagedByAlertsAcceptedService),this._doc=E.v.createOnCapi(e,{selectedLens:r.R.SpecialId.AllAlerts}),this._fieldIntegrationStore=y;const w=this._state.get().dynamicConfig.dlpEnabled&&"enabled"===this._experimentClient.getTreatment(z.p.ClientControlsDlpBuffering),F=this._experimentClient.isGateEnabled(H.K.TextChangeBufferUseLegacy),I=this._textObserver.getCurrentTextMap().getPlainText();this._alertProcessor=f.B.create(I,this._textRevisionManager,d);const G=O.ft,q=F?new R.R(this.getUnmappedTextObserver().contentChanges.async,w?void 0:(0,C.qw)(this._originalTextField),!!this._customizations.richText,G):new O.fM(this.getUnmappedTextObserver().contentChanges.async,this._alertProcessor,w?void 0:(0,C.qw)(this._originalTextField),!!this._customizations.richText,G,!this._experimentClient.isGateEnabled(H.K.TextChangeBufferDontFlushOnApply));this._textChangeBuffer=q,this._disposables.push(q),this._textFieldAttrs=new D.Y(this._originalTextField,{spellcheck:"false"}),this._subs.push((0,A.H)({checkingService:this._checkingService,highlights:this._highlights,layout:this._layout,experimentClient:this._experimentClient,getAlertById:e=>this._alertProcessor.alerts.getAlertById(e)}).subscribe()),this._disposables.push(this._textFieldAttrs),Promise.resolve().then((()=>this._delayedStart()))}_isGBSigninCheckTextDisabled(){var e;const{user:t,page:i}=this._state.get();return(0,I.K)(t,i)&&(null!==(e=i.hideGBSigninPopupTodayTimestamp)&&void 0!==e?e:0)>Date.now()-p.pU}_delayedStart(){const{user:e,page:t}=this._state.get();q.n.isEdcBlocked(e)||this._isGBSigninCheckTextDisabled()||this._startCheckingText(!0===t.showOnboarding)}update(e){const t=this._checkingService.get();if(q.n.isEdcBlocked(e.user)||this._isGBSigninCheckTextDisabled())return null!==t&&(this._alertProcessor.removeAllAlerts({_tag:T.i.reset}),t.closeConnection(),this._checkingService.set(null)),void this._state.set(e);if(null!==t){const i=e.user,s=e.dapi.dialectStrong,n=this._state.get(),r=n.user,a=n.dapi.dialectStrong;i.id!==r.id||i.type!==r.type?(t.reconnect(),this._alertProcessor.removeAllAlerts({_tag:T.i.reset})):s!==a&&this._doc.settings.modify((e=>{const t={...e.context,dialect:g.ij(s)};return{...e,context:t}}))}else"ready"===e.extensionFSM.stage&&this._startCheckingText(!0===e.page.showOnboarding);this._state.set(e)}dispose(){var e;this._isDisposed||(this._isDisposed=!0,this._subs.forEach((e=>e.unsubscribe())),this._originalTextField.style.webkitUserSelect=this._initialWebkitUserSelect,[...this._disposables,this._textObserver,this._layout.textField.scroller].forEach((e=>{try{null==e||e.dispose()}catch(e){}})),null===(e=this._checkingService.get())||void 0===e||e.dispose(),o.timer(1e3).pipe(l.c(this._publishedAckReceived)).subscribe((e=>{e||this._canDisposeCheckingService.next(!0)})))}_startCheckingText(e){var t;if(null!==this._checkingService.get())return;const i=this._createCheckingService({doc:this._doc,mapChange:this._mapChange,integrationName:this._integrationName});this._checkingService.set(i),i.delayDisposeUntil(this._canDisposeCheckingServicePromise),this._subs.push(i.capiMessages.pipe(h.h((e=>"start"===e.action))).subscribe((e=>this._capiStartAckMessage.set(g.G(e))))),this._subs.push(i.capiEvents.pipe(h.h(n.hX.is("session_started"))).subscribe((e=>{this._initialSessionUUID.set(g.ij(e.sessionUuid))})));this._disposables.push(this._fieldIntegrationStore.registerFieldIntegration(S.O.ghost,null!==(t=this._textEventsTarget)&&void 0!==t?t:this._originalTextField,this._integrationName,this._textObserver)),this._checkingFeatureImpl=new w.O(this._state.view("user"),this._alertProcessor,i,this.getUnmappedTextObserver(),this._textRevisionManager,(()=>{}),(e=>this._checkingStatus.set(e)),(e=>this._readyState.set(e)),(e=>{this._fieldIntegrationController.setSiteSettings(e),this._checkDocContextSubscription()}),(e=>{this._textFieldAttrs.setAttributes({spellcheck:e.toString()}),this._nativeSpellcheckEnabled.set(e)}),((e,t,i)=>{}),(e=>(0,s.zG)(u.cS)),!!this._customizations.richText,(e=>this._generalScore.set(e||null)),(e=>this._lowestGeneralScore.set(e||null)),(e=>this._paragraphsCount.set(e)),(e=>this._formattingSpansCount.set(e)),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(()=>{(0,m.OB)().bgRpc.api.refreshUser("not_authorized")}),(e=>{this._statisticsService.wordsCount.set(e.wordsCount),this._statisticsService.charsCount.set(e.charsCount),this._statisticsService.sessionStats.set(e.sessionStats)}),(e=>{}),(e=>{}),(()=>this._canDisposeCheckingService.next(!0)),this._requestAwaitService.requests,this._textChangeBuffer,this._experimentClient,this._sduiBufferService.get(),new x.R),this.addSubscription(this._alertProcessor.alerts.state.pipe(_.U(y.S.alertMapToCapiAlerts),h.h((e=>e.filter((e=>e.isHidden)).length>0)),d.P()).subscribe((()=>{const{upgradeHookExperiment:e,experimentGroup:t}=(0,F.o)(this._experimentClient);this._felog.upgradeHooksExp.upgradeHookFirstHiddenPremiumAlertReceived(e.name,t,this._domain)}))),this._checkingFeatureImpl.delayDisposeUntil(this._canDisposeCheckingServicePromise)}getUnmappedTextObserver(){return this._textObserver}addSubscription(e){this._isDisposed?e.unsubscribe():this._subs.push(e)}_checkDocContextSubscription(){var e;this._customizations.getDocEvents&&(null===(e=this._docEventsSubscription)||void 0===e||e.unsubscribe(),this._docEventsSubscription=this._customizations.getDocEvents(this._originalTextField).subscribe((e=>{var t,i;switch(e.type){case"docContextUpdated":{const i=this._sanitizeContextInfo(e.docContextInfo);(0,v.Qr)(i)||null===(t=this._checkingService.get())||void 0===t||t.updateContextInfo(i);break}case"published":null===(i=this._checkingService.get())||void 0===i||i.published();break;default:(0,k.vE)(e)}})),this._subs.push(this._docEventsSubscription))}_sanitizeContextInfo(e){const t=Object.keys(e),i=q.n.isGrammarlyEmployee(this._state.view("user").get());return t.reduce(((e,t)=>(G.t.fieldIsPrivate(t)&&!i&&delete e[t],e)),e)}}}}]);