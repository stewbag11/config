(self.webpackChunk=self.webpackChunk||[]).push([[4382],{99498:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>Pi,isAssistantOpened:()=>ki,isGenAIAssistantOpened:()=>Ei});var s=i(18117),n=i(92135),a=i(72106),r=i(90023),o=i(49231),l=i(20719),c=i(81541),d=i(15214),h=i(3967),u=i(30140),p=i(6426),g=i(90206),m=i(82823),v=i(36072),_=i(80724),b=i(60841),f=i(90049),S=i(55446),y=i(73863),w=i(8748),A=i(39620),I=i(65882),C=i(65647),x=i(78488),R=i(20715),k=i(60165),E=i(14765),P=i(96030),U=i(83780),T=i(25989),M=i(74857),O=i(34859),B=i(58303),G=i(17071),z=i(52256),F=i(99627),D=i(25770),j=i(42822),W=i(28317);var V=i(96601),q=i(92203),N=i(74983),H=i(94525),L=i(68942),$=i(4798),Y=i(70932),K=i(68607),X=i(39953),Q=i(75787),Z=i(33090),J=i(78084),ee=i(52811),te=i(10859),ie=i(7424),se=i(16587),ne=i(16309),ae=i(76670),re=i(68567),oe=i(71653),le=i(41820),ce=i(88190),de=i(33969),he=i(54104),ue=i(43818),pe=i(53829),ge=i(68485),me=i(77365),ve=i(97310);function _e({node:e}){const t=o.useContext(ve.nS.Context);return o.useEffect((()=>{if(t&&!e.isConnected)return t.host.appendChild(e),()=>e.remove()}),[e]),null}var be=i(37717),fe=i(21180);const Se="extension-assistant-visually-ready",ye="extension-assistant-interaction-ready",we=`${fe.V.assistantOpenAttempt}-to-extension-assistant-visually-ready`;class Ae{constructor(e){this._params=e,this.sizeBehavior=this._params.sizeBehavior,this.dragBehavior=this._params.dragBehavior,this.hostInfo=this._params.hostInfo}static markOpenAttempt(){performance.mark(fe.V.assistantOpenAttempt)}static markVisuallyReady(){performance.mark(Se)}static markInteractionReady(){performance.mark(ye)}static measureOpenAttemptToVisuallyReady(){try{return performance.measure(we,fe.V.assistantOpenAttempt).duration}catch(e){return}}static measureVisuallyReadyToInteractionReady(){try{return performance.measure("extension-assistant-visually-ready-to-extension-assistant-interaction-ready",Se).duration}catch(e){return}}starting(){return Promise.resolve()}visuallyReady(){Ae.markVisuallyReady();const e=Ae.measureOpenAttemptToVisuallyReady();return this._params.gnarTracking.trackVisuallyReady(e),this._params.onVisuallyReady(),Promise.resolve()}interactionReady(e){Ae.markInteractionReady();const t=Ae.measureVisuallyReadyToInteractionReady();return this._params.gnarTracking.trackInteractionReady(e,t),Promise.resolve()}focusStateChanged(e){return this._params.onFocusStateChanged(e),Promise.resolve()}readyToDrag(e){return this._params.onReadyToDrag(e)}close(){return this._params.gnarTracking.trackClose(),this._params.onClose(),Promise.resolve()}openUrl(e){return self.open(e,"_blank","noreferrer"),Promise.resolve()}dispose(){this._params.gnarTracking.dispose()}}var Ie=i(68259),Ce=i(11456),xe=i(37285);function Re(e){switch(e){case"revision":return"revisionOnly";case"genAI":case"genAIAndWritingExpert":return"genAIOnly";case"genAIAndRevision":return"genAIAndRevision";default:(0,Ie.L0)(e)}}function ke(e,t){var i;if("genAI"===e.assistantMode)return;if("inlineCardSource"!==(null===(i=e.source)||void 0===i?void 0:i.kind))return;const s=e.source.alertId;if(null==s)return;const n=t.alerts.getAlertById(s);if(null==n||!Ce.S.isCapiAlert(n)||!H.DD.isRegular(n))return;const a=(0,xe.UQ)(n,n.text)[0];return null!=a?{alertId:s,alertPname:n.patternName,originalText:n.text,replacementText:a.newText}:void 0}var Ee=i(30646),Pe=i(15281),Ue=i(86399),Te=i(69425),Me=i(12518),Oe=i(35947);function Be(e,t,i,s){const{left:n,right:a}=(0,r.zG)(e,Ue.UI((({alertId:e,alternativeIndex:i})=>Ge(e,i,function(e,t){return Me.fromOption((()=>`Alert ${e} not found`))(t(e))}(e,t)))),Ue.oh);return ze(e,a,i,s,n)}function Ge(e,t,i){return(0,r.zG)(i,Me.filterOrElse(Ce.S.isCapiAlert,(t=>`Unsupported alert ${e} with type ${t._tag}`)),Me.chain((i=>{let s;return s=N.$.isWithTransformJson(i)?(0,r.zG)(i.transformJSON.alternatives,B.tS((e=>{var i;return B.ij(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),Me.fromOption((()=>`Alternative ${t} not found for WithTransformJson alert ${e}`))):N.$.isWithSubAlerts(i)?(0,r.zG)(i.subalerts.alternatives,B.tS((e=>{var i;return B.ij(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),Me.fromOption((()=>`Alternative ${t} or context not found for WithSubAlerts alert ${e}`))):N.$.isWithPosition(i)?Me.right((new Te.i).retain(i.transformRange.start).delete(i.transformRange.end-i.transformRange.start).insert(i.transformText)):Me.left(`Unsupported alert ${e}`),(0,r.zG)(s,Me.map((s=>({delta:s,alert:i,alertId:e,alternativeIndex:t}))))})))}function ze(e,t,i,s,n){const{invertedReplacements:a,formattings:o,alert:l}=(e=>{if(1===e.length)return{invertedReplacements:(0,Oe.g)(e[0].delta),formattings:(0,Oe.B)(e[0].delta),alert:e[0].alert};{const t=e.reduce(((e,t)=>e.compose(t.delta)),new Te.i);return{invertedReplacements:(0,Oe.g)(t),formattings:(0,Oe.B)(t)}}})(t);return i.performBatchReplacements(a,{alert:l}).then((()=>Me.right(void 0))).catch((t=>Me.left(`Replacement error for [${e.map((e=>`alertId: ${e.alertId} altIdx: ${e.alternativeIndex}`)).join(", ")}]: `+String(t)))).then((e=>(0,r.zG)(s(),B.hX((()=>o.length>0)),B.g_((()=>Promise.resolve(Me.right(void 0))),(e=>Promise.all(o.map((({range:t,formatting:i})=>e.apply(t,i).then((()=>Me.right(void 0))).catch((e=>Me.left(String(e))))))).then((0,r.ls)(Ue.oh,(({left:e})=>e.length>0?Me.left(`Formatting errors [${e.join(", ")}]`):Me.right(void 0))))))).then((t=>{const i=n.concat(Me.isLeft(e)?[e.left]:[]).concat(Me.isLeft(t)?[t.left]:[]);return i.length>0?Me.left(new Error(`AlertApply - ${i.join(" - ")}`)):Me.right(void 0)}))))}var Fe=i(8923);class De{constructor(e,t,i,s,n,a,r){this._events=e,this._alertProcessor=t,this._replacementService=i,this._alertStateService=s,this._highlightUpdater=n,this._highlightScroller=a,this._getFormattingService=r,this._logger=Y.Y.create("gOS:cs:Alerts"),this._deps=new m.w,this._alertCollectionChangeSubscription=null,this._alertSelectionChangeSubscription=null,this._selectedAlertId=null,this._deps.add(this._alertStateService.getActiveAlertByClick().subscribe((e=>{var t;this._selectedAlertId=null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null})))}async subscribeToAlertCollection(e){if(this._alertCollectionChangeSubscription=this._alertProcessor.alerts.changes.subscribe((e=>{this._events.alertCollectionChanged({alertCollectionChanges:[...e.addedAlerts.filter((e=>Ce.S.isCapiAlert(e))).map((e=>({operation:"add",alertId:e.id}))),...e.removedAlerts.filter((e=>Ce.S.isCapiAlert(e.alert))).map((e=>({operation:"remove",alertId:e.id})))]}).catch((e=>this._logger.error(e)))})),e.replayState){const e=Array.from(this._alertProcessor.alerts.getAll()).filter((e=>Ce.S.isCapiAlert(e)));e.length>0&&this._events.alertCollectionChanged({alertCollectionChanges:e.map((e=>({operation:"add",alertId:e.id})))}).catch((e=>this._logger.error(e)))}}async unsubscribeToAlertCollection(){var e;null===(e=this._alertCollectionChangeSubscription)||void 0===e||e.unsubscribe(),this._alertCollectionChangeSubscription=null}async applyAlerts({applyAlertsInfo:e}){await Be(e,(e=>B.ij(this._alertProcessor.alerts.getAlertById(e))),this._replacementService,this._getFormattingService)}async removeAlerts(e){e.removeAlertsInfo.forEach((({alertId:e,removalReason:t})=>{this._alertProcessor.removeAlert(e,{_tag:"alertApplied"===t?Fe.i.alertAccepted:Fe.i.ignore})}))}async subscribeToSelectedAlert({replayState:e}){if(this._alertSelectionChangeSubscription=this._alertStateService.getActiveAlertByClick().subscribe((e=>{var t,i;this._selectedAlertId=null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null;const s=null!==(i=null==e?void 0:e.alertId)&&void 0!==i?i:null;null!=s&&this._events.selectedAlertChanged({alertId:s}).catch((e=>this._logger.error(e)))})),e){const e=this._selectedAlertId;null!=e&&this._events.selectedAlertChanged({alertId:e}).catch((e=>this._logger.error(e)))}}async unsubscribeToSelectedAlert(){var e;null===(e=this._alertSelectionChangeSubscription)||void 0===e||e.unsubscribe(),this._alertSelectionChangeSubscription=null}async setAlertsVisibility({alertsVisibilityInfo:e}){this._highlightUpdater.setAlertsVisibility(e)}async updateAlertsVisibility({alertsVisibilityInfo:e}){this._highlightUpdater.updateAlertsVisibility(e)}async scrollAlertIntoView(e){this._highlightScroller.scrollAlertIntoView(e)}async getCardLayoutGroupCounts(){const e=Array.from(this._alertProcessor.alerts.getAll()).reduce(((e,t)=>{var i;if(!Ce.S.isCapiAlert(t))return e;const s=t.cardLayout.group,n=null!==(i=e[s])&&void 0!==i?i:{freeAlerts:0,premiumAlerts:0};return n.freeAlerts+=t.isFree?1:0,n.premiumAlerts+=t.isFree?0:1,e[s]=n,e}),{});return{groupCounts:Object.entries(e).map((([e,t])=>({cardLayoutGroup:e,...t})))}}dispose(){var e,t;null===(e=this._alertCollectionChangeSubscription)||void 0===e||e.unsubscribe(),null===(t=this._alertSelectionChangeSubscription)||void 0===t||t.unsubscribe(),this._deps.unsubscribe()}}var je=i(78306);class We{constructor(e,t,i,s){this._events=e,this._capi=t,this._dlp=new je.Xg,this._deps=new m.w,this._logger=Y.Y.create("gOS:cs:CapiSocket"),this._messages=new Map,this._subscriptions=new Map;const n=this._capi.get();if((0,B.pC)(n)){const e=n.value;null!=e.initialSessionUuid&&this._events.connected({sessionUuid:e.initialSessionUuid}).catch((e=>this._logger.error(e)))}this._deps.add(i.subscribe((e=>{"session_inbound"===e.kind||"session_started"===e.kind?this._events.connected({sessionUuid:"sessionUuid"in e?e.sessionUuid:""}).catch((e=>this._logger.error(e))):"disconnect"===e.kind&&(this._messages.clear(),this._events.disconnected(null).catch((e=>this._logger.error(e))))}))),this._deps.add(s.subscribe((e=>{this._messages.set(e.action,e),this._subscriptions.has(e.action)&&this._events.messageReceived({message:e}).catch((e=>this._logger.error(e)))})))}dispose(){this._deps.unsubscribe()}async sendMessage(e){const t=this._capi.get();if(!(0,B.pC)(t))throw new Error("Capi service is not available");const i=t.value,s=await i.sendMessage(e.message.action,e.message,!1,null!=e.injectRevisionNumberAt?{kind:"default"}:void 0)();if((0,Me.isLeft)(s))throw new Error(s.left.message);return{messageId:s.right}}async subscribeToMessage(e){e.actions.forEach((e=>this._subscriptions.set(e,!1)))}async subscribeToMessages(e){e.subscriptions.forEach((e=>{this._subscriptions.set(e.actionName,e.replayLatest);const t=this._messages.get(e.actionName);null!=t&&e.replayLatest&&this._events.messageReceived({message:t})}))}async unsanitizeText(e){return{text:this._dlp.unsanitizeText(e.text)}}async sanitizeText(e){return{text:this._dlp.sanitizeText(e.text)}}}class Ve{constructor(e){this._setSelectionContext=e}async setSelectionContext(e){this._setSelectionContext({range:e.range,visibility:e.visibility})}}var qe=i(93899);class Ne{constructor(e,t){this._events=e,this._source=t,this._deps=new m.w,this._buffer=[],this._collection=this._source.pipe(C.U((e=>{switch(e.kind){case"sdui_add":return{operation:"add",operationV2:"add",itemId:e.sduiRootId,dsl:e.sdui};case"sdui_update":return{operation:"update",operationV2:"update",itemId:e.sduiRootId,dsl:e.sdui};case"sdui_remove":return{operation:"remove",operationV2:"remove",itemId:e.sduiRootId};default:return null}})),S.h((e=>null!==e)),(e=>e.pipe(qe.f(e.pipe(M.b(0))))),S.h((e=>e.length>0))),this._buffering=this._collection.subscribe((e=>{this._buffer.push(...e)})),this._deps.add(this._buffering)}dispose(){this._deps.unsubscribe()}async subscribeToItemCollection({replayState:e}){this._buffering.unsubscribe(),e&&this._buffer.length>0&&this._events.itemCollectionChanged({itemCollectionChanges:[...this._buffer]}),this._deps.add(this._collection.subscribe((e=>{this._events.itemCollectionChanged({itemCollectionChanges:e})}))),this._buffer.length=0}async unsubscribeToItemCollection(){this._deps.unsubscribe()}}var He=i(50782);var Le=i(12776);function $e(e){return"revision"===e.assistantMode||"genAIAndRevision"===e.assistantMode}function Ye(e,t){return e instanceof Le.P&&$e(t)}class Ke{constructor(e,t,i,s,n,a){this._params=e,this._selectionRange=t,this._highlightsUpdater=i,this._highlightsScroller=s,this._closeAssistant=n,this._contextHighlight=a,this._name="applet",this._subscriptions=new m.w,this._dragBehavior=D.h.create({kind:"draggable",isDragging:!1}),this._sizeBehavior=D.h.create({heightBehavior:{kind:"fitContent",maxHeight:null},widthBehavior:{kind:"fitContent",maxWidth:null,minWidth:null}}),this._assistantMode=D.h.create("genAIAndRevision"),this._lastMousePosition={x:0,y:0},this._viewState=D.h.create("none"),this._isSettingsMenuShown=D.h.create(!1),this._placeholderSize=D.h.create({width:0,height:0}),this._containerElement=null,this._assistant=function(e){const t=V.C.shared,i=t.host.createContext().withEditSession((0,Pe.wr)({appletId:"assistant",replacementService:e.replacementService,selectionService:e.selectionService,textObserver:e.textObserver,selectionRange:e.selectionRange})),{promise:s,resolve:n}=(0,He.II)(),{applet:a,start:r}=t.host.createUIAppletContainer((0,Ee.SP)({id:"assistant",kind:"ui"}),{...e,onInit:t=>{var i;null===(i=e.onInit)||void 0===i||i.call(e,t),n()}},i,!1),o=new De(new Ee.Q$(a.rpc.call.bind(a.rpc)),e.alertProcessor,e.replacementService,e.alertStateService,e.highlightUpdater,e.highlightScroller,e.getFormattingService),l=new We(new Ee.tL(a.rpc.call.bind(a.rpc)),e.checkingService,e.checkingService.pipe(_.cp((e=>T.D(e.capiEvents)))),e.capiMessages),c=new Ne(new Ee.wR(a.rpc.call.bind(a.rpc)),Z.z(J.P((()=>T.D(e.getSDUIBuffer()))),e.checkingService.pipe(_.cp((e=>T.D(e.capiEvents)))))),d=new Ve((t=>{e.contextHighlight.set(B.G({range:t.range,visibility:t.visibility}))}));return i.registerObject(Ee.Ro.objectName,new Ee.Ro(d)),i.registerObject(Ee.ml.objectName,new Ee.ml(o)),i.registerObject(Ee.Hd.objectName,new Ee.Hd(l)),i.registerObject(Ee.MC.objectName,new Ee.MC(c)),a.onBeforeUnload((()=>{o.dispose(),l.dispose(),c.dispose()})),{applet:a,start:async e=>(await s,await r(e))}}({alertProcessor:this._params.alertProcessor,alertStateService:this._params.alertStateService,checkingService:this._params.checkingService,capiMessages:Z.z(J.P((()=>Object.values(this._params.latestCAPIMessages.get()))),this._params.checkingService.pipe(_.oA,b.w((e=>e.capiMessages)))),getFormattingService:this._params.getFormattingService,getSDUIBuffer:this._params.getSDUIBuffer,highlightScroller:this._highlightsScroller,highlightUpdater:this._highlightsUpdater,replacementService:this._params.replacementServiceInjector.create(ge.P.gOSAssistantApplet),selectionService:this._params.selectionService,textObserver:this._params.textObserver,selectionRange:this._selectionRange,contextHighlight:this._contextHighlight,onSettingsMenu:()=>{this._isSettingsMenuShown.set(!0)},onVisuallyReady:()=>{Ae.markVisuallyReady();const e=Ae.measureOpenAttemptToVisuallyReady();this._assistant.applet.view.frame.slot=this._name,this._viewState.set("applet"),this._params.gnar.gOSAssistantAppletVisuallyReady(this._assistantMode.get(),e)},onInteractionReady:(e,t)=>{var i;null===(i=this._params.assistantDidOpen)||void 0===i||i.next(this._assistantMode.get());const s=Ae.measureOpenAttemptToVisuallyReady();this._params.gnar.gOSAssistantAppletInteractionReady(t,s,e)},onClose:()=>{this._assistant.applet.view.frame.slot="hidden",this._params.gnar.gOSAssistantAppletClose(this._assistantMode.get())},onTerminate:()=>{this._close()},onDragMove:async e=>{if(e){const t=this._assistant.applet.view.frame.getBoundingClientRect();this._lastMousePosition={x:e.x+t.left,y:e.y+t.top}}await this._handleDragging()},canResize:()=>"applet"!==this._viewState.get()||this._params.integration.canResizeAssistant(this._assistantMode.get()),handleResize:e=>this._handleResizing(e)});const r=e=>{this._lastMousePosition={x:e.clientX,y:e.clientY}};document.addEventListener("mousedown",r,{passive:!0}),document.addEventListener("mousemove",r,{passive:!0}),this._subscriptions.add((()=>{document.removeEventListener("mousedown",r),document.removeEventListener("mousemove",r)})),this._assistant.applet.view.frame.loading="eager",this._assistant.applet.view.frame.slot="hidden",this._subscriptions.add(this._dragBehavior.subscribe((e=>{const t=this._assistant.applet.view.frame.parentElement;t instanceof HTMLElement&&("draggable"===e.kind&&e.isDragging?(this._assistant.applet.view.frame.style.setProperty("pointer-events","none"),this._assistant.applet.view.frame.style.setProperty("user-select","none"),t.style.setProperty("cursor","grabbing")):(this._assistant.applet.view.frame.style.removeProperty("pointer-events"),this._assistant.applet.view.frame.style.removeProperty("user-select"),t.style.removeProperty("cursor")))}))),this._subscriptions.add((()=>{this._isSettingsMenuShown.set(!1),this._assistant.applet.view.frame.remove()}))}_close(){this._viewState.set("none"),this._closeAssistant(K.jg.closed)}get preloadUI(){return o.createElement(_e,{node:this._assistant.applet.view.frame})}render(e,t){return this._startApplet(e,t),o.createElement(pe.w,null,this._renderView())}_renderView(){return o.createElement("div",{ref:e=>{this._containerElement=e},key:"gOSAppletHost",style:{display:"grid",width:this._sizeBehavior.view((e=>"fitContent"===e.widthBehavior.kind?"fit-content":"100%")).get(),height:this._sizeBehavior.view((e=>"fitContent"===e.heightBehavior.kind?"fit-content":"100%")).get(),overflow:"hidden",borderRadius:Q.ux.rem(ie.ze)}},o.createElement(ue.F.Fragment,null,this._viewState.view((e=>{switch(e){case"none":return null;case"loading":return this._renderLoadingView();case"error":return this._renderErrorView();case"applet":return o.createElement("slot",{name:this._name})}})),this._isSettingsMenuShown.view((e=>this._renderSettingsView(e)))))}_renderLoadingView(){return o.createElement(ue.F.Fragment,null,this._placeholderSize.view((e=>o.createElement(se.k,{bgColor:"white",style:{minWidth:Math.max(300,e.width),minHeight:Math.max(200,e.height),alignItems:"center",justifyContent:"center",position:"relative"},"data-testid":"applet-loading"},o.createElement(ne.h,{variant:"tertiary",icon:ae.V,accessibilityLabel:"Close",onClick:()=>this._close(),style:{position:"absolute",top:"0.5rem",right:"0.5rem"}}),o.createElement(re.J,{icon:oe.I,size:"large",accessibilityLabel:"Loading Grammarly Assistant",className:be.spin})))))}_renderErrorView(){return o.createElement(ue.F.Fragment,null,this._placeholderSize.view((e=>o.createElement(se.k,{bgColor:"white",style:{minWidth:Math.max(300,e.width),minHeight:Math.max(200,e.height),alignItems:"center",justifyContent:"center",position:"relative"},"data-testid":"applet-error"},o.createElement(ne.h,{variant:"tertiary",icon:ae.V,accessibilityLabel:"Close",onClick:()=>this._close(),style:{position:"absolute",top:"0.5rem",right:"0.5rem"}}),o.createElement(se.k,{direction:"column",align:"center",padding:4},o.createElement(re.J,{icon:le.F,size:"large",variant:"warning",accessibilityLabel:""}),o.createElement(ce.X,{as:"h1",variant:"heading-small"},"Something went wrong"),o.createElement(de.x,{as:"p",align:"center"},"Please"," ",o.createElement("a",{href:"https://support.grammarly.com/hc/en-us/articles/5806184637325-Error-Can-t-connect-to-Grammarly",rel:"noopener noreferrer",target:"_blank",style:{display:"inline"}},"contact support")," ","for assistance."))))))}_renderSettingsView(e){return e?o.createElement(he.u_,{isOpen:e,onClose:()=>{this._isSettingsMenuShown.set(!1)},title:"Settings",dismissOnOutsideClick:!1},o.createElement(he.u_.Body,null,o.createElement(me.o,null,this._params.settingsService.getView()))):null}_startApplet(e,t){this._subscriptions.add(ee.S3(this._viewState.pipe(S.h((e=>"applet"===e))),te.timer(200).pipe(x.b((()=>this._viewState.set("loading"))))).subscribe()),this._subscriptions.add(ee.S3(this._viewState.pipe(S.h((e=>"applet"===e))),te.timer(1e4).pipe(x.b((()=>this._viewState.set("error"))))).subscribe()),this._assistantMode.set(e.assistantMode),this._subscriptions.add(t.dragBehavior.subscribe((e=>this._dragBehavior.set(e)))),this._subscriptions.add(t.sizeBehavior.subscribe((e=>this._sizeBehavior.set(e)))),this._readyToDragFn=t.readyToDrag,this._assistant.applet.onBeforeUnload((()=>{this._subscriptions.unsubscribe(),this._readyToDragFn=void 0}));const i=this._selectionRange.get();const s=()=>"revision"!==e.assistantMode?"translate"===e.genAIParams.genAISessionMode||"appActionDeeplink"===e.genAIParams.genAISessionMode||"compliance"===e.genAIParams.genAISessionMode?"rewrite":e.genAIParams.genAISessionMode:"ideation";return this._assistant.start({assistantMode:Re(e.assistantMode),entryPoint:s(),entryPoint2:s(),theme:{flatUI:!0,logoVersion:"february2024"},selectedRange:B.FS(i),selectedText:(0,X.zG)(i,B.g_(r.r5,(e=>this._params.integration.getText(e)))),pushRewriteInfo:ke(e,this._params.alertProcessor),defaultRevisionModeView:Ye(this._params.integration,e)?"longForm":"shortForm",outerContext:B.FS(this._params.integration.quickReplyContext.get()),partialPageModeEnabled:!1,showPartialPageModeNotification:!1}),this._assistant.applet}async _handleDragging(){if("notDraggable"===this._dragBehavior.get().kind)return;if(null==this._readyToDragFn)return;const e=this._assistant.applet.view.frame.parentElement;e instanceof HTMLElement&&(this._assistant.applet.view.frame.style.setProperty("pointer-events","none"),await this._readyToDragFn({dragHandle:e}),e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,clientX:this._lastMousePosition.x,clientY:this._lastMousePosition.y,button:0,buttons:1})),await new Promise((e=>{const t=setTimeout((()=>{const t=this._dragBehavior.get();"draggable"===t.kind&&t.isDragging||this._assistant.applet.view.frame.style.removeProperty("pointer-events"),this._subscriptions.remove(i),e()}),150),i=this._subscriptions.add((()=>clearTimeout(t)))})))}_handleResizing(e){var t,i,s,n,a,r,o,l;const c="loading"===this._viewState.get(),d=this._assistant.applet.view.frame,{heightBehavior:h,widthBehavior:u}=this._sizeBehavior.get(),p=0===e.height||"fitContainer"===h.kind?null!==(i=null===(t=this._containerElement)||void 0===t?void 0:t.offsetHeight)&&void 0!==i?i:200:e.height,g=0===e.width||"fitContainer"===u.kind?null!==(n=null===(s=this._containerElement)||void 0===s?void 0:s.offsetWidth)&&void 0!==n?n:300:e.width,m="fitContainer"===h.kind?p:Math.min(null!==(a=h.maxHeight)&&void 0!==a?a:1/0,0===e.height?null!==(r=h.height)&&void 0!==r?r:0:e.height),v="fitContainer"===u.kind?g:Math.max(null!==(o=u.minWidth)&&void 0!==o?o:0,Math.min(null!==(l=u.maxWidth)&&void 0!==l?l:1/0,e.width));return this._placeholderSize.set({width:v,height:m}),c||!this._params.integration.canResizeAssistant(this._assistantMode.get())||("fitContainer"===h.kind?d.style.minHeight="0px":d.style.minHeight=`${m}px`,"fitContainer"===u.kind?d.style.minWidth="0px":d.style.minWidth=`${v}px`),{width:v,height:m}}dispose(){this._assistant.applet.gracefullyUnloadApplet()}}class Xe{constructor(e){this._params=e}scrollAlertIntoView({alertId:e}){var t;const i=null===(t=this._params.getAlertById(e))||void 0===t?void 0:t.highlightRanges[0];i&&this._params.integration.scrollHighlightIntoView(i)}}var Qe=i(66738),Ze=i(49144),Je=i(21147),et=i(52979);class tt{constructor(e){this._params=e,this._subs=new m.w,this._visibleAlerts=new Ze.X(new Set),this._emphasizedAlerts=new Ze.X(new Set),this.hasHighlights=this._visibleAlerts.pipe(C.U((e=>e.size>0)),E.O(!1),k.x(),te.shareReplay({bufferSize:1,refCount:!0})),this.alertsFilter=this._visibleAlerts.pipe(te.skipBy(Qe.Eh(Je.yv)),M.b(0),C.U((e=>t=>e.has(t.id))),te.shareReplay({bufferSize:1,refCount:!0})),this._subs.add(this._visibleAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("visible highlights",e)}))),this._subs.add(this._emphasizedAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("emphasized highlights",e)})))}setAlertsVisibility(e){this.clearAll();const t=new Set(this._visibleAlerts.value),i=new Set(this._emphasizedAlerts.value);e.filter((e=>"hidden"!==e.visibility)).forEach((({alertId:e,visibility:s})=>{this._params.getAlertById(e)&&(t.add(e),"emphasized"===s&&i.add(e))})),this._visibleAlerts.next(t),this._emphasizedAlerts.next(i)}updateAlertsVisibility(e){const t=new Set(this._visibleAlerts.value),i=new Set(this._emphasizedAlerts.value);e.forEach((({alertId:e,visibility:s})=>{this._params.getAlertById(e)&&"hidden"!==s?(t.add(e),"emphasized"===s?i.add(e):i.delete(e)):(t.delete(e),i.delete(e))})),this._visibleAlerts.next(t),this._emphasizedAlerts.next(i)}clearAll(){this._visibleAlerts.next(new Set),this._emphasizedAlerts.next(new Set)}getHighlightVisualState(e){const t=this._params.alertStateService.getHighlightedAlert().pipe(C.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),E.O(!1),k.x()),i=this._params.alertStateService.getActiveAlertByClick().pipe(C.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),E.O(!1),k.x()),s=this._emphasizedAlerts.pipe(C.U((t=>Array.from(t).some((t=>this._params.aquaAlertsWiring.getHighlightsForAlert(t).includes(e))))),k.x());return I.aj([t,i,s]).pipe(C.U((([e,t,i])=>({hovered:e,selectedByClick:t,emphasized:i}))),E.O({hovered:!1,selectedByClick:!1,emphasized:!1}),P.G(),C.U((([e,t])=>t.hovered||t.selectedByClick?et.pc.hovered:t.emphasized?e.hovered||e.selectedByClick?et.pc.hovered:et.pc.hoveredNeedsAttention:et.pc.none)),E.O(et.pc.none),k.x(),x.b((t=>{var i;return null===(i=this._params.logger)||void 0===i?void 0:i.debug(`[${e}] visual state:`,t)})))}dispose(){this.clearAll(),this._subs.unsubscribe()}}function it(e){var t,i;return null!==(i=null===(t=B.WG(e.get()))||void 0===t?void 0:t.sessionUuid)&&void 0!==i?i:void 0}var st=i(87234);class nt{constructor(e){var t,i;this._params=e,this._subs=new m.w,this._source=function(e){switch(e.kind){case"gButtonSource":return"gbutton";case"emojiButtonSource":return"tone";case"inlineCardSource":return"inline-card";case"inlinePushRewriteSource":return"inline-push-rewrite";case"inlineQuickReplySource":return"inline-quick-reply";case"inlineQuickRewriteSource":return"inline-quick-rewrite";case"inlineRewriteSource":return"inline-rewrite";case"onboardingSource":return"onboarding";case"inlineTranslateSource":return"inline-translate";default:(0,Ie.L0)(e)}}(this._params.openAssistantParams.source),this._uiType=(t=this._params.openAssistantParams,i=this._params.supportedForms,$e(t)?void 0!==i&&i.length>0&&"longForm"===i[0]?"long-form":"short-form":"cheetah"),this._startTrackingDrag()}trackVisuallyReady(e){const t=this._params.statisticsService.alertCounts.get(),i=this._params.statisticsService.wordsCount.get(),s=t.filter((e=>Ce.S.isCapiAlert(e)&&e.outcome===H.TC.clarity)).visibleCapiAlerts;if(Ye(this._params.integration,this._params.openAssistantParams))this._params.gnar.gdocsSidebarGdocsSidebarShow(this._params.integration.isDocOwnedByCurrentUser(),"user",t.unmutedCapiAlerts,i,t.visibleInlineCapiAlerts,s,t.visibleNotInlineCapiAlerts,void 0,e,this._source,this._uiType);else{const n=this._params.position.get();this._params.gnar.assistantPopupShow("default",this._params.height.get(),n.left,n.top,t.unmutedCapiAlerts,s,t.visibleInlineCapiAlerts,t.filter((e=>Ce.S.isCapiAlert(e)&&"priority"===e.assistantView)).unmutedCapiAlerts,i,"sticky",this._getSessionUuid(),void 0,e,this._params.statisticsService.generalScore.get(),this._source,this._uiType)}}trackInteractionReady(e,t){Ye(this._params.integration,this._params.openAssistantParams)?this._params.gnar.gdocsSidebarGdocsSidebarReady(this._getSessionUuid(),e.success,"gen-ai"===e.kind?"genai":"revision",t,this._source,this._uiType):this._params.gnar.assistantPopupReady(this._getSessionUuid(),e.success,"gen-ai"===e.kind?"genai":"revision",t,this._source,this._uiType)}trackClose(){const e=this._params.statisticsService.alertCounts.get(),t=e.filter((e=>Ce.S.isCapiAlert(e)&&e.outcome===H.TC.clarity)).visibleCapiAlerts;Ye(this._params.integration,this._params.openAssistantParams)?this._params.gnar.gdocsSidebarGdocsSidebarClose(this._params.integration.isDocOwnedByCurrentUser(),"user",e.unmutedCapiAlerts,this._params.statisticsService.wordsCount.get(),e.visibleInlineCapiAlerts,t,e.visibleNotInlineCapiAlerts):this._params.gnar.assistantPopupCloseButtonClick("default",e.unmutedCapiAlerts,t,e.visibleInlineCapiAlerts,e.filter((e=>Ce.S.isCapiAlert(e)&&"priority"===e.assistantView)).unmutedCapiAlerts,void 0)}_startTrackingDrag(){const e=this._params.position.get();let t=e;this._subs.add(this._params.isDragging.pipe(P.G(),S.h((([e,t])=>e&&!t))).subscribe((()=>{const i=this._params.position.get();st.E9.l1Distance(i,t)<nt.MINIMAL_RECOGNIZABLE_DRAG_DISTANCE||(this._params.gnar.assistantPopupDrag(i.left,i.top,this._params.height.get(),e.left,e.top),t=i)})))}_getSessionUuid(){return(0,X.zG)(this._params.checkingService.get(),B.tS((e=>B.ij(e.sessionUuid))),B.g_((()=>""),(e=>e)))}dispose(){this._subs.unsubscribe()}}nt.MINIMAL_RECOGNIZABLE_DRAG_DISTANCE=10;var at=i(47649),rt=i(38508),ot=i(52467);function lt(e){var t;return"genAI"!==e.assistantMode&&"genAIAndWritingExpert"!==e.assistantMode&&"inlineCardSource"===e.source.kind&&null!==(t=e.source.alertId)&&void 0!==t?t:null}function ct(e,t,i,s){switch(e.genAISessionMode){case"ideation":return{mode:e.genAISessionMode,metadata:t,documentUrl:s};case"rewrite":case"quickRewrite":case"translate":case"compliance":return{mode:e.genAISessionMode,metadata:t};case"quickReply":return{mode:e.genAISessionMode,quickReplyContext:(0,r.zG)(i,B.g_((()=>at.H.empty),dt)),metadata:t};case"pushRewrite":return{mode:e.genAISessionMode,writingExpertContext:e.writingExpertContext};case"appActionDeeplink":return{mode:e.genAISessionMode,appActionDeeplinkContext:e.appActionDeeplinkContext};default:(0,Ie.L0)(e)}}function dt(e){var t,i,s,n,a,o,l,c,d,h,u,p,g,m,v,_,b;const f=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},S=f(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),y=f(null===(o=null===(a=null===(n=e.parents)||void 0===n?void 0:n[0])||void 0===a?void 0:a.audience)||void 0===o?void 0:o.undisclosedRecipients),w=f(null===(h=null===(d=null===(c=null===(l=e.parents)||void 0===l?void 0:l[0])||void 0===c?void 0:c.audience)||void 0===d?void 0:d.recipients)||void 0===h?void 0:h.filter((({email:e})=>(0,ot.HD)(e)&&!S.has(e)&&!y.has(e)))),A=f(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),I=f(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),C=f(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>(0,ot.HD)(e)&&!A.has(e)&&!I.has(e))));return{previousMessageInfo:(0,r.zG)(Ue.YM(null!==(v=e.parents)&&void 0!==v?v:[]),B.g_((()=>at.H.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,r.zG)(Ue.YM(null!==(t=e.authors)&&void 0!==t?t:[]),B.g_((()=>at.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(w.values()),text:e.delta?(0,rt.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,r.zG)(Ue.YM(null!==(b=e.authors)&&void 0!==b?b:[]),B.g_((()=>at.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(C.values()),indirectRecipients:Array.from(A.values()),undisclosedRecipients:Array.from(I.values())}}var ht=i(35591),ut=i(13777),pt=i(31429),gt=i(20185),mt=i(42402),vt=i(89823),_t=i(13809),bt=i(44252),ft=i(93667),St=i(53710),yt=i(30152),wt=i(10595),At=i(88613),It=i(4603),Ct=i(81259),xt=i(94996),Rt=i(47905);class kt{constructor(e){this._experimentClient=e,this.gates=Rt.C,this.experiments=Rt.V}getTreatment(e){return a.Y3((async()=>(await this._experimentClient.fetchTreatments(),this._experimentClient.getTreatment(e))),(e=>String(e)))}isGateEnabled(e){return a.Y3((async()=>(await this._experimentClient.fetchTreatments(),this._experimentClient.isGateEnabled(e))),(e=>String(e)))}logTreatment(e,t){return a.Y3((async()=>{await this._experimentClient.logTreatment(e,t)}),(e=>String(e)))}peekTreatment(e){return a.Y3((async()=>(await this._experimentClient.fetchTreatments(),this._experimentClient.peekTreatment(e))),(e=>String(e)))}}var Et=i(21448);class Pt{constructor(e,t,i,s,n,a=!1){this._gnar=e,this._telemetry=t,this._alertProcessor=i,this._capiStartAckMessage=s,this._hasInProductDiscountSpecialOffer=n,this._isGdocs=a,this.isEligibleForFreeTrial=this._capiStartAckMessage.view((0,r.ls)(B.VS((e=>{var t;return B.ij(null===(t=e.featureData.upgradeHookData)||void 0===t?void 0:t.variant)})),B.UI((e=>"premiumTrial"===e)),B.fS((()=>!1)))),this.isEligibleForInProductDiscount=this._hasInProductDiscountSpecialOffer}trackUphookShown(e){const t={upgradeHookName:e.name,upgradeHookSlot:this._getUphookSlot(e),upgradeHookVariant:e.variant};switch(e.name){case"grammarlyGoPrompts":(0,Et.nE)(this._gnar,{...t,placement:"grammarlyGoPrompts"});break;case"plagiarism":(0,Et.nE)(this._gnar,{...t,placement:"plagiarismView"});break;case"toneDetector":(0,Et.nE)(this._gnar,{...t,placement:"toneDetector"});break;default:(0,Ie.L0)(e.name)}return this._telemetry.upgradeHooks.showUpgradeHook(e.name,this._getUphookSlot(e),e.variant),Promise.resolve()}trackUphookClicked(e){const t={upgradeHookName:e.name,upgradeHookSlot:this._getUphookSlot(e),upgradeHookVariant:e.variant};switch(e.name){case"grammarlyGoPrompts":(0,Et.Qi)(this._gnar,{...t,placement:"grammarlyGoPrompts"});break;case"plagiarism":(0,Et.Qi)(this._gnar,{...t,placement:"plagiarismView"});break;case"toneDetector":(0,Et.Qi)(this._gnar,{...t,placement:"toneDetector"});break;default:(0,Ie.L0)(e.name)}return this._telemetry.upgradeHooks.clickUpgradeHook(e.name,this._getUphookSlot(e),e.variant),Promise.resolve()}trackUphookDismissed(e){if("plagiarism"===e.name)return(0,Et.jc)(this._gnar,{placement:"plagiarismView",upgradeHookName:e.name,upgradeHookSlot:this._getUphookSlot(e),upgradeHookVariant:e.variant}),Promise.resolve();(0,Ie.L0)(e.name)}executeUphook(e){const t="advancedIssues"===e.name?Array.from(this._alertProcessor.alerts.getAll()).filter(Ce.S.isCapiAlert).filter((e=>!e.isFree&&e.isHidden)):[];return(0,It.OB)().bgRpc.api.openSubscriptionPage({currentAlerts:t,utmCampaign:`%appName%_${e.name}_${this._getUphookSlot(e)}_${e.variant}`}),Promise.resolve()}_getUphookSlot(e){return"longFormAssistant"===e.slot&&this._isGdocs?"longFormAssistant_Gdocs":e.slot}}var Ut=i(59833),Tt=i(41274);const Mt={"Style/ToneImprovement/ConfidentRewrite/ToneAI":"1f91d","Style/ToneImprovement/PersonableRewrite/ToneAI":"1f917","Style/ToneImprovement/PositiveFraming/ToneAI":"1f64c"};function Ot(e){var t,i,s;const n=null!==(t=e.extraProperties.emoji_id)&&void 0!==t?t:e.extraProperties.emojiId,a=e.minicardTitle.match(Tt.V),r=a&&a[0]&&(null===(i=a[0].codePointAt(0))||void 0===i?void 0:i.toString(16)),o=Mt[e.patternName];return B.ij(null!==(s=null!=n?n:r)&&void 0!==s?s:o)}class Bt{constructor(e){this._alertProcessor=e}getToneAlertsSummary(){const e=Array.from(function*(e){for(const t of e)Ce.S.isCapiAlert(t)&&t.patternName.startsWith("Style/ToneImprovement")&&(yield t)}(this._alertProcessor.alerts.getAll())).map((e=>({title:e.minicardTitle.replace(Tt.V,"").trim(),emojiId:Ot(e)}))),t=new Set(e.map((({title:e})=>e)));return Promise.resolve((0,r.zG)(Ut.YM(e),B.UI((({title:e,emojiId:i})=>({title:t.size>1?"Strike the right tone":e,emojiId:i})))))}}var Gt=i(62549);function zt(e,t,i){const s="business"===i.previousUserType||"edu"===i.previousUserType||"ngo"===i.previousUserType;let n="free";return s?n="institution":"premium"===i.previousUserType&&(n="premium"),e.anonymous?{kind:"signed-out",institutionType:s?i.previousUserType:void 0,type:n}:{kind:"signed-in",id:e.id,isPremium:Gt.n.isPremium(e),dialect:t,email:e.email,institution:(0,r.zG)(B.ij(e.institutionInfo),B.UI((({id:e,name:t,voxInfo:i})=>({id:e,name:t,logoUrl:null==i?void 0:i.logoUrl,styleGuideEnabled:null==i?void 0:i.styleGuideEnabled}))))}}function Ft(e,t,i){return Z.z(J.P((()=>T.D(t()))).pipe(S.h(i)),e)}function Dt(e,t,i,s,n,o,l,h,u,p,g,_,f,w,A,P,U,T,M,O,G,F,j,W,V,q,N,L,Y,K,X,Q){const Z=new v.xQ,J=new ht.t({inboundCAPIMessages:Ft(t,i,ut.J4),sendCAPIMessage:({action:t,data:i,shouldInjectRev:s,shouldInjectSessionId:n})=>(0,r.zG)(a.Uo((0,r.zG)(e.get(),Me.fromOption((()=>new Error("checking service not initialized"))))),a.tS((e=>e.sendMessage(t,i,n,s?{kind:"default"}:void 0))))}),ee={user:D.h.combine(s,o,n,zt),setDialect:l,signIn:()=>{const e=(0,It.OB)().browserApi;e.beginOAuth?e.beginOAuth():self.open((0,At.s7)("signedOutUI","toolbarMenu"),"_blank","noreferrer")}},ie=new pt.L(J,D.h.combine(L.view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})),p.view(B.tS((e=>B.ij(e.cheetahState)))),((e,t)=>(0,r.zG)(t,B.hX((()=>!e)),B.g_((()=>({enabled:!1})),(e=>({enabled:!0,userState:e}))))))),se=g.pipe(bt.QV(ft.E),St.R(((e,t)=>{const i=e.filter(jt);return t&&jt(t)?[...i,t]:i}),[]),C.U(Ue.Z$),te.shareReplay({bufferSize:1,refCount:!0})),ne=I.aj([se,_,f]).pipe(C.U((([e,t,i])=>(0,r.zG)(e,B.hX((()=>t)),B.g_((()=>({})),(e=>({[gt.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[gt.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0}))))))),ae=e=>{null==Q||Q.debug(`Completing step [${e}]`);A.get()[e].extension.completed||P({[e]:{completed:!0,lastSeen:Date.now()}})},re={flush:()=>a.fF((()=>new yt.y((t=>{const i=new m.w;return T.empty.get()?t.next(void 0):(T.flush(),(0,r.zG)(e.get(),B.g_((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(S.h((e=>e._tag===H.J8.Type.submitOtAck)),wt.L(500,R.of(null)),x.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(y.q(1)).toPromise())),getText:e=>a.tD((()=>M(e))),insertText:e=>a.tD((()=>O(e))),copyText:e=>(0,xt.vQ)(e),setContextHighlight:(e,t)=>{j.set(B.G({range:e,visibility:t}))},selectedRange:G,textUpdated:F,trimmedTextLength:F.pipe(E.O(null),C.U((()=>M({start:0,end:Number.MAX_SAFE_INTEGER}).trim().length)),k.x(),te.shareReplay({refCount:!0,bufferSize:1}))},oe=new Pt(W,q,Y,p,X),le={domain:R.of(V),submitFeedback:e=>a.Y3((()=>(0,r.zG)(e.source,(e=>e===vt.x.Source.resultCard?"cheetah-card":e===vt.x.Source.quickReplyInitialActions||e===vt.x.Source.intentCard?"cheetah-quick-reply":void(0,Ie.L0)(e)),(t=>W.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},ce=new _t.j(D.h.create({contextUpdatesClient:N.isGateEnabled($.K.CheetahSelectionContextUpdates)&&"test"===N.getTreatment(Ct.p.CheetahSelectionContextUpdates),contextUpdatesServer:N.isGateEnabled($.K.CheetahSelectionContextUpdatesServer)&&"test"===N.getTreatment(Ct.p.CheetahSelectionContextUpdates)})),de=new Bt(Y),he=new kt(N);return{capiService:J,userService:ee,genAIAvailabilityService:ie,textEditorService:re,feedbackService:le,uphookService:oe,selectionContextAvailabilityService:ce,toneDetectorService:de,experimentService:he,skillService:z.Fc(K),createOnboardingViewModels:()=>{const e=new Set;U.get().compose||e.add(d.T.StepName.initial),U.get().onboarding||(e.add(d.T.StepName.initial),e.add(d.T.StepName.initialBTS),e.add(d.T.StepName.prompts),e.add(d.T.StepName.review),e.add(d.T.StepName.knowledgeHub),e.add(d.T.StepName.references));const t=(0,r.zG)(p.get(),B.UI((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),B.fS(r.jv));return U.get().onboardingBTS&&t||e.add(d.T.StepName.initialBTS),U.get().knowledgeHubIntegration||e.add(d.T.StepName.knowledgeHub),(0,mt.Q)({capiService:J,upstreamOnboardingState:A,session:h.pipe(b.w(B.g_((()=>R.of(B.YP)),(e=>e.genAISession)))),textStats:u,forceDisabledOnboardingSteps:e,assistantUIActions:Z,externalElements:ne,hideAssistantOnboardingTooltips:h.pipe(b.w(B.g_((()=>D.h.create(!1)),(e=>e.dragBehavior.pipe(C.U((e=>"draggable"===e.kind&&e.isDragging))))))),promptsAllocated:ie.availability.view(c._.getPromptsAllocated),client:"extension",disposed:w,completeOnboardingStep:ae})},notifyAssistantUIAction:e=>Z.next(e),dispose:()=>{ie.dispose(),ce.dispose()}}}function jt(e){return e.isConnected&&null!==e.offsetParent}const Wt=(Vt=(0,It.OB)().experimentClient,function(e){if("mergedSharedAssistant"===e)return"genAIAndRevision";if("splitSharedAssistants"===e)return"genAI";{const e=Vt.isGateEnabled($.K.WritingExpertPullMode),t=Vt.isGateEnabled($.K.WritingExpertInAssistantInternal),i=Vt.isGateEnabled($.K.WritingExpertInAssistantNative);return e&&(t||i)?"genAIAndWritingExpert":"genAI"}});var Vt;function qt(e,t,i){const s={source:i,genAIParams:{genAISessionMode:t}};switch(e){case"genAIAndRevision":return{assistantMode:"genAIAndRevision",...s};case"genAI":return{assistantMode:"genAI",...s};case"genAIAndWritingExpert":return{assistantMode:"genAIAndWritingExpert",...s};default:(0,Ie.L0)(e)}}var Nt=i(13195),Ht=i(31413),Lt=i(41847);class $t extends Error{constructor(e,t){var i;super(`Failed to apply alert. Reason: ${null!==(i=null==t?void 0:t.toString())&&void 0!==i?i:"unknown"}. Alert ID: ${e.alertId}. Alternative index: ${e.alternativeIndex}. Feed form: ${e.feedForm}.`),this.name="ApplyAlertError"}}async function Yt(e,t,i,s,n,a){var o,l,c,d,h,u;const p=t(e.alertId);if(B.Wi(p))throw new $t(e,"alert-not-found");if(!Ce.S.isCapiAlert(p.value))throw new $t(e,"alert-not-supported");const g=function(e,t){if(N.$.isWithTransformJson(e)){const i=(0,r.zG)(e.transformJSON.alternatives,B.tS((e=>B.ij(e.alternatives[t.alternativeIndex]))),B.UI((e=>e.delta)),B.pF((()=>null)));if(null===i)throw new $t(t,"alternative-not-found");return i}if(N.$.isWithSubAlerts(e)){const i=(0,r.zG)(e.subalerts.alternatives,B.tS((e=>B.ij(e.alternatives[t.alternativeIndex]))),B.UI((e=>e.delta)),B.pF((()=>null)));if(null===i)throw new $t(t,"alternative-not-found");return i}if(N.$.isWithPosition(e))return(new Te.i).retain(e.transformRange.start).delete(e.transformRange.end-e.transformRange.start).insert(e.transformText);(0,Ie.L0)(e)}(p.value,e),m=(0,Oe.g)(g),v=(0,Oe.B)(g);if(m.length||!(0,It.OB)().experimentClient.isGateEnabled($.K.CheetahExecReplacementOnlyWhenItsExists)){let t;const s=new Ht.t(1),r=n.contentChanges.immediate.pipe(M.b(0)).subscribe(s);try{t=await Promise.race([i.performBatchReplacements(m,{alert:p.value}),(0,He.gw)(null!==(c=null===(l=null===(o=a.get().oggy)||void 0===o?void 0:o.alertService)||void 0===l?void 0:l.applyAlertsPerformBatchReplacementsTimeoutMs)&&void 0!==c?c:1e3,new $t(e,"perform-batch-replacements-timeout")).then((()=>[]))])}catch(t){throw t instanceof $t?t:new $t(e,"perform-batch-replacements-critical-error")}const g=t.find(Lt.j.isFail);if(g&&Lt.j.isFail(g))throw new $t(e,g.reason);await Promise.race([s.pipe(y.q(1)).toPromise(),(0,He.gw)(null!==(u=null===(h=null===(d=a.get().oggy)||void 0===d?void 0:d.alertService)||void 0===h?void 0:h.applyAlertsWaitForTextMapContentChangesTimeoutMs)&&void 0!==u?u:1e3,new $t(e,"wait-for-text-map-content-changes-timeout"))]),r.unsubscribe()}const _=s();if(B.pC(_)&&v.length>0)for(const t of v)try{await _.value.apply(t.range,t.formatting)}catch(t){throw new $t(e,"apply-formatting-critical-error")}}var Kt=i(2870);class Xt{constructor(e){var t;this._params=e,this._subs=new m.w,this._logger=Y.Y.create("AlertServiceImpl"),this._replacementService=this._params.replacementServiceInjector.create(ge.P.oggyRevisionSequential),this._selectedAlertId=D.h.create(this._params.initialAlertId),this._applyAlertsSequentiallyRequests=new v.xQ,this.selectedAlertId=this._selectedAlertId.view(),this.alertCollectionChanges=(t=this._params.alertProcessor.alerts,J.P((()=>t.changes.pipe(C.U((e=>{const t=new Set(e.addedAlerts.filter(Ce.S.isCapiAlert).map((e=>e.id))),i=new Set(e.removedAlerts.filter((e=>Ce.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(Ce.S.isCapiAlert).filter((e=>!i.has(e.id))).map((e=>(0,Kt.Tm)(e.id))),...e.removedAlerts.filter((e=>Ce.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>(0,Kt.qQ)(e.id,"textChange"===e.reason._tag?"textChange":"other")))]})),E.O(Array.from(t.getAll()).filter(Ce.S.isCapiAlert).map((e=>(0,Kt.Tm)(e.id)))),S.h((e=>e.length>0)))))),this._subs.add(this._params.alertStateService.getActiveAlertByClick().pipe(C.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(A.wW(this._selectedAlertId))),this._subs.add(this._applyAlertsSequentiallyRequests.pipe(Nt.b((({applyAlertsInfo:e,deferredPromise:t})=>T.D(this._applyAlertsSequentially(e).then(t.resolve).catch(t.reject))))).subscribe())}async _applyAlertsSequentially(e){try{this._logger.debug("Applying alerts sequentially.",{applyAlertsInfo:e});const t=async function(e,t,i,s,n,a){for(const r of e)await Yt(r,t,i,s,n,a)}(e,(e=>B.ij(this._params.alertProcessor.alerts.getAlertById(e))),this._replacementService,this._params.getFormattingService,this._params.textObserver,this._params.dynamicConfig);this._params.experimentClient.isGateEnabled($.K.SendChangesToCAPIAfterSequentialApply)&&this._params.requestAwaitService.addRequest(t),await t}catch(t){throw this._logger.warn("Error applying alerts sequentially.",{applyAlertsInfo:e,error:t}),t}}applyAlerts(e){this._logger.debug("Received apply alerts request.",{applyAlertsInfo:e});const t=(0,He.II)();return this._applyAlertsSequentiallyRequests.next({applyAlertsInfo:e,deferredPromise:t}),t.promise}removeAlerts(e){try{return e.forEach((({alertId:e,removalReason:t})=>{this._params.alertProcessor.removeAlert(e,{_tag:"alertApplied"===t?Fe.i.alertAccepted:Fe.i.ignore})})),Promise.resolve()}catch(t){return this._logger.warn("Error removing alerts.",{removeAlertsInfo:e,error:t}),Promise.reject(t)}}scrollAlertIntoView(e){try{return this._params.highlightsScroller.scrollAlertIntoView(e),Promise.resolve()}catch(t){return this._logger.warn("Error scrolling alert into view.",{scrollAlertIntoViewInfo:e,error:t}),Promise.reject(t)}}setAlertsVisibility(e){try{return this._params.highlightsUpdater.setAlertsVisibility(e),Promise.resolve()}catch(t){return this._logger.warn("Error setting alerts visibility.",{alertsVisibilityInfo:e,error:t}),Promise.reject(t)}}updateAlertsVisibility(e){try{return this._params.highlightsUpdater.updateAlertsVisibility(e),Promise.resolve()}catch(t){return this._logger.warn("Error updating alerts visibility.",{alertsVisibilityInfo:e,error:t}),Promise.reject(t)}}dispose(){this._subs.unsubscribe()}}var Qt=i(29770),Zt=i(92346);function Jt(e){const t={lifecycleService:e.lifecycleService,capiService:e.capiService,uphookService:e.uphookService,feedbackService:e.feedbackService,experimentService:e.experimentService,textEditorService:e.textEditorService,userService:e.userService,notifyAssistantUIAction:e.notifyAssistantUIAction,trackingService:e.trackingService,humanWritingReportService:e.hwrService,theme:void 0},i=()=>function(e){const t=D.h.create(e.initialAlertId),i=e.alertStateService.getActiveAlertByClick().pipe(C.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(A.wW(t));return{sduiService:{supportedForms:e.supportedForms,sduiItemCollectionChanges:(s=e.getSDUIBuffer,n=e.inboundCAPIEvents,Z.z(J.P((()=>R.of(s()))),n.pipe(S.h((0,G.Kg)(Zt.hX.is("sdui_add"),Zt.hX.is("sdui_update"),Zt.hX.is("sdui_remove"),(0,G.W9)(Zt.hX.is("session_started"),(e=>e.isNewSession)))),C.U((e=>[e])))).pipe(C.U(Ue.UI((e=>{switch(e.kind){case"sdui_add":return(0,Qt.K5)(e.sduiRootId,e.sdui);case"sdui_update":return(0,Qt.FE)(e.sduiRootId,e.sdui);case"sdui_remove":return(0,Qt.Ul)(e.sduiRootId);case"session_started":return(0,Qt.Sq)();default:return(0,Ie.L0)(e)}}))),S.h((e=>e.length>0)),C.U((e=>({changes:e,pendingChangesCount:0})))))},alertService:new Xt({initialAlertId:e.initialAlertId,alertProcessor:e.alertProcessor,alertStateService:e.alertStateService,replacementServiceInjector:e.replacementServiceInjector,requestAwaitService:e.requestAwaitService,highlightsScroller:e.highlightsScroller,highlightsUpdater:e.highlightsUpdater,getFormattingService:e.getFormattingService,experimentClient:e.experimentClient,dynamicConfig:e.dynamicConfig,textObserver:e.textObserver}),dispose:()=>{e.highlightsUpdater.clearAll(),i.unsubscribe()}};var s,n}({getSDUIBuffer:e.getSDUIBuffer,inboundCAPIEvents:e.inboundCAPIEvents,alertProcessor:e.alertProcessor,initialAlertId:lt(e.openParams),highlightsUpdater:e.highlightsUpdater,highlightsScroller:e.highlightsScroller,replacementServiceInjector:e.replacementServiceInjector,getFormattingService:e.getFormattingService,requestAwaitService:e.requestAwaitService,alertStateService:e.alertStateService,supportedForms:e.supportedForms,experimentClient:e.experimentClient,dynamicConfig:e.dynamicConfig,textObserver:e.textObserver}),s=i=>({...t,kind:"genAI",genAIAvailabilityService:e.genAIAvailabilityService,genAIStartSessionOptions:ct(i,{disableKnowledgeEngine:!!e.disableKnowledgeEngine||void 0},e.getQuickReplyContext(),e.url),selectionContextAvailabilityService:e.selectionContextAvailabilityService,skillService:(0,B.FS)(e.skillService),notifyGenAISessionStateChanged:t=>e.genAISession.set(t),isTranslationAvailable:e.isTranslationAvailable});return{getGenAIDeps:s,getRevisionDeps:()=>(0,r.zG)(i(),(({alertService:i,sduiService:s,dispose:n})=>({...t,initialView:"genAI"!==e.openParams.assistantMode&&"genAIAndWritingExpert"!==e.openParams.assistantMode&&"emojiButtonSource"===e.openParams.source.kind?"toneReport":void 0,kind:"revision",alertService:i,sduiService:s,toneDetectorService:e.toneDetectorService,settingsOptions:{kind:"withView",getView:()=>e.settingsService.getView()},isPlagiarismEnabled:e.isPlagiarismEnabled,isWritingExpertEnabled:e.isWritingExpertEnabled,performanceScoreOptions:e.experimentClient.isGateEnabled($.K.PerformanceScoreOggy)?{showEntryPoint:!0}:void 0,isAiDetectorEnabled:(0,r.zG)(e.capiStartAckMessage.view(B.UI((({allowedFeatures:e})=>e.includes("AI_DETECTOR"))))),isAiStudioEnabled:(0,r.zG)(e.capiStartAckMessage.view(B.UI((({allowedFeatures:e})=>e.includes("AI_STUDIO"))))),dispose:n}))),getGenAIAndWritingExpertDeps:e=>{const{alertService:t,sduiService:n}=i();return{...s(e),kind:"genAIAndWritingExpert",alertService:t,sduiService:n}}}}var ei=i(78285),ti=i(9074),ii=i(9690),si=i(99747),ni=i(15542),ai=i(53017),ri=i(31243);const oi=Q.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),li=({children:e})=>{var t;const i=null===(t=o.useContext(ve.nS.Context))||void 0===t?void 0:t.host;return o.createElement(me.o,null,o.createElement(ei.Q,{remSize:R.of(16),setter:e=>ti.u.setRootCssVar(i||document.documentElement,e)},o.createElement(ii.G.DefaultProvider,null,o.createElement("div",{className:oi},e,o.createElement(si.X,null)))))},ci=({children:e})=>{var t;const i=null===(t=o.useContext(ve.nS.Context))||void 0===t?void 0:t.host,{onMount:s,ref:n}=ni.P.useElWatcher();return o.createElement(me.o,null,o.createElement(ei.Q,{remSize:R.of(16),setter:e=>ti.u.setRootCssVar(i||document.documentElement,e)},o.createElement(ii.G.DefaultProvider,null,o.createElement("div",{className:oi,ref:s,"data-role":"onboarding-tooltips",style:{position:"absolute",zIndex:ri.dl+1}},o.createElement(ai.l.Provider,{value:{portalContainer:n}},e),o.createElement(si.X,null)))))};var di=i(94381);const hi=({width:e,height:t,top:i,left:s,visibility:n})=>o.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,F.Sh)(di.highlightRect,"hidden"===n?di.hidden:null,"attention"===n?di.attention:null),style:{width:e,height:t,top:i,left:s}});var ui=i(60310),pi=i(19232),gi=i(51320),mi=i(30409);const vi=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:n,onOpenRewriteClick:a,onOpenTranslateClick:r})=>{const[l,c]=o.useState(null),{styles:d,attributes:h}=(0,pi.D)(e,l,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return n||a?o.createElement("div",{ref:c,style:d.popper,...h.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:mi.entryButton,"data-disabled":s},n?o.createElement(gi.u,{message:"Improve it"},o.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:mi.entryButtonItem,"data-disabled":s},o.createElement("i",{className:mi.rewriteIcon}))):null,r?o.createElement(gi.u,{message:"Translate with Grammarly"},o.createElement("button",{onClick:r,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:mi.entryButtonItem,"data-disabled":s},o.createElement("i",{className:mi.translateIcon}))):null,a?o.createElement(gi.u,{message:"Rewrite with Grammarly"},o.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:mi.entryButtonItem,"data-disabled":s},o.createElement("i",{className:mi.openIcon}))):null):null};var _i=i(68550);const bi=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:n})=>{const[a,r]=o.useState(null),{styles:l,attributes:c}=(0,pi.D)(e,a,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return o.createElement("button",{ref:r,style:l.popper,...c.popper,onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:_i.replyButton,"data-disabled":s},o.createElement("div",{className:_i.icon}),o.createElement("span",null,"Reply quickly"))};var fi=i(64965),Si=i(93526);const yi=()=>o.createElement("svg",{className:Si.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},o.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),o.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),wi=({overflow:e,...t})=>e?o.createElement(Ii,{...t}):o.createElement(Ai,{...t}),Ai=({left:e,top:t,height:i})=>o.createElement(o.Fragment,null,o.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:Si.quasiCaret,style:{left:e,top:t+i,height:i+8}},o.createElement(yi,null))),Ii=({left:e,top:t,height:i})=>{const{ref:n,onMount:a}=ni.P.useElWatcher(),l=o.useMemo((()=>D.h.create(B.YP)),[]),{rect:c,onMount:d}=ni.P.useRectWatcher(),h=o.useCallback((e=>{e.style.pointerEvents="all",l.set((0,r.zG)(s.Yt(B.Kw)({rect:B.G(e.getBoundingClientRect()),goodParent:(0,r.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return B.ij(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),B.hX((t=>t===e||e.contains(t||null))))}),B.g_((()=>B.YP),(({rect:e})=>B.G({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=o.useMemo((()=>fi.R(document,"scroll",{capture:!0}).pipe(E.O(null))),[]);return ni.P.useSubscriptionTo(I.aj([n.pipe(_.oA),u,c]).pipe(x.b((([e])=>h(e))))),o.createElement(o.Fragment,null,o.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:Si.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{a(e),d(e)}},o.createElement(ue.F.div,{style:l.pipe(C.U((e=>(0,r.zG)(e,B.g_((()=>({opacity:1})),(()=>({opacity:0})))))))},o.createElement(yi,null))),o.createElement(ue.F.Fragment,null,l.pipe(C.U((e=>(0,r.zG)(e,B.g_(r.gn,(e=>o.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:Si.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},o.createElement(yi,null))))))))))},Ci=(0,F.xb)(ui.G),xi=new Set(["loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),Ri=new Set(["loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);function ki(e){return"opened"===e.kind}function Ei(e){return ki(e)&&"revision"!==e.assistantMode}class Pi{constructor(e){this._params=e,this._subs=new m.w,this._log=Y.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=D.h.create(null),this._ideateButtonUI=D.h.create(null),this._expandedIdeateButtonUI=D.h.create(null),this._assistantUI=D.h.create(null),this._highlightUI=D.h.create(null),this._quasiCaretUI=D.h.create(null),this._onboardingUI=D.h.create(null),this._nativeCursorHider=D.h.create(B.YP),this._contextHighlight=D.h.create(B.YP),this._highlightsUpdater=new tt({getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e),aquaAlertsWiring:this._params.aquaAlertsWiring,alertStateService:this._params.alertStateService,logger:Y.Y.create("cheetah.revision.highlights")}),this._highlightsScroller=new Xe({integration:this._params.integration,getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e)}),this._ideateButtonTooltipNotificationState=D.h.create(B.YP),this._assistantFocused=D.h.create(!1),this._inlineButtonRecentlyPressed=D.h.create(!1),this._ideateButtonRecentlyHovered=D.h.create(!1),this._selectionRange=D.h.create(B.YP),this._isTranslationAvailable=D.h.create(!1),this._highlights=D.h.create([]),this._quasiCaretRect=D.h.create(B.YP),this._assistantUIState=D.h.create(B.YP),this._onboardingViewModels=D.h.create(B.YP),this._ideateButtonRefChange=new v.xQ,this._disposed=new v.xQ,this._initialOnboardingBlockedForSession=D.h.create(!1),this._inboundCAPIEvents=new v.xQ,this._assistantServices=Dt(this._params.checkingService,this._params.checkingService.pipe(_.oA,b.w((e=>e.capiMessages))),(()=>Object.values(this._params.latestCAPIMessages.get())),this._params.user,this._params.csPageState,this._params.dapiSettings.view((e=>{var t,i;return null!==(i=null!==(t=e.dialectStrong)&&void 0!==t?t:e.dialectWeak)&&void 0!==i?i:"american"})),(e=>a.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantUIState,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,D.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!xi.has(e))),G.xD),D.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),f.T(this._params.csPageState.view("isActiveTab").pipe(S.h((e=>!e))),this._disposed).pipe(y.q(1)),this._params.dapiSettings.view((e=>{const t=function(e){const t=l.Z.State.toClientState(l.Z.decode(e.extension||""),"extension"),i=l.Z.State.toClientState(l.Z.decode(e.editor||""),"editor"),s=l.Z.State.toClientState(l.Z.decode(e.llamaMac||""),"llamaMac"),n=l.Z.State.toClientState(l.Z.decode(e.llamaWin||""),"llamaWin");return(0,r.zG)(l.Z.State.empty,l.Z.State.patch(t,"extension"),l.Z.State.patch(i,"editor"),l.Z.State.patch(s,"llamaMac"),l.Z.State.patch(n,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWin:e["cheetah:onboardingState:llamaWin"]});return this._log.debug("DAPI onboarding state",t),t})),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,r.ls)(l.Z.decode,(t=>(0,r.zG)(l.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>l.Z.State.patch(e,"extension")(t)))),l.Z.encode))}),this._params.featureFlags,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._params.domain,this._params.telemetry,this._params.experimentClient,this._params.csPageState.view("cheetah"),this._params.alertProcessor,this._params.skillService,this._params.hasInProductDiscountSpecialOffer,this._log),this._isOnboardingPopupVisible=D.h.create(!1),this._entryPointsEnabled=D.h.create(!1),this._openAssistantSubject=new v.xQ,this._assistantApplet=D.h.create(null),this._latestOpenAssistantParams=null,this.preloadUI=this._assistantApplet.view((e=>null==e?void 0:e.preloadUI)),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this.assistantState=this._assistantUI.view((0,r.ls)(B.ij,B.tS((()=>{var e;return B.ij(null===(e=this._latestOpenAssistantParams)||void 0===e?void 0:e.assistantMode)})),B.g_((()=>({kind:"closed"})),(e=>({kind:"opened",assistantMode:e}))))),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isTranslationAvailable=this._isTranslationAvailable.view(),this.isAvailable=D.h.combine(this._assistantServices.genAIAvailabilityService.availability.view((0,G.ff)(c._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._assistantServices.genAIAvailabilityService.availability.view((e=>e.kind===c._.Kind.disabled||e.kind===c._.Kind.unavailable?{inlineQuickReplyEnabled:!1,inlineRewriteEnabled:!1}:e.userSettings)),this.assistantInjectionMode=this._params.integration.assistantInjectionMode,this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(_.oA,b.w((e=>e.capiEvents))).subscribe(this._inboundCAPIEvents)),this._subs.add(this._params.checkingService.pipe(_.oA,b.w((e=>e.readyState)),S.h((e=>e===H.kQ.ready||e===H.kQ.firstTextCheckCompleted)),y.q(1)).subscribe((()=>this._init()))),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModels.pipe(b.w(B.g_((()=>w.E),(e=>e.onboarding.uiActions))));this._subs.add(t.pipe(S.h(Mi)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(S.h(Oi)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([d.T.StepName.initial,d.T.StepName.initialBTS]).subscribe(A.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>Ri.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(I.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(C.U((([e,t])=>t&&!function(e){const t=new Set([L.P.DATA_CONTROL_ACTIVE,L.P.OFFLINE,L.P.STAND_WITH_UKRAINE,L.P.USER_CLAIMED,L.P.USER_EDC_BLOCKED,L.P.SIGNED_OUT_GB,L.P.INACTIVE_INTEGRATION]);return null!==e&&t.has(e)}(e)))).subscribe(A.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).pipe(S.h((()=>{var e;return"genAI"===(null===(e=this._latestOpenAssistantParams)||void 0===e?void 0:e.assistantMode)}))).subscribe((()=>this._closeAssistant(K.jg.disposed)))),this._registerDebugHelpers(),this._setupAssistantAppletInstance(),this._hwrService=this._params.hwrService}_setupAssistantAppletInstance(){{if(!(0,q.X)(this._params.experimentClient))return;const e=()=>{const t=this._assistantApplet.get();this._assistantApplet.set(new Ke(this._params,this._selectionRange,this._highlightsUpdater,this._highlightsScroller,(t=>{this._closeAssistant(t),e()}),this._contextHighlight)),null==t||t.dispose()};V.C.shared.onReady.then((()=>{e()}))}}closeAssistant(e){this._closeAssistant(e)}getHoveredStateBehavior(e){return this._highlightsUpdater.getHighlightVisualState(e)}getAlertsFilter(){return this._highlightsUpdater.alertsFilter}suggestStartSessionMode(){const e=this._params.featureFlags.get();return(0,r.zG)(this._params.integration.selectionRange.get(),B.hX((t=>Ti(t)&&e.rewrite)),B.g_((()=>"ideation"),(()=>"rewrite")))}_isMergedAssistantEnabled(){return"mergedSharedAssistant"===this._params.sharedAssistantTreatment}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._openAssistantSubject.pipe(b.w((e=>(this._latestOpenAssistantParams=e,this._openAssistant(e))))).subscribe()),this._subs.add(this._params.openAssistant.subscribe(this._openAssistantSubject)),this._subs.add(this._getInlineButtonUI().subscribe(A.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(A.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(A.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getHighlightUI().subscribe(A.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(A.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(A.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(A.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(A.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(A.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this.assistantState.subscribe((e=>{ki(e)&&this._params.closeLegacyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe()),this._subs.add(this._updateTranslationIsAvailable().subscribe(A.wW(this._isTranslationAvailable)))}_handleTryItOut(){return this._onboardingViewModels.pipe(b.w(B.g_((()=>w.E),(e=>e.onboarding.uiActions))),S.h(h.l.is(h.l.Kind.tryItOut)),x.b((()=>this._openAssistantSubject.next({assistantMode:Wt(this._params.sharedAssistantTreatment),source:{kind:"onboardingSource"},genAIParams:{genAISessionMode:Ui(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?"quickReply":"ideation"}}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModels.pipe(b.w(B.g_((()=>R.of(!1)),(t=>t.onboarding.activeStep.view((0,r.ls)(B.hX((e=>e.show)),B.UI((t=>e.includes(t.name))),B.fS(r.jv)))))),k.x())}_setupIdeateTooltipStateObs(){return this._assistantServices.genAIAvailabilityService.availability.pipe(E.O(null),P.G(),C.U((([e,t])=>e&&t&&c._.isPassive(e)&&c._.isActive(t)?B.G("Youve got prompts!"):B.YP)),b.w(B.g_((()=>R.of(B.YP)),(e=>f.T(R.of(B.G(e)),R.of(B.YP).pipe(U.g(3e3))))))).subscribe(A.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){}_createOnboardingViewModelWhenCheetahAvailable(){return D.h.combine(this._params.featureFlags,this._assistantServices.genAIAvailabilityService.availability.view(c._.isUsable),((e,t)=>e.onboarding&&t)).pipe(x.b((e=>this._onboardingViewModels.modify((t=>((0,r.zG)(t,z.bw((e=>e.onboarding.dispose()))),e?B.G(this._assistantServices.createOnboardingViewModels()):B.YP))))))}_onClickIdeateButton(e){ki(this.assistantState.get())?this._closeAssistant(K.jg.closed):this._openAssistantSubject.next({assistantMode:Wt(this._params.sharedAssistantTreatment),source:{kind:"gButtonSource"},genAIParams:{genAISessionMode:e}})}_updateTranslationIsAvailable(){const{integration:e,textObserver:t,languageDetector:i,gnar:s,featureFlags:n}=this._params;return I.aj([e.selectionRange,this.assistantState.view(ki),this._assistantServices.genAIAvailabilityService.availability]).pipe(C.U((([e,t,i])=>({selectionRange:e,assistantOpened:t,availability:i}))),S.h((({assistantOpened:e,availability:t})=>!e&&c._.isUsable(t)&&n.get().inlineTranslate)),C.U((({selectionRange:e})=>e)),_.oA,S.h((e=>Ti(e))),C.U((({start:e,end:i})=>t.getTextSource().getPlainText().slice(e,i))),b.w((e=>i.isEnglish(e))),C.U((({result:e})=>null!==e&&!e)),x.b((e=>{e&&s.appActionsInlineTranslateButtonShow()})))}_updateSelectionRange(){return I.aj([this._params.integration.selectionRange,this.assistantState.view(ki)]).pipe(C.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantOpened:t}))),x.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),S.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:n,assistantOpened:a})=>!i&&!s&&(!a||(!B.Wi(e)||!t&&!n)))),C.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,I.aj([e.pipe(b.w(B.g_((()=>R.of([])),(e=>i.getHighlightRects(e).pipe(C.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(b.w(B.g_((()=>R.of([])),(e=>i.getHighlightRects(e.range).pipe(C.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(C.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return I.aj([this._selectionRange,this._highlightsUpdater.hasHighlights]).pipe(b.w((([e,t])=>(0,r.zG)(e,B.hX((()=>!t)),B.hX(N.SV.isCollapsed),B.g_((()=>R.of([])),(e=>this._params.integration.getHighlightRects(e)))))),C.U((e=>(0,r.zG)(e,n.c2,B.UI((e=>e[e.length-1]))))))}_updateNativeCursor(){return D.h.combine(this._quasiCaretRect,this._params.experimentClient.isGateEnabled($.K.UnfixFast570)?this.assistantState.view(ki):this.assistantState.view(Ei),((e,t)=>(0,r.zG)(s.Yt(B.Kw)({nativeUIHider:B.ij(this._params.integration.createNativeUIHider),quasiCaretRect:e}),B.hX((()=>t)),z.ew((()=>{this._nativeCursorHider.modify((e=>((0,r.zG)(e,z.bw((e=>e.dispose()))),B.YP)))})),z.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,r.zG)(t,z.bw((e=>e.dispose()))),B.G(e()))))})))))}_closeAssistant(e){var t,i;this._assistantUIState.set(B.YP),this._assistantUI.set(null),e!==K.jg.closed&&e!==K.jg.assistantBlurred||this._params.integration.focusTextField(),null===(t=this._params.assistantDidClose)||void 0===t||t.next(null===(i=this._latestOpenAssistantParams)||void 0===i?void 0:i.assistantMode)}async _openAssistant(e){Ae.markOpenAttempt(),ki(this.assistantState.get())&&this._closeAssistant(K.jg.disposed),this._assistantFocused.set(!0),"revision"!==e.assistantMode&&"pushRewrite"===e.genAIParams.genAISessionMode&&this._selectionRange.set(B.G(e.genAIParams.transformRange));try{const t=await this._params.getHostInfo(),i=await this._params.integration.renderAssistant((({sizeBehavior:i,dragBehavior:s,readyToDrag:n})=>{{const t=this._assistantApplet.get();if(null!=t)return t.render(e,{sizeBehavior:i,dragBehavior:s,readyToDrag:n})}const a=T.D(s).pipe(C.U((e=>"draggable"===e.kind&&e.isDragging))),{assistantHeight:l,assistantPosition:c,isPlagiarismEnabled:d,isWritingExpertEnabled:h}=this._params.integration,{gnar:p,checkingService:g,statisticsService:m}=this._params,v=new nt({isDragging:a,height:l,position:c,gnar:p,checkingService:g,statisticsService:m,integration:this._params.integration,openAssistantParams:e,supportedForms:this._params.supportedForms}),_=new Ae({sizeBehavior:i,dragBehavior:s,hostInfo:t,gnarTracking:v,onFocusStateChanged:e=>this._assistantFocused.set(e.isFocused),onReadyToDrag:e=>n(e),onVisuallyReady:()=>{var t;return null===(t=this._params.assistantDidOpen)||void 0===t?void 0:t.next(e.assistantMode)},onClose:()=>this._closeAssistant(K.jg.closed)}),b=D.h.create(B.YP),f=function(e,t,i=!1){return{performanceScoreReportShown:t=>{e.assistantPerformanceScoreReportShow(t)},feedSuccessStateShown:(i,s)=>{e.assistantSuccessStateShow(i,s,it(t))},feedFormChanged:(i,s,n)=>{switch(i){case"shortForm":e.assistantSwitchToShortFormClick(s||void 0,null===n?void 0:n,it(t));break;case"longForm":e.assistantSwitchToLongFormClick(s||void 0,null===n?void 0:n,it(t));break;default:(0,Ie.L0)(i)}},toneReportShown:({tones:i,brandTonesEnabled:s})=>{var n,a;e.emogenieReportShow(i.map((({name:e,confidence:t,prevalence:i})=>({name:e,confidence:t,prevalence:i}))),s,i.length,null!==(a=null===(n=B.WG(t.get()))||void 0===n?void 0:n.sessionUuid)&&void 0!==a?a:"")},feedLensShown:i=>{e.assistantLensShow(i,it(t))},feedLensButtonClicked:i=>{e.assistantLensButtonClick(i,it(t))},actionButtonClicked:(i,s,n,a,r)=>{e.assistantActionButtonClick(i,s,n,a,r,it(t))},moreActionsButtonClicked:(i,s,n)=>{e.assistantMoreActionsButtonClick(i,s,n,it(t))},actionButtonRendered:(s,n,a,r,o)=>{i&&e.assistantActionButtonRender(s,n,a,r,o,it(t))},actionButtonShown:(s,n,a,r,o)=>{i&&e.assistantActionButtonImpression(s,n,a,r,o,it(t))},plagiarismCitationsStyleChanged:i=>{e.assistantPlagiarismCitationsStyleChange(i,it(t))},plagiarismCitationsStyleDropdownOpened:i=>{e.assistantPlagiarismCitationsStyleDropdownOpen(i,it(t))},selectionContextHovered:()=>{e.assistantSelectionContextHover(it(t))},selectionContextClicked:()=>{e.assistantSelectionContextClick(it(t))},selectionContextRemoveButtonClicked:()=>{e.assistantSelectionContextRemoveButtonClick(it(t))},partialPageModeNotificationDismissed:G.Q1}}(p,g,this._params.experimentClient.isGateEnabled($.K.CheetahProfuseEventsTracking)),{getGenAIDeps:S,getRevisionDeps:y,getGenAIAndWritingExpertDeps:w}=Jt({openParams:e,genAISession:b,lifecycleService:_,capiService:this._assistantServices.capiService,uphookService:this._assistantServices.uphookService,feedbackService:this._assistantServices.feedbackService,experimentService:this._assistantServices.experimentService,textEditorService:this._assistantServices.textEditorService,userService:this._assistantServices.userService,notifyAssistantUIAction:this._assistantServices.notifyAssistantUIAction,getSDUIBuffer:this._params.getSDUIBuffer,inboundCAPIEvents:this._inboundCAPIEvents,alertProcessor:this._params.alertProcessor,initialAlertId:lt(e),highlightsUpdater:this._highlightsUpdater,highlightsScroller:this._highlightsScroller,replacementServiceInjector:this._params.replacementServiceInjector,getFormattingService:this._params.getFormattingService,requestAwaitService:this._params.requestAwaitService,alertStateService:this._params.alertStateService,supportedForms:this._params.supportedForms,isSharedAssistantEnabled:null!==this._params.sharedAssistantTreatment,selectionContextAvailabilityService:this._assistantServices.selectionContextAvailabilityService,toneDetectorService:this._assistantServices.toneDetectorService,settingsService:this._params.settingsService,genAIAvailabilityService:this._assistantServices.genAIAvailabilityService,url:this._params.url,disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState,getQuickReplyContext:()=>this._params.integration.quickReplyContext.get(),experimentClient:this._params.experimentClient,dynamicConfig:this._params.dynamicConfig,skillService:this._params.skillService,isPlagiarismEnabled:d,isWritingExpertEnabled:h,trackingService:f,textObserver:this._params.textObserver,hwrService:this._hwrService,isTranslationAvailable:this._isTranslationAvailable.get(),capiStartAckMessage:this._params.capiStartAckMessage}),A=(0,u.S)((0,r.zG)(e,(e=>{switch(e.assistantMode){case"genAI":return{dispose:r.Q1,...S(e.genAIParams)};case"revision":return y();case"genAIAndRevision":return(0,r.zG)(y(),(t=>({...S(e.genAIParams),...t,kind:"genAIAndRevision",capiService:this._assistantServices.capiService})));case"genAIAndWritingExpert":return{dispose:r.Q1,...w(e.genAIParams)}}}),(e=>({...e,theme:D.h.create({useIframeTextfieldWrapper:this._params.experimentClient.isGateEnabled($.K.OggyIframeWrappers)}),dispose:()=>{var t;null===(t=e.dispose)||void 0===t||t.call(e),_.dispose(),this._assistantFocused.set(!1)}}))));return this._assistantUIState.set(B.G({genAISession:b,dragBehavior:T.D(s)})),o.createElement(A,null)}),e.assistantMode);this._assistantUI.set(o.createElement(li,null,i))}catch(e){this._log.error("failed to open assistant",e),this._assistantUIState.set(B.YP),this._assistantUI.set(null)}}_getInlineButtonUI(){return(0,r.zG)(s.Yt(W.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:f.T(this._params.integration.selectionRange.pipe(C.U((e=>(0,r.zG)(e,B.pC)))),this._params.integration.selectionRange.pipe(M.b(100),O.h(!1))),assistantOpened:this.assistantState.view(ki),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._assistantServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(C.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantOpened:s,textMapIsEmpty:n,quickReplyContext:a,availability:l,entryPointsEnabled:d,featureFlags:h})=>(0,r.zG)(e,B.hX((()=>d)),B.hX((()=>!s)),B.hX((()=>c._.isUsable(l))),B.g_(r.gn,(e=>(0,r.zG)(t,B.g_(r.gn,(t=>{if(n&&B.pC(a)&&h.inlineQuickReply)return o.createElement(bi,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:B.WG(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(qt(Wt(this._params.sharedAssistantTreatment),"quickReply",{kind:"inlineQuickReplySource"}))}});if(Ti(t)&&(h.inlineRewrite||h.magicRewrite)&&this._params.integration.enableInlineRewrites){const t=h.inlineTranslate&&this._isTranslationAvailable.get(),s=h.magicRewrite&&!t;return o.createElement(vi,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:B.WG(e.offset),onOpenRewriteClick:h.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(qt(Wt(this._params.sharedAssistantTreatment),"rewrite",{kind:"inlineRewriteSource"}))}:void 0,onMagicRewriteClick:s?()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(qt(Wt(this._params.sharedAssistantTreatment),"quickRewrite",{kind:"inlineQuickRewriteSource"}))}:void 0,onOpenTranslateClick:t?()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(qt(Wt(this._params.sharedAssistantTreatment),"translate",{kind:"inlineTranslateSource"}))}:void 0})}return null})))))))))}_getOnboardingUI(){const e=this._params.featureFlags.get().externalOnboardingContextProviderFix?ci:li;return this._onboardingViewModels.view(B.g_(r.gn,(t=>o.createElement(e,null,j.UI.mount(p.T,(0,g.A)(t))))))}_getHighlightUI(){return D.h.combine(this._highlights,this.assistantState.view(ki),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>o.createElement(hi,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return D.h.combine(this._quasiCaretRect,this._params.experimentClient.isGateEnabled($.K.UnfixFast570)?this.assistantState.view(ki):this.assistantState.view(Ei),((e,t)=>(0,r.zG)(e,B.hX((()=>t)),B.g_((()=>null),(e=>o.createElement(wi,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getButtionUI(e){return D.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((t,i,s,n,a,o)=>(0,r.zG)(i,B.DT((e=>null===e)),B.hX((()=>o&&t.ideateButton)),B.hX((()=>c._.isUsable(a))),B.g_(r.gn,(()=>e(s,n,t))))))}_getIdeateButtonUI(){return this._getButtionUI(this._getIdeateButtonForSelectionRange.bind(this))}_getExpandedIdeateButtonUI(){return this._isMergedAssistantEnabled()?D.h.create(null):D.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,n)=>(0,r.zG)(s,B.DT((e=>c._.isVisible(e))),B.hX((()=>n&&e.ideateButton)),B.g_(r.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._isMergedAssistantEnabled()?null:(0,r.zG)(e,B.hX((e=>Ti(e)&&i.rewrite)),B.g_((()=>Ui(t)&&i.quickReply?"quickReply":i.compose?"ideation":null),(()=>"rewrite")),B.ij,B.g_(r.gn,(e=>o.createElement(Ci,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(B.FS)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e,t;this._disposed.next(null),this._highlightsUpdater.dispose(),this._closeAssistant(K.jg.disposed),null===(e=B.FS((0,r.zG)(this._onboardingViewModels.get(),B.UI((e=>e.onboarding)))))||void 0===e||e.dispose(),this._assistantServices.dispose(),null===(t=this._assistantApplet.get())||void 0===t||t.dispose(),this._subs.unsubscribe(),(0,r.zG)(this._nativeCursorHider.get(),z.bw((e=>e.dispose()))),this._params.integration.dispose()}}function Ui(e){return(0,r.zG)(e,B.Gg((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function Ti(e){const t=e.end-e.start;return t>=10&&t<5e3}function Mi(e){return(0,G.W9)(h.l.is(h.l.Kind.mount),(e=>e.step===d.T.StepName.initial))(e)}function Oi(e){return(0,G.W9)(h.l.is(h.l.Kind.mount),(e=>e.step===d.T.StepName.initialBTS))(e)}},12776:(e,t,i)=>{if(i.d(t,{P:()=>T,l:()=>M}),3075==i.j)var s=i(90023);var n=i(60841),a=i(73863),r=i(65647),o=i(55446),l=i(36880);if(3075==i.j)var c=i(14765);if(3075==i.j)var d=i(20715);if(3075==i.j)var h=i(10859);if(3075==i.j)var u=i(27628);var p=i(58303),g=i(4603);if(3075==i.j)var m=i(74983);var v=i(70874),_=i(30033);if(3075==i.j)var b=i(18300);var f=i(91901);class S{constructor(e,t=[f.$x]){this._doc=e,this._styleEl=this._doc.createElement("STYLE"),this._styleEl.innerHTML=t.map((e=>`${e}{opacity:0 !important;}`)).join("\n"),this._doc.head.appendChild(this._styleEl)}dispose(){this._styleEl.remove()}}var y=i(76193);if(3075==i.j)var w=i(22342);var A=i(49650),I=i(4798),C=i(70932),x=i(33535),R=i(8783),k=i(49231);if(1388==i.j)d=i(20715);var E=i(43818),P=i(99469);const U=({position:e,beforeElement:t,children:i,enableKeyboardShortcut:s,keyboardShortcutsSetting:n,closeAssistant:a,focusTextField:r})=>{const o=(0,P.$)({enableKeyboardShortcut:s,keyboardShortcutsSetting:n,closeAssistant:a,focusTextField:r});return k.createElement("div",{"data-grammarly-part":"assistant-static-wrapper",style:{display:"flex",flexDirection:"column",position:"fixed",top:e.top,bottom:e.bottom,left:e.left,right:e.right,width:e.width,height:e.height,zIndex:e.zIndex},ref:o},t?k.createElement(t,null):void 0,k.createElement("div",{style:{flexGrow:1,minHeight:0}},i({sizeBehavior:d.of({heightBehavior:{kind:"fitContainer"},widthBehavior:{kind:"fitContainer"}}),dragBehavior:d.of({kind:"notDraggable"}),readyToDrag:()=>Promise.resolve(void 0)})))};class T extends R.B{constructor(e){super({...e,docContextUpdatedEvents:p.YP,allowCustomCaretOverflow:!1,focusTextField:()=>e.textField.click(),logger:C.Y.create("CheetahIntegrationGDocsCanvas")}),this._sidebarPosition=e.sidebarPosition;const t=e.experimentClient.isGateEnabled(I.K.GDocsAllowToDetectAssistantInjectionMode);this.assistantInjectionMode=this._sidebarPosition.view((({sidebarType:e})=>t&&e===y.X.modern?x.M.inherit:x.M.overlay)),this._scroller=(0,A.z)(e.textObserver,e.textFieldLayout,e.userInputShutOff),this._isDocOwnedByCurrentUser=e.isDocOwnedByCurrentUser}_scrollToRenderedRect(e){const t=_.Pf.create(e),i=this._textFieldLayout.visibleRect.getApproximate().client.top-this._textFieldLayout.rect.getApproximate().client.top;this._scroller.scrollToRect(t,i)}_scrollToUnrenderedHighlight(e){this._scroller.scrollToRange(e.start).pipe(n.w((t=>v.S.hz30.pipe(a.q(9),n.w((()=>this.getHighlightRects(e))),r.U((e=>null==e?void 0:e[0])),o.h((e=>!!e)),a.q(1)))),l.R(this._disposed)).subscribe((e=>{this._scrollToRenderedRect(e)}))}isDocOwnedByCurrentUser(){return this._isDocOwnedByCurrentUser}scrollHighlightIntoView(e){this.getHighlightRects(e).pipe(r.U((e=>null==e?void 0:e[0])),a.q(1),l.R(this._disposed)).subscribe((t=>{t?this._scrollToRenderedRect(t):this._scrollToUnrenderedHighlight(e)}))}createNativeUIHider(){return new S(document)}renderAssistant(e,t){return"genAI"===t||"genAIAndWritingExpert"===t?super.renderAssistant(e,t):Promise.resolve(((e,t,i,s,n,a,o)=>k.createElement(E.F.Fragment,null,t.pipe(r.U((t=>k.createElement(U,{key:"assistant-container",position:t,beforeElement:o,enableKeyboardShortcut:i,keyboardShortcutsSetting:s,closeAssistant:n,focusTextField:a},e))))))(e,this._sidebarPosition,this._enableKeyboardShortcut,this._params.csState.view("page").view("keyboardShortcuts"),this._params.closeAssistant,this.focusTextField.bind(this)))}canResizeAssistant(e){return"genAI"===e||"genAIAndWritingExpert"===e}get isPlagiarismEnabled(){return!0}get isWritingExpertEnabled(){return(0,g.OB)().experimentClient.isGateEnabled(I.K.WritingExpertPullMode)}dispose(){this._scroller.dispose(),super.dispose()}}function M(e,t,i,a){return a.data.behavior.pipe(c.O(null),n.w((()=>(0,s.zG)(i.getCurrentSelection(!0),b.Ls,p.ij,p.hX((0,s.ff)(m.SV.isCollapsed)),p.g_((()=>function(e,t){return e.contentChanges.async.pipe(c.O(null),u.c(t.offsetPosition.pipe(r.U((0,s.ls)(p.ij,p.tS((t=>{const i=e.getCurrentTextMap();if(i.isEmpty())return p.G(0);const n=2,a=1;return(0,s.zG)(p.ij(i.getPageContainingOffsetPoint(t)),p.tS((e=>p.ij((0,s.zG)((0,w.WR)({top:t.top-a/2-e.getPageRect().top,left:t.left-n/2-e.getPageRect().left,width:n,height:a},e.getPageInnerSize(),e.getPageRect()),(t=>{var i,s;return null===(s=null===(i=e.getTextRangeInInnerRect)||void 0===i?void 0:i.call(e,t))||void 0===s?void 0:s.startOffset}))))))})))))))}(e,t).pipe(r.U(p.UI(m.SV.create)))),(e=>d.of(p.G(e))))))),h.skipBy(p.Eh(m.SV.eq)))}},50036:(e,t,i)=>{i.d(t,{K:()=>c});var s,n=i(21220);!function(e){e.postMessage="postMessage",e.setMessagePort="setMessagePort",e.setSource="setSource"}(s||(s={}));class a{constructor(e,t){this._didReceiveReadyMessage=!1,this._onMessageListeners=[],this._pendingOutgoingMessages=[],this._onMessageFromAnySource=e=>{null!=e.source&&e.source===this._iframe.contentWindow&&this._onMessage(e)},this._flushPendingOutgoingMessages=()=>{if(this._didReceiveReadyMessage&&0!==this._pendingOutgoingMessages.length&&null!=this._iframe.contentWindow){for(const e of this._pendingOutgoingMessages)this._iframe.contentWindow.postMessage(e,this._iframeTargetOrigin);this._pendingOutgoingMessages.length=0}},this._iframe=e,this._trustedSrcURL=t,self.addEventListener("message",this._onMessageFromAnySource)}setSrcURL(e){this._trustedSrcURL=e}get _iframeTargetOrigin(){const e=new URL(this._iframe.src,self.location.href).toString();if(!this._trustedSrcURL||!this._trustedSrcURL.startsWith(e))throw new Error("Invalid iframe target origin");return e}_onMessage(e){this._didReceiveReadyMessage=!0,this._onMessageListeners.forEach((t=>t(e.data))),this._flushPendingOutgoingMessages()}postMessage(e){null!=this._iframe.contentWindow&&this._didReceiveReadyMessage?(this._flushPendingOutgoingMessages(),this._iframe.contentWindow.postMessage(e,this._iframeTargetOrigin)):this._pendingOutgoingMessages.push(e)}onMessage(e){this._onMessageListeners.push(e)}dispose(){self.removeEventListener("message",this._onMessageFromAnySource),this._onMessageListeners.length=0,this._pendingOutgoingMessages.length=0}}class r extends a{_onMessage(e){if(!this._isMessagePortSet&&null!=this._iframe.contentWindow){const e={type:s.setMessagePort,port:this._channel.port2};this._isMessagePortSet=!0,this._iframe.contentWindow.postMessage(e,this._iframeTargetOrigin,[this._channel.port2])}return super._onMessage(e)}constructor(e,t){super(e,t),this._isMessagePortSet=!1,this._channel=new MessageChannel,this._channel.port1.onmessage=e=>{this._onMessage(e)}}dispose(){super.dispose(),this._channel.port1.close()}}class o{constructor(e,t){const i=null!=t?t:document.createElement("iframe"),s=e.baseUri+"src/gOS-sandbox.html";i.loading="eager",i.allow="clipboard-read *; clipboard-write *",i.src=s,i.width="100%",i.height="100%",i.style.border="none",i.setAttribute(n.MY,"applet-iframe"),this._frame=i,this._messenger=new r(i,s),this._shouldDetach=null==t}setSource(e){this._messenger.postMessage({type:s.setSource,url:e})}resize(e){}postMessage(e){this._messenger.postMessage({type:s.postMessage,data:e})}onMessage(e){this._messenger.onMessage(e)}dispose(){this._messenger.dispose(),this._shouldDetach&&this._frame.remove()}get frame(){return this._frame}}var l=i(4603);class c{constructor(e,t=(0,l.OB)().browserApi){this._usingFrame=e,this._api=t}createBackgroundSandbox(e,t){throw new Error("Not supported")}createUISandbox(e,t){return new o(this._api,this._usingFrame)}}},96601:(e,t,i)=>{i.d(t,{C:()=>x});var s=i(78498);var n=i(30646);class a extends n.Ic{constructor(e){super(),this._options=e,this.register({id:"assistant",kind:"ui",displayName:"Assistant",version:"0.0.0",entryPoint:"https://applet-bundles.grammarly.net/applets/assistant?responseType=redirect"})}get(e){const t=super.get(e);if(null!=t)return this._patchEntryPoint(t)}all(){return super.all().map((e=>this._patchEntryPoint(e)))}_patchEntryPoint(e){var t,i;const s=new URL(null!==(t="assistant"===e.id?this._getAssistantAppletUrl():null)&&void 0!==t?t:e.entryPoint);return s.searchParams.set("api",String(n.IS.version)),s.searchParams.set("channel",null!==(i=this._options.getChannel())&&void 0!==i?i:"stable"),{...e,entryPoint:s.toString()}}_getAssistantAppletUrl(){const e=this._options.getAssistantAppletUrl();if(null==e)return null;try{return new URL(e).toString()}catch(e){return null}}}var r=i(74722),o=i(33674),l=i(79992),c=i(18333),d=i(4603);class h extends o.X{constructor(){const e=l.iy.create();super(new r.rr(c.XI,(0,d.OB)().message,e)),this.id=e}}var u=i(4798),p=i(99836),g=i(70932);function m(e,t){const{bgRpc:i,experimentClient:s}=t,{buildInfo:n,bundleInfo:a}=t.config;let r=a.env.startsWith("dev")||!1;return e.get(["extensionSettings"]).then((({extensionSettings:e})=>{var t;r=null!==(t=null==e?void 0:e.common.gOSDebuggerEnabled)&&void 0!==t&&t})),{environment:v(a.env),async getContainerId(){var e;return null!==(e=await i.api.getContainerIdOrUndefined())&&void 0!==e?e:""},async getUserId(){var t,i;return null!==(i=null===(t=(await e.get(["user"])).user)||void 0===t?void 0:t.id)&&void 0!==i?i:"-1"},clientName:a.extensionType,clientVersion:n.version,clientType:"extension",get isDebugMode(){return r},openURL(e){},makeLogger:e=>function(e,t,i){return{log(n,a,r,o,l,c,d){const h=l>0?`${a} (${d} at ${o}:${l}:${c})`:a;switch(n){case"debug":t.debug(h,r);break;case"info":t.info(h,r),s.isGateEnabled(u.K.GOSTelemetry)&&i.gOS.info(e,h,r);break;case"warn":t.warn(h,r),s.isGateEnabled(u.K.GOSTelemetry)&&i.gOS.warn(e,h,r);break;case"error":t.error(h,r),s.isGateEnabled(u.K.GOSTelemetry)&&i.gOS.error(e,h,r)}}}}(e,g.Y.create(`applet/${e}`),(0,p.Tb)()),makePerformanceTracker:()=>({})}}function v(e){return"dev-qa"===e||"qa"===e?"qa":"dev-preprod"===e?"preprod":"prod"}var _=i(30152),b=i(51777);function f(e,t){return JSON.stringify({clientId:e,instanceId:t})}class S extends b.S{constructor(e,t){super(new y(c.V,(0,d.OB)().message,e.id),{dispatchAction:({clientId:e},i,s,n)=>t.dispatchAction(f(e,i),s,n),dispose:({clientId:e},i)=>t.dispose(f(e,i))})}}class y{constructor(e,t,i){this._rpcMessageName=e,this._message=t,this._clientId=i,this.inbound=new _.y((e=>{const t=t=>{t.clientId===this._clientId&&e.next(t)};return this._message.on(this._rpcMessageName,t),()=>this._message.off(this._rpcMessageName,t)})),this.outbound=e=>{this._message.sendBackground(this._rpcMessageName,e)}}}class w{constructor(e){this._host=e}_getContainerFor(e){const t=this._host.getAppletContainer(e);if(null==t)throw new Error(`No applet container for context ${e}`);return t}async dispatchAction(e,t,i){const s=this._getContainerFor(e),n=t.split(".").slice(0,-1).join(".");return null==s.objects.get(n)?await s.rpc.call(t,i):await s.objects.execute(t,i)}async dispose(e){}}var A=i(50036);class I{constructor(e,t,i){this._container=e,this._delegates=t,this._logger=i}get _isResizable(){var e,t,i;return null===(i=null===(t=(e=this._delegates).canResize)||void 0===t?void 0:t.call(e))||void 0===i||i}async initialize(e){var t,i;const s=this._resize(e.initialSize),n=await this._container.createInitializeResponse(e);return null===(i=(t=this._delegates).onInit)||void 0===i||i.call(t,e),{...n,platform:"extension",frame:{...s,resizable:this._isResizable?"both":"none"}}}async visuallyReady(){var e,t;null===(t=(e=this._delegates).onVisuallyReady)||void 0===t||t.call(e)}async interactionReady(e){var t,i,s;null===(i=(t=this._delegates).onInteractionReady)||void 0===i||i.call(t,e.success,null!==(s=e.feature)&&void 0!==s?s:void 0)}async resizeFrame(e){this._isResizable&&this._resize(e)}async resize(e){return{frame:{...this._resize(e.size),resizable:this._isResizable?"both":"none"}}}_resize(e){var t,i,s,n,a,r,o;const{width:l,height:c}=null!==(s=null===(i=(t=this._delegates).handleResize)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:{width:Math.max(null!==(a=null===(n=this._container.view.frame.parentElement)||void 0===n?void 0:n.clientWidth)&&void 0!==a?a:0,e.width),height:0===e.height?null!==(o=null===(r=this._container.view.frame.parentElement)||void 0===r?void 0:r.clientHeight)&&void 0!==o?o:0:e.height};return this._container.view.resize({width:l,height:c}),{width:l,height:c}}async requestClose(){var e,t;this._container.manifest.id;null===(t=(e=this._delegates).onClose)||void 0===t||t.call(e),setTimeout((()=>{this._container.gracefullyUnloadApplet().finally((()=>{var e,t;return null===(t=(e=this._delegates).onTerminate)||void 0===t?void 0:t.call(e)}))})),this._container.view.frame.style.display="none"}async startDragMove(e){var t,i;await(null===(i=(t=this._delegates).onDragMove)||void 0===i?void 0:i.call(t,null==e?void 0:e.clickTarget))}async log(e){this._logger.log(e.level,e.message,e.data,"",-1,-1,"")}async openURL(e){if(null==self.open(e.url,"_blank","noopener"))throw new Error("Failed to open URL")}async triggerSettingsMenu(e){var t,i;null===(i=(t=this._delegates).onSettingsMenu)||void 0===i||i.call(t)}}class C{constructor(e,t,i){this.registry=i,this._nextInstanceId=0,this._running=new Map,this._logger=g.Y.create("GOSRuntimeHost"),this._root=new n._y(e,i).withContainerFactory(new A.K),this._background=t}createContext(){return new n._y(this._root)}getAppletContainer(e){return this._running.get(function(e){return JSON.parse(e)}(e).instanceId)}createUIAppletContainer(e,t={},i=this._root,s=!0){const a=this._nextInstanceId++;this._registerForwardingServices(i,((e,t)=>this._background.dispatchAction(a,e,t)));const r=i.createAppletView(e);this._running.set(a,r);const o=new n.GO(((e,t)=>r.rpc.call(e,t))),l=i.environment.makeLogger(e),c=new I(r,{...t,onVisuallyReady:()=>{var e;null===(e=t.onVisuallyReady)||void 0===e||e.call(t),s&&o.start({entryPoint:"ideation",entryPoint2:"ideation",assistantMode:"genAIAndRevision",theme:{flatUI:!0,logoVersion:"february2024"},partialPageModeEnabled:!1,showPartialPageModeNotification:!1}).catch((e=>this._logger.error(e)))}},l);return r.objects.register(n.xe.objectName,new n.xe(c)),r.onBeforeUnload((()=>{this._running.delete(a),this._background.dispose(a)})),{applet:r,host:c,start:async e=>await o.start(e)}}forceTerminate(e){this._logger.warn(`Force terminating applet: ${e.manifest.id}`),this._running.forEach(((t,i)=>{t===e&&this._running.delete(i)}));try{e.unloadApplet(),e.objects.dispose(),e.rpc.dispose()}catch(e){this._logger.error(`Failed to force terminate applet: ${e}`)}}_registerForwardingServices(e,t){e.registerObject(n.Wr.objectName,new n.Wr(new n.ik(t))),e.registerObject(n.Ng.objectName,new n.Ng(new n.c3(t))),e.registerObjectFactory(n.HF.objectName,(()=>new n.HF(new n._2(t))))}}class x{static get shared(){return null===this._instance&&(this._instance=new x(new s.h((0,d.OB)().browserApi.preferences))),this._instance}constructor(e){this.store=e,this._cache=null,this.onReady=e.get(["extensionSettings"]).then((({extensionSettings:e})=>{this._settings=e})).catch((()=>{}))}get _state(){return null===this._cache&&(this._cache=this._create()),this._cache}_create(){const e=new a({getChannel:()=>{var e,t;return null!==(t=null===(e=this._settings)||void 0===e?void 0:e.common.gOSAppletChannel)&&void 0!==t?t:"stable"},getAssistantAppletUrl:()=>{var e,t;return null!==(t=null===(e=this._settings)||void 0===e?void 0:e.common.gOSAssistantAppletUrl)&&void 0!==t?t:null}}),t=new h,i=new C(m(this.store,(0,d.OB)()),t.api,e);return{registry:e,client:t,host:i,server:new S(t,new w(i))}}get registry(){return this._state.registry}get host(){return this._state.host}dispose(){null!==this._cache&&(Object.values(this._cache).forEach((e=>"dispose"in e&&e.dispose())),this._cache=null)}}x._instance=null},15281:(e,t,i)=>{i.d(t,{wr:()=>l});var s=i(90023),n=i(69425),a=i(52256),r=i(58303);class o{constructor(e){this._options=e}partialPageModeNotificationDismissed(e){return Promise.resolve()}async getCapabilities(){var e;const t=JSON.parse(JSON.stringify(null!==(e=this._options.capabilities)&&void 0!==e?e:{}));switch(this._options.type){case"plaintext":return{insertText:"yes",insertTextWithFormatting:"no",insertTextWithImages:"no",insertTextWithLinks:"no",...t,pasteImages:"no"};case"richtext":return{insertText:"yes",insertTextWithFormatting:"unknown",insertTextWithImages:"unknown",insertTextWithLinks:"unknown",...t,pasteImages:"no"};case"gDocs":return{insertText:"yes",insertTextWithFormatting:"yes",insertTextWithImages:"yes",insertTextWithLinks:"yes",...t,pasteImages:"no"}}}async setSelection({range:e}){this._options.setSelection(e)}async getDocumentState({withSelection:e}){var t;let i;e&&(i=null!==(t=this._options.getSelection().find(Boolean))&&void 0!==t?t:{start:0,end:0});return{doc:{ops:this._options.getText().ops},selection:i}}async pasteImage(e){throw new Error("Not supported")}async _copyToClipboard(e){const t={};["image/png","text/html","text/plain"].includes(e.type)?t[e.type]=e:(t[`web ${e.type}`]=e,e.type.startsWith("image/")&&(t["text/html"]=new Blob([`<img src="${URL.createObjectURL(e)}">`],{type:"text/html"}))),await navigator.clipboard.write([new ClipboardItem(t)])}async copyImage({data:e,format:t}){const i=await async function(e,t){if(!["png","gif","jpeg"].includes(e))throw new Error(`Unsupported format: ${e}`);const i=await fetch(`data:image/${e};base64,${t}`);return await i.blob()}(t,e);await this._copyToClipboard(i)}async copyText({text:e}){await navigator.clipboard.writeText(e)}async insertText({text:e}){await this._options.replaceText(e)}async insertAtCaret({delta:e}){"gDocs"===this._options.type?await this._options.insertAtCaret(new n.i(e.ops)):await this._options.replaceText(new n.i(e.ops))}async applyDelta({delta:e,range:t}){await this._options.replaceText(new n.i(e.ops),t)}}function l(e){var t;const i=null!==(t=e.capabilities)&&void 0!==t?t:{};return new o({type:e.replacementService.capabilities,capabilities:{insertText:c(i.insertText),insertTextWithFormatting:c(i.insertTextWithFormatting),insertTextWithImages:c(i.insertTextWithImages),insertTextWithLinks:c(i.insertTextWithLinks),pasteImages:c(i.pasteImages)},getSelection:()=>(0,s.zG)(e.selectionRange.get(),a.dH((e=>[e]),[])),setSelection:async t=>{if("setSelectionAsync"in e.selectionService){const i=await e.selectionService.setSelectionAsync(t);if("selectionError"===i.kind)throw new Error(i.reason)}else e.selectionService.setSelection(t)},getText:()=>e.textObserver.getTextSource().getRichText(),insertAtCaret:async t=>e.replacementService.insertAtCurrentSelection(t,void 0,{gOS:{appletId:e.appletId}}),replaceText:async(t,i)=>{await e.replacementService.performReplacement({pos:null!=i?i:(0,s.zG)(e.selectionRange.get(),r.fS((()=>({start:0,end:0})))),value:t},{gOS:{appletId:e.appletId}})}})}function c(e){if("yes"===e||"no"===e||"unknown"===e)return e}},18333:(e,t,i)=>{i.d(t,{V:()=>n,XI:()=>s,xh:()=>a});const s="gOS-bg-d5ccc5edf7e1",n="gOS-fg-d5ccc5edf7e1",a="skills-bg-d5ccc5edf7e1"},92203:(e,t,i)=>{i.d(t,{V:()=>a,X:()=>r});var s=i(4798),n=i(81259);function a(e){return e.isGateEnabled(s.K.GOSRollout)||"test"===e.getTreatment(n.p.GOSRollout)}function r(e){return!!a(e)&&(e.isGateEnabled(s.K.OggyOnGOS)||"test"===e.getTreatment(n.p.OggyOnGOS))}},41274:(e,t,i)=>{i.d(t,{V:()=>s});i(97855);const s=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g},58454:(e,t,i)=>{if(i.d(t,{LJ:()=>v,Nd:()=>o,Ov:()=>m,TW:()=>S,Ur:()=>l,Xs:()=>y,e$:()=>b,eg:()=>f,fN:()=>h,k6:()=>p,kh:()=>d,lW:()=>_,lz:()=>u,qg:()=>r,uj:()=>a,uz:()=>g}),3075==i.j)var s=i(73104);var n=i(91901);function a(e){const t=(0,s.Cq)(e.querySelector(n.XG),"text buffer iframe");return(0,s.Cq)(t.nodeType===Node.ELEMENT_NODE&&"IFRAME"===t.tagName?t.contentDocument:void 0,"text buffer iframe document")}function r(e){const t=o(e);return{width:t?t.offsetWidth-t.clientWidth:0,height:t?t.offsetHeight-t.clientHeight:0}}function o(e){return e.querySelector(n.Wp)}function l(e,t,i){return t?function(e,t){if(t&&c(t))return t;const i=e.querySelectorAll(n.Qy);for(const e of i)if(c(e))return e;return null}(e,i):e.querySelector(n.Qy)}const c=e=>e.checkVisibility?e.checkVisibility():e.parentElement&&"none"!==e.parentElement.style.display;function d(e){return e.querySelectorAll(n.gH)}function h(e){return e.querySelector(n.gH)}function u(e){return Boolean(e.querySelector(n.gH))}function p(e){let t=e.querySelector(n.os);return t||(t=document.querySelector(n.gH)),t?t.getBoundingClientRect():null}const g=e=>!!e.querySelector(n.Lq);function m(e){return e.querySelector(n.$x)}function v(e){return null==e?void 0:e.querySelector(n.y1)}function _(e){const t=e.querySelector(n.f);return!!t&&t.offsetHeight>0}function b(e){return!!e.querySelector(`${n.jW}, ${n.F8}`)}function f(){const e=document.querySelector(n.d0),t=(null==e?void 0:e.classList.contains(n.uj))?"edit":void 0,i=(null==e?void 0:e.classList.contains(n._m))?"suggesting":void 0;return t||i||"other"}function S(e){return e.querySelector(n.QR)}function y(e){return e.querySelector(n.ij)}},91901:(e,t,i)=>{i.d(t,{$x:()=>r,F8:()=>m,Go:()=>n,Kt:()=>y,Lq:()=>c,QR:()=>R,Qy:()=>_,Vk:()=>w,Wp:()=>s,XG:()=>a,_m:()=>u,d0:()=>d,f:()=>l,gH:()=>v,gL:()=>A,ij:()=>x,j5:()=>S,jW:()=>g,l$:()=>p,lO:()=>C,os:()=>f,rx:()=>I,uj:()=>h,y1:()=>o,yw:()=>b});const s=".kix-appview-editor",n=".docos-input",a=".docs-texteventtarget-iframe",r=".kix-cursor",o=".kix-cursor-caret",l="#docs-revisions-sidebar",c='#docs-toolbar-mode-switcher[aria-label="Viewing mode"]',d="#docs-toolbar-mode-switcher",h="edit-mode",u="suggest-mode",p="titlebar-mode-indicator-container",g="#titlebar-mode-indicator-container .titlebar-request-access-button",m="#titlebar-mode-indicator-container .kix-titlebar-request-access-button",v="canvas.kix-canvas-tile-content:not(.docs-ui-unprintable *)",_=".kix-rotatingtilemanager:not(.docs-ui-unprintable *)",b=".kix-page-paginated",f=".kix-page-paginated.canvas-first-page",S=".docs-horizontal-ruler",y=".docs-vertical-ruler",w="#fontSizeSelect input",A=".docs-ruler-background",I=".docs-ruler-background-inner",C=".docs-ruler-indent-first-line",x=".modal-dialog.docs-dialog .fatal-error-message",R='#docs-titlebar-share-client-button div[role="button"]'},76193:(e,t,i)=>{var s;i.d(t,{X:()=>s}),function(e){e.modern="modern",e.legacy="legacy"}(s||(s={}))},78285:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(49231),n=i(9074),a=i(80724),r=i(10859),o=i(58303);const l=({children:e,remSize:t,setter:i})=>(c+=1,s.useEffect((()=>{const e=t.subscribe((e=>{d.next(o.G(e)),i(o.G(e))}));return()=>{e.unsubscribe(),c-=1,0===c&&(d.next(o.YP),i(o.YP))}}),[t]),s.createElement(n.u.Context.Provider,{value:d.pipe(a.oA)},e));let c=0;const d=new r.BehaviorSubject(o.YP)},22342:(e,t,i)=>{i.d(t,{WR:()=>f,th:()=>_});var s=i(18117),n=i(39953),a=i(58303),r=i(52256);if(3075==i.j)var o=i(59833);if(3075==i.j)var l=i(4603);if(3075==i.j)var c=i(54115);if(3075==i.j)var d=i(30033);if(3075==i.j)var h=i(87234);var u=i(58454);if(3075==i.j)var p=i(25079);if(3075==i.j)var g=i(4798);var m=i(91901);const v={getCursorRect:()=>(0,n.zG)(a.ij(document.querySelector(m.y1)),a.UI((e=>e.getBoundingClientRect())),a.WG),getCanvasRect:(e,t)=>t?(0,u.k6)(e):(0,n.zG)(a.ij(document.querySelector(m.os)),a.wp((()=>a.ij(document.querySelector(m.gH)))),a.UI((e=>e.getBoundingClientRect())),a.WG),getFirstLineIndentEl:e=>e.querySelector(m.lO),getFontSizeInputEl:()=>document.querySelector(m.Vk),getRulerBackgroundsRects:e=>(0,n.zG)(s.Yt(a.Kw)({backgroundRect:(0,n.zG)(a.ij(e.querySelector(m.gL)),a.UI((e=>e.getBoundingClientRect()))),innerBackgroundRect:(0,n.zG)(a.ij(e.querySelector(m.rx)),a.UI((e=>e.getBoundingClientRect())))}),a.WG),withVisibleRulers:e=>{const t=(0,n.zG)(s.Yt(a.Kw)({horizontalRuler:a.ij(document.querySelector(m.j5)),verticalRuler:a.ij(document.querySelector(m.Kt))}),a.UI((({horizontalRuler:e,verticalRuler:t})=>({horizontalRuler:{node:e,opacity:e.style.opacity,display:e.style.display},verticalRuler:{node:t,opacity:t.style.opacity,display:t.style.display}}))),r.bw((({horizontalRuler:e,verticalRuler:t})=>{"none"===e.display&&(e.node.style.opacity="0",e.node.style.removeProperty("display")),"none"===t.display&&(t.node.style.opacity="0",t.node.style.removeProperty("display"))})));try{return e((0,n.zG)(t,a.UI((({verticalRuler:e})=>e.node)),a.WG),(0,n.zG)(t,a.UI((({horizontalRuler:e})=>e.node)),a.WG))}finally{(0,n.zG)(t,r.bw((({horizontalRuler:e,verticalRuler:t})=>{e.node.style.display=e.display,e.node.style.opacity=e.opacity,t.node.style.display=t.display,t.node.style.opacity=t.opacity})))}}};class _{constructor(e,t,i=v){this._layoutRoot=e,this._telemetry=t,this._gDocsDOM=i,this._refactorGetCanvasRectEnabled=(0,l.OB)().experimentClient.isGateEnabled(g.K.GdocsRefactorDomQuery),this._returnAllRects=(0,l.OB)().experimentClient.isGateEnabled(g.K.GdocsReturnAllRects)}create(e,t){try{if(t.isEmpty()&&0===e.start&&0===e.end)return{rects:(0,n.zG)(a.ij(t.getPageContainingOffset(0)),a.tS((e=>(0,n.zG)(a.ij(this._gDocsDOM.getCursorRect()),a.hX((e=>e.left>0&&e.top>0&&e.height>0)),a.tS((e=>s.Yt(a.Kw)({rect:a.G(e),canvasRect:a.ij(this._gDocsDOM.getCanvasRect(this._layoutRoot,this._refactorGetCanvasRectEnabled))}))),a.UI((({rect:t,canvasRect:i})=>[d.Wm.create(d.UL.shift(d.UL.shift(d.Pf.create(t),h.E9.minus({left:0,top:0},i)),e.getPageRect()))])),a.wp((()=>a.ij(this._gDocsDOM.withVisibleRulers(((t,i)=>(0,n.zG)(s.Yt(a.Kw)({horizontalRuler:a.ij(i),verticalRuler:a.ij(t),lineHeight:(0,n.zG)(a.ij(this._gDocsDOM.getFontSizeInputEl()),a.UI((e=>parseInt(e.value,10))),a.hX((e=>!isNaN(e))),a.UI((e=>1.533*e)))}),a.tS((({horizontalRuler:e,verticalRuler:t,lineHeight:i})=>s.Yt(a.Kw)({firstLineIndent:(0,n.zG)(a.ij(this._gDocsDOM.getFirstLineIndentEl(e)),a.UI((e=>e.offsetLeft+e.offsetWidth/2))),topMargin:(0,n.zG)(a.ij(this._gDocsDOM.getRulerBackgroundsRects(t)),a.UI((({backgroundRect:e,innerBackgroundRect:t})=>t.top-e.top+i)))}))),a.UI((({firstLineIndent:t,topMargin:i})=>[d.Wm.create(d.UL.shift({left:t,top:i,height:0,width:0},e.getPageRect()))])),a.WG))))))))),a.fS((()=>[])))};const i=[];let r,o=e.start,l=!1;const c=t.getPlainText().length;do{const s=t.getFragmentAtOffset(o);if(s&&r!==o){r=o;const t=s.getFragmentInnerRect(o>s.startOffset?o-s.startOffset:0,e.end<s.endOffset?e.end-s.startOffset:void 0),n=s.getPage(),a=n.getPageRect(),l=d.Wm.create(d.UL.shift(b(t,n.getPageInnerSize(),a),a));i.push(l),o=s.endOffset}else this._returnAllRects?(o++,l=o>=c):l=!0}while(o<e.end&&!l);return{rects:i}}catch(e){throw this._telemetry.error("geometryProvider","exception in create method",e),e}}getClientRects(e){try{const t=this._layoutRoot.getClientRects().item(0);if(t){const i={top:this._layoutRoot.scrollTop,left:this._layoutRoot.scrollLeft};return(0,n.zG)(e.rects,c.es,c.yX,o.UI((e=>d.UL.setPosition(h.Ir.fromOffsetPoint(h.p8.create(e),h.Ir.create(t),i),e))))}return null}catch(e){return this._telemetry.error("geometryProvider","exception in getClientRects method",e),null}}getIsInvalid(e){return!1}getIsConsistent(e,t,i){return!0}dispose(e){}}function b(e,t,i){const s=i.width/t.width,n=i.height/t.height;return{left:e.left*s,top:e.top*n,width:e.width*s,height:e.height*n}}function f(e,t,i){const s=t.width/i.width,n=t.height/i.height;return(0,p.cl)({left:e.left*s,top:e.top*n,width:e.width*s,height:e.height*n})}},49650:(e,t,i)=>{i.d(t,{z:()=>m});var s=i(36072),n=i(25989),a=i(78488),r=i(60841),o=i(73863),l=i(55446),c=i(36880),d=i(34859),h=i(8748),u=i(14765),p=i(65647),g=i(10859);function m(e,t,i,m=3e3){const v=new s.xQ,_=new s.xQ;const b=v.pipe(r.w((t=>null==t?h.E:e.contentChanges.async.pipe(u.O(0),c.R(_.pipe(p.U((e=>e===t)))),c.R(i),d.h(t),c.R(g.timer(m).pipe(a.b((e=>{})))))))).subscribe((i=>{const s=e.getCurrentTextMap(),n=s.getNearestPageFragmentAtOrBeforeOffset(i);if(n){if(n.startOffset<=i&&n.endOffset>=i)return void _.next(i);if(n.endOffset<i){const e=n.getPageRect(),i=t.visibleRect.getApproximate(),s=t.rect.getApproximate().client.top+e.top+e.height-i.client.top-i.size.height;if(s>0)return void requestAnimationFrame((()=>{t.scroller.scrollBy({left:0,top:s})}))}}const a=s.getNearestPageFragmentAfterOffset(i);if(a&&a.startOffset>i){const e=a.getPageRect(),i=t.visibleRect.getApproximate(),s=t.rect.getApproximate().client.top+e.top-i.client.top;if(s<0)return void requestAnimationFrame((()=>{t.scroller.scrollBy({left:0,top:s})}))}}));return{scrollToRect:function(e,i){v.next(null);const s=t.visibleRect.getApproximate();i<=e.top&&e.bottom<=i+s.size.height||t.scroller.scrollBy({top:e.top-i-100})},scrollToRange:function(e){return n.D([0]).pipe(a.b((()=>v.next(e))),r.w((e=>_)),o.q(1),l.h((t=>t===e)),c.R(v.pipe(l.h((t=>t!==e)))),d.h(void 0))},dispose:function(){b.unsubscribe(),v.complete(),_.complete()}}}},25079:(e,t,i)=>{function s(e){return e}i.d(t,{cl:()=>s})},94996:(e,t,i)=>{i.d(t,{Sz:()=>a,vQ:()=>n});var s=i(12518);async function n(e,t=self){if(function(e=self){var t,i;return!!(null===(i=null===(t=e.navigator)||void 0===t?void 0:t.clipboard)||void 0===i?void 0:i.writeText)}(t))return t.navigator.clipboard.writeText(e);throw new Error("Clipboard API not supported")}function a(e,t=self){return n(e,t).then((()=>s.right(void 0))).catch((e=>s.left(e instanceof Error?e:new Error(String(e)))))}},37717:e=>{e.exports={spin:"qa6XN"}},94381:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},30409:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",translateIcon:"xpU4I",spin:"A8MjA"}},68550:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},93526:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);